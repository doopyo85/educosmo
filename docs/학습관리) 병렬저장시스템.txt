# ğŸ”„ ë³‘ë ¬ ì €ì¥ ëª¨ë¸(Parallel Storage Model) êµ¬í˜„ ëª…ì„¸ì„œ

**ì‘ì„±ì¼**: 2025ë…„ 12ì›” 27ì¼  
**í”„ë¡œì íŠ¸**: educodingnplay  
**ë²„ì „**: 1.0  
**ìƒíƒœ**: í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì • ëŒ€ê¸°

---

## ğŸ“‹ í”„ë¡œì íŠ¸ ê°œìš”

### ëª©ì 
Entryì™€ Scratch í”„ë¡œì íŠ¸ ì €ì¥ ì‹œ **UserFiles**(ìŠ¤í† ë¦¬ì§€ ìš©ëŸ‰ ê´€ë¦¬)ì™€ **ProjectSubmissions**(í•™ìŠµ ì§„ë„ ì¶”ì ) ë‘ í…Œì´ë¸”ì— **ë³‘ë ¬ ì €ì¥**í•˜ì—¬ ë°ì´í„° ì¼ê´€ì„± í™•ë³´

### ë¬¸ì œ ë°°ê²½
- **ê¸°ì¡´ ìƒí™©**: EntryëŠ” `ProjectSubmissions`ë§Œ, ScratchëŠ” `UserFiles`ë§Œ ì‚¬ìš©
- **ë¬¸ì œì **: í…Œì´ë¸” ê°„ ë°ì´í„° ë¶ˆì¼ì¹˜, ì‚­ì œ ì‹œ ì°¸ì¡° ë¬´ê²°ì„± ë¬¸ì œ
- **í•´ê²°ì±…**: ë³‘ë ¬ ëª¨ë¸(Parallel Model) - íŒŒì¼ ì €ì¥ ì‹œ ë‘ í…Œì´ë¸” ë™ì‹œ ê¸°ë¡

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

### ë°ì´í„° íë¦„
```
[í”„ë¡ íŠ¸ì—”ë“œ] â†’ [ë°±ì—”ë“œ API] â†’ [S3 ì—…ë¡œë“œ]
                    â†“
              [parallelSave.js]
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                      â–¼
   [UserFiles]          [ProjectSubmissions]
   (ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬)          (í•™ìŠµ ì¶”ì )
```

### ì €ì¥ ì •ì±…
| ì €ì¥ ìœ í˜• | UserFiles | ProjectSubmissions |
|-----------|-----------|---------------------|
| ìë™ì €ì¥ (draft) | âŒ | âœ… (ë®ì–´ì“°ê¸°) |
| ìˆ˜ë™ì €ì¥/ì œì¶œ (final) | âœ… | âœ… |
| ì‚­ì œ | âœ… (ë…¼ë¦¬ì‚­ì œ) | âœ… (ë…¼ë¦¬ì‚­ì œ) |

---

## ğŸ“ ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

### âœ… ë°±ì—”ë“œ (ì™„ë£Œ)

| íŒŒì¼ ê²½ë¡œ | ìƒíƒœ | ì„¤ëª… |
|-----------|------|------|
| `lib_storage/parallelSave.js` | âœ… ì‹ ê·œ | ë³‘ë ¬ ì €ì¥ í•µì‹¬ ëª¨ë“ˆ |
| `routes/entryRouter.js` | âœ… ìˆ˜ì • | Entry ì €ì¥/ì‚­ì œ API |
| `routes/scratchRouter.js` | âœ… ìˆ˜ì • | Scratch ì €ì¥/ì‚­ì œ API |

### ğŸ”² í”„ë¡ íŠ¸ì—”ë“œ (ëŒ€ê¸°)

| íŒŒì¼ ê²½ë¡œ | ìƒíƒœ | ì„¤ëª… |
|-----------|------|------|
| `scratch-gui/src/lib/save-project-to-server.js` | ğŸ”² ëŒ€ê¸° | Scratch ì €ì¥ ë¡œì§ |
| `scratch-gui/src/lib/project-saver-hoc.jsx` | ğŸ”² ëŒ€ê¸° | Scratch ì €ì¥ HOC |
| `entry/src/...` (íŒŒì¼ í™•ì¸ í•„ìš”) | ğŸ”² ëŒ€ê¸° | Entry ì €ì¥ ë¡œì§ |

### âœ… ë°ì´í„°ë² ì´ìŠ¤ (ê²€ì¦ ì™„ë£Œ)

| í…Œì´ë¸” | ìƒíƒœ | í•„ìš” ì»¬ëŸ¼ |
|--------|------|-----------|
| UserFiles | âœ… ì¡´ì¬ | is_deleted, deleted_at |
| ProjectSubmissions | âœ… ì¡´ì¬ | is_deleted, deleted_at, idx_not_deleted |

---

## ğŸ”§ í•µì‹¬ ëª¨ë“ˆ: parallelSave.js

### íŒŒì¼ ìœ„ì¹˜
```
C:\Users\User\Documents\pioneer\educodingnplay\lib_storage\parallelSave.js
```

### ì£¼ìš” í•¨ìˆ˜

```javascript
// ë³‘ë ¬ ì €ì¥ (ì‹ ê·œ ìƒì„±)
async function saveProjectParallel(params) {
  // params: userId, centerID, platform, projectName, s3Path, fileSize, fileType, s3Url, submissionType
  // returns: { projectSubmissionId, userFileId }
}

// ë³‘ë ¬ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ìˆ˜ì •)
async function updateProjectParallel(params) {
  // params: projectId, userId, userFileId, projectName, s3Path, fileSize, s3Url, submissionType
}

// ë³‘ë ¬ ì‚­ì œ (ë…¼ë¦¬ì‚­ì œ)
async function deleteProjectParallel(params) {
  // params: projectId, userFileId, userId
}

// í”„ë¡œì íŠ¸ ë¶„ì„ (ë¸”ë¡ ìˆ˜ ë“±)
function analyzeProject(projectData, platform) {
  // returns: { blocksCount, spritesCount, variablesCount, functionsCount }
}
```

---

## ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì • ê°€ì´ë“œ

### 1. Scratch GUI ìˆ˜ì •

#### íŒŒì¼ ìœ„ì¹˜ (ë¡œì»¬)
```
C:\Users\User\Documents\pioneer\scratch-gui\src\lib\
```

#### ìˆ˜ì • í¬ì¸íŠ¸ A: ì €ì¥ ì‘ë‹µ ì²˜ë¦¬
```javascript
// save-project-to-server.js ë˜ëŠ” project-saver-hoc.jsx
const response = await fetch('/scratch/api/save-project', {
    method: 'POST',
    body: formData
});
const result = await response.json();

if (result.success) {
    // âœ… ì¶”ê°€: userFileId ì €ì¥
    this.projectData.projectId = result.projectId;
    this.projectData.userFileId = result.userFileId;  // ìƒˆë¡œ ì¶”ê°€
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë„ ë°±ì—…
    localStorage.setItem('scratch_userFileId_' + result.projectId, result.userFileId);
}
```

#### ìˆ˜ì • í¬ì¸íŠ¸ B: ì—…ë°ì´íŠ¸ ìš”ì²­ ì‹œ userFileId í¬í•¨
```javascript
const formData = new FormData();
formData.append('projectData', projectBlob);
formData.append('projectName', projectName);
formData.append('isNew', 'false');
formData.append('projectId', this.projectData.projectId);
formData.append('userFileId', this.projectData.userFileId);  // âœ… ì¶”ê°€
```

#### ìˆ˜ì • í¬ì¸íŠ¸ C: ì‚­ì œ ìš”ì²­ ì‹œ userFileId ì „ë‹¬
```javascript
const projectId = this.projectData.projectId;
const userFileId = this.projectData.userFileId || 
                   localStorage.getItem('scratch_userFileId_' + projectId);

const url = `/scratch/api/project/${projectId}?userFileId=${userFileId}`;

const response = await fetch(url, {
    method: 'DELETE'
});
```

---

### 2. Entry ìˆ˜ì •

#### íŒŒì¼ ìœ„ì¹˜ (ë¡œì»¬)
```
C:\Users\User\Documents\pioneer\educodingnplay\entry\
```

#### ìˆ˜ì • í¬ì¸íŠ¸ A: ì €ì¥ ì‘ë‹µ ì²˜ë¦¬
```javascript
const response = await fetch('/entry/api/projects', {
    method: 'POST',
    body: formData
});
const result = await response.json();

if (result.success) {
    // âœ… ì¶”ê°€: userFileId ì €ì¥
    Entry.projectId = result.projectId;
    Entry.userFileId = result.userFileId;
    
    if (Entry.projectData) {
        Entry.projectData.userFileId = result.userFileId;
    }
}
```

#### ìˆ˜ì • í¬ì¸íŠ¸ B: ì—…ë°ì´íŠ¸ ìš”ì²­ ì‹œ
```javascript
const requestBody = {
    projectName: projectName,
    projectData: projectData,
    thumbnail: thumbnailData,
    userFileId: Entry.userFileId  // âœ… ì¶”ê°€
};
```

#### ìˆ˜ì • í¬ì¸íŠ¸ C: ì‚­ì œ ìš”ì²­ ì‹œ
```javascript
const projectId = Entry.projectId;
const userFileId = Entry.userFileId;

const url = `/entry/api/projects/${projectId}?userFileId=${userFileId}`;

const response = await fetch(url, {
    method: 'DELETE'
});
```

---

## ğŸ“Š ë°±ì—”ë“œ API ì‘ë‹µ í˜•ì‹

### ì €ì¥ API ì‘ë‹µ (ì´ë¯¸ êµ¬í˜„ë¨)
```json
{
    "success": true,
    "projectId": 123,
    "userFileId": 456,
    "s3Url": "https://...",
    "message": "í”„ë¡œì íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
}
```

### ì‚­ì œ API ìš”ì²­
```
DELETE /scratch/api/project/{projectId}?userFileId={userFileId}
DELETE /entry/api/projects/{projectId}?userFileId={userFileId}
```

---

## ğŸš€ ë°°í¬ ì ˆì°¨

### 1ë‹¨ê³„: ë°±ì—”ë“œ ë°°í¬ (ì™„ë£Œ)
```bash
# ë¡œì»¬ì—ì„œ
cd C:\Users\User\Documents\pioneer\educodingnplay
git add .
git commit -m "feat: ë³‘ë ¬ ì €ì¥ ëª¨ë¸ ë°±ì—”ë“œ êµ¬í˜„"
git push origin main

# ì„œë²„ì—ì„œ
cd /var/www/html/educodingnplay
sudo git pull origin main
pm2 restart all
```

### 2ë‹¨ê³„: Scratch GUI ë°°í¬ (ëŒ€ê¸°)
```bash
# ë¡œì»¬ì—ì„œ
cd C:\Users\User\Documents\pioneer\scratch-gui
# í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì • í›„
npm run build
git add .
git commit -m "feat: userFileId ì €ì¥/ì—…ë°ì´íŠ¸/ì‚­ì œ ì—°ë™"
git push origin main

# ì„œë²„ì—ì„œ
cd /var/www/html/scratch-gui
sudo git pull origin main
npm run build  # ë˜ëŠ” pm2 restart scratch-gui
```

### 3ë‹¨ê³„: Entry ë°°í¬ (ëŒ€ê¸°)
```bash
# ë¡œì»¬ì—ì„œ
cd C:\Users\User\Documents\pioneer\educodingnplay\entry
# í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì • í›„
git add .
git commit -m "feat: userFileId ì €ì¥/ì—…ë°ì´íŠ¸/ì‚­ì œ ì—°ë™"
git push origin main

# ì„œë²„ì—ì„œ
cd /var/www/html/educodingnplay/entry
sudo git pull origin main
pm2 restart entry-server  # í•„ìš”ì‹œ
```

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°±ì—”ë“œ
- [x] parallelSave.js ëª¨ë“ˆ ìƒì„±
- [x] entryRouter.js ë³‘ë ¬ ëª¨ë¸ ì ìš©
- [x] scratchRouter.js ë³‘ë ¬ ëª¨ë¸ ì ìš©
- [x] DB í…Œì´ë¸” êµ¬ì¡° í™•ì¸ (is_deleted, deleted_at)
- [ ] ì¸ë±ìŠ¤ ì¶”ê°€ (ê¶Œì¥): `idx_userfiles_not_deleted`

### í”„ë¡ íŠ¸ì—”ë“œ
- [ ] Scratch GUI: ì €ì¥ ì‘ë‹µì—ì„œ userFileId ì €ì¥
- [ ] Scratch GUI: ì—…ë°ì´íŠ¸ ì‹œ userFileId ì „ì†¡
- [ ] Scratch GUI: ì‚­ì œ ì‹œ userFileId ì „ì†¡
- [ ] Entry: ì €ì¥ ì‘ë‹µì—ì„œ userFileId ì €ì¥
- [ ] Entry: ì—…ë°ì´íŠ¸ ì‹œ userFileId ì „ì†¡
- [ ] Entry: ì‚­ì œ ì‹œ userFileId ì „ì†¡

### ë°°í¬
- [ ] ë°±ì—”ë“œ Git ì»¤ë°‹ ë° í‘¸ì‹œ
- [ ] ì„œë²„ì—ì„œ ë°±ì—”ë“œ pull ë° ì¬ì‹œì‘
- [ ] Scratch GUI ë¹Œë“œ ë° ë°°í¬
- [ ] Entry ë°°í¬
- [ ] í†µí•© í…ŒìŠ¤íŠ¸

---

## ğŸ” ë‹¤ìŒ ì‘ì—… ì‹œì‘ì 

### ì¦‰ì‹œ í•„ìš”í•œ ì‘ì—…
1. **Scratch GUI ì†ŒìŠ¤ íŒŒì¼ í™•ì¸**
   - `C:\Users\User\Documents\pioneer\scratch-gui\src\lib\save-project-to-server.js` ë¶„ì„
   - `project-saver-hoc.jsx` ë¶„ì„
   
2. **Entry ì†ŒìŠ¤ íŒŒì¼ í™•ì¸**
   - `C:\Users\User\Documents\pioneer\educodingnplay\entry\` ë‚´ ì €ì¥ ê´€ë ¨ íŒŒì¼ ë¶„ì„

3. **í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì • ì ìš©**
   - userFileId ì €ì¥/ì—…ë°ì´íŠ¸/ì‚­ì œ ë¡œì§ ì¶”ê°€

### ê¶Œì¥ ì¸ë±ìŠ¤ (ì„ íƒ)
```sql
CREATE INDEX idx_userfiles_not_deleted 
ON UserFiles(user_id, file_category, is_deleted);
```

---

## ğŸ“š ì°¸ì¡° ë¬¸ì„œ

- `/mnt/project/S3_ìŠ¤í† ë¦¬ì§€_API_ëª…ì„¸ì„œ.txt`
- `/mnt/project/DB_í…Œì´ë¸”ëª…ì„¸ì„œ.txt`
- `/mnt/project/__educodingnplay_í”„ë¡œì íŠ¸ì „ì²´êµ¬ì¡°ëª…ì„¸ì„œ.txt`

---

## ğŸ—‚ï¸ ê´€ë ¨ íŠ¸ëœìŠ¤í¬ë¦½íŠ¸

| íŒŒì¼ëª… | ë‚´ìš© |
|--------|------|
| `2025-12-26-17-08-50-parallel-model-code-implementation.txt` | ì½”ë“œ êµ¬í˜„ ìƒì„¸ |
| `2025-12-26-17-20-22-parallel-storage-deployment-complete.txt` | Entry ë°±ì—”ë“œ ì™„ë£Œ |
| `2025-12-26-17-25-38-scratch-parallel-model-deployment.txt` | Scratch ë°±ì—”ë“œ ì™„ë£Œ |
| `2025-12-26-17-52-40-parallel-model-db-migration-frontend-guide.txt` | DB í™•ì¸ ë° í”„ë¡ íŠ¸ì—”ë“œ ê°€ì´ë“œ |
| `2025-12-26-18-01-53-scratch-gui-directory-structure.txt` | Scratch GUI êµ¬ì¡° íƒìƒ‰ |

---

**ì‘ì„±ì**: Claude AI Assistant  
**ìµœì¢… ìˆ˜ì •**: 2025ë…„ 12ì›” 27ì¼