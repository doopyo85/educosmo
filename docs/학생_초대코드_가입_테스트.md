# 학생 초대 코드 가입 테스트 가이드

**작성일**: 2026-01-22
**구현 완료**: Phase 1 - 학생 초대 코드 가입

---

## ✅ 구현 완료 사항

### 1. GET /auth/register - 학생 초대 코드 가입 페이지
- **파일**: `lib_login/auth.js:271-475`
- **변경사항**:
  - 기존: 역할 선택 (학생/강사/센터장/유치원/학교) + 센터 선택
  - 신규: 초대 코드 입력 → 센터 자동 매칭 → 회원정보 입력
- **UI 구조**:
  - Step 1: 초대 코드 입력 (8자리)
  - Step 2: 회원정보 입력 (코드 확인 후 표시)

### 2. POST /auth/api/verify-invite-code - 초대 코드 검증 API
- **파일**: `lib_login/auth.js:528-587`
- **기능**:
  - 초대 코드 유효성 확인
  - 센터 상태 확인 (ACTIVE)
  - 만료 일자 확인
  - 사용 횟수 확인 (max_uses)
- **응답**:
  ```json
  {
    "success": true,
    "centerID": 1,
    "centerName": "코딩앤플레이 본점"
  }
  ```

### 3. POST /auth/register - 초대 코드 기반 회원가입
- **파일**: `lib_login/auth.js:479-586`
- **변경사항**:
  - account_type='center_student' 고정
  - role='student' 고정
  - inviteCode로 centerID 자동 매칭
  - 초대 코드 사용 횟수 자동 증가

### 4. 로그인 페이지 링크 수정
- **파일**: `lib_login/auth.js:77-82`
- **변경사항**:
  - "회원가입" → "학생 가입"
  - "센터 개설하기" 링크 추가

---

## 🧪 테스트 시나리오

### 사전 준비: 테스트 초대 코드 생성

데이터베이스에 테스트 초대 코드를 먼저 생성해야 합니다.

```sql
-- MySQL 접속
USE educosmo;

-- 1. 센터 확인 (또는 생성)
SELECT id, center_name, status FROM Centers WHERE status = 'ACTIVE' LIMIT 1;

-- 센터가 없다면 테스트 센터 생성
INSERT INTO Centers (center_name, contact_name, contact_phone, contact_email, status, plan_type)
VALUES ('테스트센터', '테스트', '01012345678', 'test@test.com', 'ACTIVE', 'trial');

-- 2. 초대 코드 생성 (예: centerID=1인 경우)
INSERT INTO center_invite_codes (centerID, code, max_uses, expires_at, is_active)
VALUES (1, 'TEST1234', 100, DATE_ADD(NOW(), INTERVAL 30 DAY), 1);

-- 3. 생성된 초대 코드 확인
SELECT * FROM center_invite_codes WHERE code = 'TEST1234';
```

**초대 코드 형식**:
- 8자리 영문 대문자 + 숫자
- 예: `TEST1234`, `ABCD5678`, `HELLO123`

---

### 테스트 케이스 1: 정상 가입

**접속 URL**: https://app.codingnplay.co.kr/auth/register

**Step 1: 초대 코드 입력**
1. 초대 코드 입력란에 `TEST1234` 입력
2. "코드 확인" 버튼 클릭
3. 예상 결과:
   - Step 2가 표시됨
   - 센터명이 "테스트센터"로 표시됨

**Step 2: 회원정보 입력**
1. 아이디: `teststudent01`
2. 비밀번호: `testpass123`
3. 이메일: `student01@test.com`
4. 이름: `테스트학생`
5. 개인정보 처리방침 동의 체크
6. "가입하기" 버튼 클릭
7. 예상 결과:
   - "회원가입이 완료되었습니다. 로그인해주세요." 알림
   - 로그인 페이지로 리다이렉트

**Step 3: 가입 확인**
```sql
-- 사용자 확인
SELECT id, userID, name, role, centerID, account_type, created_at
FROM Users
WHERE userID = 'teststudent01';

-- 예상 결과:
-- account_type='center_student'
-- role='student'
-- centerID=1 (테스트센터)

-- 초대 코드 사용 횟수 확인
SELECT code, used_count, max_uses FROM center_invite_codes WHERE code = 'TEST1234';

-- 예상 결과:
-- used_count가 1 증가
```

**Step 4: 로그인 테스트**
1. https://app.codingnplay.co.kr/auth/login 접속
2. 아이디: `teststudent01`, 비밀번호: `testpass123`
3. 로그인 성공 확인

---

### 테스트 케이스 2: 잘못된 초대 코드

**Step 1: 잘못된 초대 코드 입력**
1. 초대 코드: `INVALID1` (7자리)
2. "코드 확인" 클릭
3. 예상 결과: "초대 코드는 8자리여야 합니다." 알림

**Step 2: 존재하지 않는 초대 코드**
1. 초대 코드: `NOTEXIST` (8자리)
2. "코드 확인" 클릭
3. 예상 결과: "존재하지 않거나 비활성화된 초대 코드입니다." 알림

---

### 테스트 케이스 3: 만료된 초대 코드

```sql
-- 만료된 초대 코드 생성
INSERT INTO center_invite_codes (centerID, code, max_uses, expires_at, is_active)
VALUES (1, 'EXPIRED1', 100, DATE_SUB(NOW(), INTERVAL 1 DAY), 1);
```

**테스트**:
1. 초대 코드: `EXPIRED1`
2. "코드 확인" 클릭
3. 예상 결과: "만료된 초대 코드입니다." 알림

---

### 테스트 케이스 4: 사용 횟수 초과

```sql
-- 사용 횟수 제한 초대 코드 생성
INSERT INTO center_invite_codes (centerID, code, max_uses, used_count, expires_at, is_active)
VALUES (1, 'FULL1234', 5, 5, DATE_ADD(NOW(), INTERVAL 30 DAY), 1);
```

**테스트**:
1. 초대 코드: `FULL1234`
2. "코드 확인" 클릭
3. 예상 결과: "사용 가능 횟수를 초과한 초대 코드입니다." 알림

---

### 테스트 케이스 5: 비활성화된 센터

```sql
-- 센터 상태를 SUSPENDED로 변경
UPDATE Centers SET status = 'SUSPENDED' WHERE id = 1;
```

**테스트**:
1. 초대 코드: `TEST1234` (centerID=1)
2. "코드 확인" 클릭
3. 예상 결과: "현재 이용이 중지된 센터입니다." 알림

```sql
-- 테스트 후 복구
UPDATE Centers SET status = 'ACTIVE' WHERE id = 1;
```

---

### 테스트 케이스 6: 중복 아이디

**Step 1**: 정상 가입 (teststudent01)
**Step 2**: 동일 아이디로 재가입 시도
1. 초대 코드: `TEST1234`
2. 회원정보 입력:
   - 아이디: `teststudent01` (중복)
   - 비밀번호: `different123`
   - 이메일: `different@test.com`
   - 이름: `다른학생`
3. "가입하기" 클릭
4. 예상 결과: "이미 사용 중인 아이디입니다." 알림

---

### 테스트 케이스 7: 중복 이메일

**Step 1**: 정상 가입 (student01@test.com)
**Step 2**: 동일 이메일로 재가입 시도
1. 초대 코드: `TEST1234`
2. 회원정보 입력:
   - 아이디: `teststudent02`
   - 비밀번호: `testpass123`
   - 이메일: `student01@test.com` (중복)
   - 이름: `테스트학생2`
3. "가입하기" 클릭
4. 예상 결과: "이미 사용 중인 이메일입니다." 알림

---

## 🔍 검증 포인트

### 1. 데이터베이스 검증

가입 후 확인해야 할 사항:

```sql
-- 1. 사용자 테이블
SELECT id, userID, name, email, role, centerID, account_type, created_at
FROM Users
WHERE userID = 'teststudent01';

-- 확인 항목:
-- ✅ account_type = 'center_student'
-- ✅ role = 'student'
-- ✅ centerID = 1 (테스트센터)
-- ✅ password는 bcrypt 해시값

-- 2. 초대 코드 사용 횟수
SELECT code, used_count, max_uses, created_by, created_at
FROM center_invite_codes
WHERE code = 'TEST1234';

-- 확인 항목:
-- ✅ used_count가 가입 전보다 1 증가

-- 3. 센터 정보
SELECT id, center_name, status FROM Centers WHERE id = 1;

-- 확인 항목:
-- ✅ status = 'ACTIVE'
```

### 2. 권한 검증

로그인 후 확인:

1. **접근 가능**:
   - Portal (학습 자료)
   - Entry/Scratch/Python IDE
   - CT 문제 은행
   - 센터 클라우드보드
   - 커뮤니티 (아지트, 광장, 갤러리)

2. **접근 불가**:
   - Teacher Dashboard (center_admin 전용)
   - 초대 코드 생성
   - 센터 관리 기능

### 3. UI 검증

1. **로그인 페이지**:
   - "학생 가입" 링크 표시
   - "센터 개설하기" 링크 표시

2. **가입 페이지**:
   - Step 1: 초대 코드 입력란 (8자리 제한)
   - Step 2: 회원정보 입력란 (초기 숨김)
   - 센터명 표시 (코드 확인 후)
   - 개인정보 처리방침 모달

---

## 🐛 알려진 이슈 및 주의사항

### 이슈 1: 초대 코드 대소문자 구분
- **현상**: 초대 코드는 대소문자를 구분합니다
- **예**: `test1234` ≠ `TEST1234`
- **해결**: 프론트엔드에서 자동으로 대문자 변환 또는 DB에서 COLLATE 설정

### 이슈 2: 8자리 제한 검증
- **현상**: 8자리보다 짧거나 긴 코드는 프론트엔드에서 차단
- **주의**: `maxlength="8"` 속성으로 입력 제한됨

### 이슈 3: 비밀번호 최소 길이
- **현상**: 8자 미만 비밀번호는 백엔드에서 거부
- **메시지**: "비밀번호는 8자 이상이어야 합니다."

---

## 📝 다음 단계 (Phase 2)

Phase 1 완료 후 다음 단계:

1. **센터 구독 관리 UI**
   - `/subscription/plans` - 플랜 선택 페이지
   - `/subscription/checkout` - 결제 페이지

2. **Toss Payments 통합**
   - 결제 모듈 연동
   - 웹훅 처리

3. **Trial 만료 처리**
   - Cron job 구현
   - 만료 7일 전 알림 이메일

4. **Admin Dashboard**
   - 센터 관리자 대시보드
   - 구독 상태 확인
   - 플랜 변경/취소

---

## 📞 문의

**구현자**: Claude Sonnet 4.5
**구현일**: 2026-01-22
**버전**: Phase 1 완료

**관련 문서**:
- `docs/# 센터개설 및 결제모듈 구현계획.txt`
- `docs/센터가입_및_인증시스템_구현완료.md`
