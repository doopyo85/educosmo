# 센터 가입 및 인증 시스템 구현 완료

**작성일**: 2026-01-08
**버전**: 1.0

---

## 📋 구현 완료 항목

### ✅ 1. JWT 만료 시간 변경
- **파일**: `config.js:38`
- **변경사항**: 1시간 → 3시간
- **영향**: 모든 JWT 토큰의 유효 기간이 3시간으로 연장됨

### ✅ 2. 이메일 서비스 (AWS SES)
- **파일**: `lib_auth/emailService.js`
- **기능**:
  - 인증 코드 이메일 발송
  - 비밀번호 재설정 이메일
  - 센터 가입 환영 이메일
- **템플릿**: HTML 이메일 디자인 포함

### ✅ 3. SMS 서비스 (NCP)
- **파일**: `lib_auth/smsService.js`
- **기능**:
  - NCP API 연동 준비 완료
  - 인증 코드 SMS 발송
  - 전화번호 형식 검증
  - 개발 모드 시뮬레이션 지원

### ✅ 4. 인증 서비스
- **파일**: `lib_auth/verificationService.js`
- **기능**:
  - 6자리 인증 코드 생성
  - 이메일/SMS 인증 코드 발송
  - 인증 코드 검증
  - 인증 완료 여부 확인
  - 만료 코드 자동 정리

### ✅ 5. 데이터베이스 테이블
- **파일**: `migrations/create_verification_tables.sql`
- **테이블**:
  - `VerificationCodes`: 인증 코드 저장
  - `Centers`: 센터 정보 (신규)
  - `CenterInviteCodes`: 초대 코드 (향후 확장용)
  - `TempCenterRegistrations`: 임시 가입 데이터

### ✅ 6. 센터 가입 페이지
- **파일**:
  - `views/auth/register-center.ejs`
  - `public/js/auth/register-center.js`
- **기능**:
  - 3단계 가입 프로세스
  - 아이디 중복 확인
  - 휴대폰 인증
  - 실시간 유효성 검사
  - 반응형 디자인

### ✅ 7. 센터 가입 API
- **파일**: `lib_login/auth.js` (450-597줄)
- **엔드포인트**:
  - `GET /auth/register-center`: 센터 가입 페이지
  - `POST /auth/api/check-userid`: 아이디 중복 확인
  - `POST /auth/api/send-sms-verification`: SMS 인증 코드 발송
  - `POST /auth/api/send-email-verification`: 이메일 인증 코드 발송
  - `POST /auth/api/verify-code`: 인증 코드 확인
  - `POST /auth/register-center`: 센터 가입 처리

---

## 🚀 설치 및 설정 가이드

### 1. npm 패키지 설치

```bash
cd C:\Users\User\Documents\pioneer\educodingnplay

# AWS SDK 설치
npm install @aws-sdk/client-ses

# NCP 연동용 (이미 설치되어 있을 가능성 높음)
npm install axios crypto-js
```

### 2. 데이터베이스 마이그레이션 실행

SSH로 서버 접속 후:

```bash
# MySQL 접속
mysql -u root -p

# 데이터베이스 선택
USE educodingnplay;

# 마이그레이션 실행
source /path/to/migrations/create_verification_tables.sql;

# 확인
SHOW TABLES;
DESC VerificationCodes;
DESC Centers;
```

**또는 수동으로 SQL 실행**:
- 파일 위치: `educodingnplay/migrations/create_verification_tables.sql`
- 내용을 복사하여 MySQL 클라이언트에서 직접 실행

### 3. 환경 변수 설정 (.env 파일)

`.env` 파일에 다음 변수 추가:

```bash
# ========================================
# AWS SES 설정 (이메일 발송)
# ========================================
AWS_ACCESS_KEY_ID=your_aws_access_key_id
AWS_SECRET_ACCESS_KEY=your_aws_secret_access_key
AWS_REGION=ap-northeast-2
SES_FROM_EMAIL=noreply@codingnplay.co.kr

# ========================================
# NCP SMS 설정 (문자 발송)
# ========================================
NCP_SERVICE_ID=ncp_service_id
NCP_ACCESS_KEY=ncp_access_key
NCP_SECRET_KEY=ncp_secret_key
NCP_SENDER_PHONE=01012345678

# ========================================
# 기존 설정 (확인)
# ========================================
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=3h
NODE_ENV=development  # 또는 production
```

### 4. AWS SES 설정

1. **AWS 콘솔 접속**: https://console.aws.amazon.com/ses/
2. **이메일 인증**:
   - SES → Verified identities
   - "Create identity" 클릭
   - Email address: `noreply@codingnplay.co.kr`
   - 확인 이메일 수신 후 링크 클릭
3. **샌드박스 해제** (선택):
   - Production 환경에서는 샌드박스 해제 필요
   - Request production access 신청

### 5. NCP SMS 설정

1. **NCP 콘솔 접속**: https://console.ncloud.com/
2. **Simple & Easy Notification Service (SENS) 이동**
3. **프로젝트 생성**:
   - SMS → Projects
   - 프로젝트 이름 입력
   - Service ID 복사 (`NCP_SERVICE_ID`)
4. **API 키 생성**:
   - 마이 페이지 → 인증키 관리
   - Access Key ID 생성 (`NCP_ACCESS_KEY`)
   - Secret Key 저장 (`NCP_SECRET_KEY`)
5. **발신번호 등록**:
   - SMS → Calling Number
   - "발신번호 등록" 클릭
   - 휴대폰 번호 입력 및 본인 인증
   - 승인 완료 (즉시)

---

## 🔧 개발 모드 vs 프로덕션 모드

### 개발 모드 (`NODE_ENV=development`)
- SMS/이메일 전송 실패 시에도 성공으로 처리
- 인증 코드를 콘솔에 출력
- API 응답에 인증 코드 포함 (디버깅용)

### 프로덕션 모드 (`NODE_ENV=production`)
- 실제 SMS/이메일 발송
- 인증 코드 노출 안 함
- 엄격한 에러 처리

---

## 📁 파일 구조

```
educodingnplay/
├── lib_auth/                        # 인증 관련 모듈 (신규)
│   ├── emailService.js             # AWS SES 이메일 발송
│   ├── smsService.js               # NCP SMS 발송
│   └── verificationService.js      # 인증 코드 관리
│
├── lib_login/
│   └── auth.js                     # 로그인/가입 라우트 (업데이트)
│
├── views/
│   └── auth/
│       └── register-center.ejs    # 센터 가입 페이지 (신규)
│
├── public/
│   └── js/
│       └── auth/
│           └── register-center.js  # 센터 가입 클라이언트 로직 (신규)
│
├── migrations/
│   └── create_verification_tables.sql  # DB 마이그레이션 (신규)
│
├── config.js                       # JWT 만료 시간 변경
└── .env                            # 환경 변수 (업데이트 필요)
```

---

## 🎯 센터 가입 프로세스

### Step 1: 기본 정보 입력
1. 아이디 (중복 확인 필수)
2. 비밀번호 (8자 이상)
3. 비밀번호 확인
4. 이름
5. 이메일
6. 센터명
7. 역할 (센터장/강사/유치원/학교)

### Step 2: 본인 인증
1. 휴대폰 번호 입력
2. 인증번호 전송 (SMS)
3. 인증번호 입력 및 확인
4. 인증 완료

### Step 3: 가입 완료
- 새 센터 생성 (Centers 테이블)
- 사용자 계정 생성 (Users 테이블)
- 스토리지 할당 (CenterStorageUsage)
- 환영 이메일 발송

---

## 🧪 테스트 방법

### 1. 센터 가입 페이지 접속
```
https://app.codingnplay.co.kr/auth/register-center
```

### 2. 개발 모드 테스트

**환경 변수 설정**:
```bash
NODE_ENV=development
```

**테스트 시나리오**:
1. 센터 가입 페이지 접속
2. 기본 정보 입력
3. "다음 단계" 클릭
4. 휴대폰 번호 입력
5. "인증번호 전송" 클릭
6. **콘솔에서 인증 코드 확인** (`📱 SMS 인증 코드 (...)`)
7. 인증 코드 입력 및 확인
8. "가입 완료" 클릭
9. 가입 성공 확인

### 3. 프로덕션 테스트

**환경 변수 설정**:
```bash
NODE_ENV=production
```

실제 SMS 발송 및 이메일 발송 테스트

---

## 🔐 보안 고려사항

### 1. 인증 코드
- **유효 기간**: 10분
- **자동 만료**: 시간 초과 시 재발송 필요
- **일회성**: 한 번 사용하면 무효화

### 2. 비밀번호
- **암호화**: bcrypt (salt rounds: 10)
- **최소 길이**: 8자
- **저장**: 해시된 형태로만 저장

### 3. API 보안
- **CORS**: 허용된 도메인만 접근
- **Rate Limiting**: 추후 추가 권장
- **SQL Injection**: Prepared statements 사용

### 4. 개인정보
- **전화번호**: 하이픈 제거 후 정규화
- **이메일**: 중복 확인 필수
- **센터 정보**: GDPR 준수

---

## 📊 데이터베이스 스키마

### VerificationCodes 테이블
```sql
CREATE TABLE VerificationCodes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    contact VARCHAR(255) NOT NULL,           -- 이메일 또는 전화번호
    contact_type ENUM('email', 'phone'),     -- 연락처 타입
    code VARCHAR(10) NOT NULL,                -- 인증 코드
    purpose ENUM('register', 'reset_password', 'phone_verify'),
    verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL,
    verified_at TIMESTAMP NULL,

    INDEX idx_contact (contact),
    INDEX idx_expires (expires_at)
);
```

### Centers 테이블 (신규)
```sql
CREATE TABLE Centers (
    id INT AUTO_INCREMENT PRIMARY KEY,
    center_name VARCHAR(255) NOT NULL,
    contact_name VARCHAR(100),
    contact_phone VARCHAR(20),
    contact_email VARCHAR(255),
    address TEXT,
    status ENUM('ACTIVE', 'INACTIVE', 'SUSPENDED') DEFAULT 'ACTIVE',
    plan_type VARCHAR(50) DEFAULT 'free',
    storage_limit_bytes BIGINT DEFAULT 10737418240,  -- 10GB
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

---

## 🐛 문제 해결 (Troubleshooting)

### 문제 1: 이메일이 발송되지 않음

**원인**:
- AWS SES 샌드박스 모드
- 이메일 주소 미인증
- AWS 자격 증명 오류

**해결**:
```bash
# .env 확인
AWS_ACCESS_KEY_ID=...
AWS_SECRET_ACCESS_KEY=...
SES_FROM_EMAIL=noreply@codingnplay.co.kr  # SES에서 인증된 이메일

# 로그 확인
tail -f logs/application.log | grep "Email"
```

### 문제 2: SMS가 발송되지 않음

**원인**:
- NCP API 키 오류
- 발신번호 미등록
- 잔액 부족

**해결**:
```bash
# .env 확인
NCP_SERVICE_ID=...
NCP_ACCESS_KEY=...
NCP_SECRET_KEY=...
NCP_SENDER_PHONE=01012345678  # 하이픈 없이

# NCP 콘솔에서 확인:
# 1. 발신번호 등록 상태
# 2. API 키 유효성
# 3. 잔액 확인
```

### 문제 3: DB 테이블이 없음

**증상**:
```
Error: Table 'educodingnplay.VerificationCodes' doesn't exist
```

**해결**:
```sql
-- MySQL 접속
USE educodingnplay;

-- 마이그레이션 재실행
source /path/to/migrations/create_verification_tables.sql;

-- 확인
SHOW TABLES LIKE 'Verification%';
```

### 문제 4: 센터 가입 페이지 404 오류

**원인**: views/auth 폴더가 없거나 EJS 렌더링 설정 누락

**해결**:
```bash
# 폴더 확인
ls views/auth/register-center.ejs

# server.js 확인
# view engine이 'ejs'로 설정되어 있는지 확인
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));
```

---

## 🔄 향후 개선 사항

### 1. 일반 회원가입 페이지 수정
- [ ] 센터 선택 필수
- [ ] 기본값 '코딩앤플레이' (centerID: 0)
- [ ] 역할을 'student'로 제한

### 2. 비밀번호 찾기 기능
- [ ] 이메일 인증으로 비밀번호 재설정
- [ ] `/auth/forgot-password` 라우트 추가
- [ ] 임시 비밀번호 발급 또는 재설정 링크

### 3. 로그인 페이지 수정
- [ ] "회원가입" 링크는 일반 회원가입(`/auth/register`)만
- [ ] 센터 가입 링크는 메인 페이지에서 제거

### 4. 보안 강화
- [ ] Rate Limiting (express-rate-limit)
- [ ] CAPTCHA 추가 (reCAPTCHA)
- [ ] 2FA (Two-Factor Authentication)

### 5. 사용자 경험 개선
- [ ] 가입 진행률 표시
- [ ] 에러 메시지 다국어 지원
- [ ] 모바일 최적화

---

## 📞 문의 및 지원

**개발팀 연락처**:
- 이메일: codmoedu@cosmoedu.co.kr
- 전화: 070-4337-4337

**문서 버전**: 1.0
**최종 업데이트**: 2026-01-08
