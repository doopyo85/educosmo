<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>EntryJS Base - Custom</title>

    <!-- âœ… ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="./css/styles.css" />
    <link href="./node_modules/@entrylabs/entry/dist/entry.css" rel="stylesheet" />
    <link href="./lib/modal/dist/entry/entry-modal.css" rel="stylesheet" />
    <link href="./node_modules/@entrylabs/tool/dist/entry-tool.css" rel="stylesheet" />
    <link href="https://entry-cdn.pstatic.net/lib/entry-lms/dist/assets/app.css" rel="stylesheet" />

    <!-- âœ… í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://entry-cdn.pstatic.net/lib/lodash/dist/lodash.min.js"></script>
    <script src="https://entry-cdn.pstatic.net/js/react18/react.production.min.js"></script>
    <script src="https://entry-cdn.pstatic.net/js/react18/react-dom.production.min.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/PreloadJS/lib/preloadjs-0.6.0.min.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/EaselJS/lib/easeljs-0.8.0.min.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/SoundJS/lib/soundjs-0.6.0.min.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/SoundJS/lib/flashaudioplugin-0.6.0.min.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/jquery/jquery.min.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/jquery-ui/ui/minified/jquery-ui.min.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/velocity/velocity.min.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/codemirror/lib/codemirror.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/codemirror/addon/hint/show-hint.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/codemirror/addon/lint/lint.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/codemirror/addon/selection/active-line.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/codemirror/mode/javascript/javascript.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/codemirror/addon/hint/javascript-hint.js"></script>
    <script src="https://entry-cdn.pstatic.net/js/ws/jshint.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/fuzzy/lib/fuzzy.js"></script>
    <script src="https://entry-cdn.pstatic.net/js/ws/python.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/socket.io-client/socket.io.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/components-webfontloader/webfontloader.js"></script>
    <script src="https://entry-cdn.pstatic.net/lib/entry-lms/dist/assets/app.js"></script>
</head>

<body>
    <!-- âœ… UI ì»¨í…Œì´ë„ˆ -->
    <!--
    <div class="header">
        <button onclick="javascript:setBlockMode()">block mode</button>
        <button onclick="javascript:setPythonMode()">python mode</button>
    </div>
    -->
    
    <!-- ğŸ”¥ Entry ê³µì‹ ìŠ¤íƒ€ì¼ í—¤ë” (íŒŒë€ìƒ‰ ë°°ê²½) -->
    <div class="entry-header" style="
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        height: 56px; 
        background: #4f80ff; 
        padding: 0 24px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    ">
        <!-- ì™¼ìª½: Entry ë¡œê³  + ì‚¬ìš©ì ì •ë³´ -->
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="
                font-size: 20px; 
                font-weight: 700; 
                color: white;
                letter-spacing: 0.5px;
            ">Entry</div>
            
            <span id="headerUserID" style="
                font-size: 14px; 
                color: rgba(255,255,255,0.9);
                padding: 5px 12px;
                background: rgba(255,255,255,0.15);
                border-radius: 4px;
                font-weight: 500;
            ">ê²ŒìŠ¤íŠ¸</span>
        </div>
        
        <!-- ì˜¤ë¥¸ìª½: ë²„íŠ¼ë“¤ -->
        <div style="display: flex; gap: 10px;">
            <!-- ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ -->
            <button id="loadProjectBtn" style="
                padding: 8px 18px; 
                background: rgba(255,255,255,0.2);
                color: white; 
                border: 1px solid rgba(255,255,255,0.3);
                border-radius: 4px; 
                cursor: pointer; 
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s;
            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°
            </button>
            
            <!-- ì €ì¥í•˜ê¸° ë²„íŠ¼ -->
            <button id="saveProjectBtn" style="
                padding: 8px 18px; 
                background: rgba(255,255,255,0.2);
                color: white; 
                border: 1px solid rgba(255,255,255,0.3);
                border-radius: 4px; 
                cursor: pointer; 
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s;
            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                ğŸ’¾ ì €ì¥í•˜ê¸°
            </button>
            
            <!-- ğŸ”¥ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ì‹ ê·œ) -->
            <button id="downloadProjectBtn" style="
                padding: 8px 18px; 
                background: rgba(255,255,255,0.2);
                color: white; 
                border: 1px solid rgba(255,255,255,0.3);
                border-radius: 4px; 
                cursor: pointer; 
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s;
            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                â¬‡ï¸ ë‹¤ìš´ë¡œë“œ
            </button>
            
            <!-- ì œì¶œí•˜ê¸° ë²„íŠ¼ (ê°•ì¡°) -->
            <button id="submitProjectBtn" style="
                padding: 8px 18px; 
                background: #FF6B35;
                color: white; 
                border: 1px solid #E85A2A;
                border-radius: 4px; 
                cursor: pointer; 
                font-size: 14px;
                font-weight: 600;
                transition: all 0.2s;
                box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            " onmouseover="this.style.background='#E85A2A'; this.style.boxShadow='0 3px 6px rgba(0,0,0,0.2)'" onmouseout="this.style.background='#FF6B35'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.15)'">
                âœ… ì œì¶œí•˜ê¸°
            </button>
        </div>
    </div>
    
    <div id="workspace" style="height: calc(100vh - 56px);"></div>
    <div id="EntryPopupContainer"></div>
    <div id="EntryModalContainer"></div>
    <div id="EntryListContainer" class="modal"></div>

    <!-- âœ… Entry ì´ˆê¸°í™” ë° ì•± ë¡œì§ -->
    <script src="./js/global.js"></script>
    <script src="./node_modules/@entrylabs/entry/extern/lang/ko.js"></script>
    <script src="./node_modules/@entrylabs/entry/extern/util/static.js"></script>
    <script src="./node_modules/@entrylabs/tool/dist/entry-tool.js"></script>
    <script src="./lib/paint/entry-paint.js"></script>
    <script src="https://entry-cdn.pstatic.net/external/sound/sound-editor.js"></script>
    <script src="./node_modules/@entrylabs/entry/extern/util/filbert.js"></script>
    <script src="./node_modules/@entrylabs/entry/extern/util/CanvasInput.js"></script>
    <script src="./node_modules/@entrylabs/entry/extern/util/ndgmr.Collision.js"></script>
    <script src="./node_modules/@entrylabs/entry/extern/util/handle.js"></script>
    <script src="./node_modules/@entrylabs/entry/extern/util/bignumber.min.js"></script>
    <script src="./node_modules/@entrylabs/legacy-video/dist/index.js"></script>
    <script src="./node_modules/@entrylabs/entry/dist/entry.js"></script>
    
    <!-- âœ… ì—”íŠ¸ë¦¬ í™•ì¥ ê¸°ëŠ¥ -->
    <script src="./js/entryjs-webspeech-tts.js"></script>
    <script src="./lib/modal/dist/entry-modal.js"></script>
    <script type="module" src="./js/app.mjs"></script>
    <script src="/js/entry-minimal-dataapi.js"></script>
    
    <!-- ğŸ”¥ ìë™ì €ì¥ ì‹œìŠ¤í…œ (ìƒëŒ€ ê²½ë¡œë¡œ ë³€ê²½) -->
    <script src="/js/autosave.js"></script>
    
    <!-- ğŸ”¥ í”„ë¡œì íŠ¸ ì €ì¥ ì‹œìŠ¤í…œ -->
    <script src="./js/projectSaver.js"></script>

    <!-- âœ… ë¸Œë¼ìš°ì € ì§€ì› ì—¬ë¶€ í™•ì¸ -->
    <script>
    // ğŸ”¥ ìë™ì €ì¥ ë§¤ë‹ˆì € ì „ì—­ ë³€ìˆ˜
    let autoSaveManager = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        if (!('speechSynthesis' in window)) {
            console.warn('âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” Web Speech APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
                background: #ff9800; color: white; padding: 8px 16px;
                border-radius: 4px; font-size: 14px; z-index: 10000;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            `;
            notification.textContent = 'âš ï¸ ìŒì„± ì½ê¸° ê¸°ëŠ¥ì´ ì™„ì „íˆ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 5000);
        } else {
            console.log('âœ… Web Speech API ì§€ì›ë¨ - TTS ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥');
            console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ìŒì„± ìˆ˜:', speechSynthesis.getVoices().length || 'ë¡œë”© ì¤‘...');
        }
        
        // ğŸ”¥ Entry ë¡œë“œ ëŒ€ê¸° í›„ ìë™ì €ì¥ ì‹œì‘
        initAutoSave();
    });
    
    // ğŸ”¥ ìë™ì €ì¥ ì´ˆê¸°í™” í•¨ìˆ˜
    function initAutoSave() {
        const checkEntryInterval = setInterval(() => {
            if (window.Entry && window.Entry.exportProject && window.Entry.loadProject) {
                clearInterval(checkEntryInterval);
                
                console.log('ğŸ”„ ìë™ì €ì¥ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘...');
                
                // í˜„ì¬ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
                const currentUserID = window.EDUCODINGNPLAY_USER?.userID || 
                                       new URLSearchParams(window.location.search).get('userID') || 
                                       'anonymous';
                
                // ìë™ì €ì¥ ë§¤ë‹ˆì € ìƒì„± (userID ì „ë‹¬)
                autoSaveManager = new AutoSaveManager('entry', () => {
                    // Entry í”„ë¡œì íŠ¸ ë°ì´í„° ì¶”ì¶œ
                    try {
                        const projectData = Entry.exportProject();
                        console.log('ğŸ“¦ í”„ë¡œì íŠ¸ ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ:', {
                            objects: projectData?.objects?.length || 0,
                            scenes: projectData?.scenes?.length || 0
                        });
                        return projectData;
                    } catch (error) {
                        console.error('âŒ í”„ë¡œì íŠ¸ ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨:', error);
                        return null;
                    }
                }, { userID: currentUserID });
                
                // ë³µêµ¬ ê°€ëŠ¥í•œ ë°ì´í„° í™•ì¸
                const recoveryData = autoSaveManager.checkRecovery();
                if (recoveryData) {
                    console.log('ğŸ’¾ ë³µêµ¬ ê°€ëŠ¥í•œ ìë™ì €ì¥ ë°ì´í„° ë°œê²¬!');
                    autoSaveManager.showRecoveryModal(recoveryData, (projectData) => {
                        console.log('ğŸ”„ í”„ë¡œì íŠ¸ ë³µêµ¬ ì‹œì‘...');
                        Entry.loadProject(projectData);
                        console.log('âœ… í”„ë¡œì íŠ¸ ë³µêµ¬ ì™„ë£Œ!');
                    });
                } else {
                    console.log('â„¹ï¸ ë³µêµ¬í•  ìë™ì €ì¥ ë°ì´í„° ì—†ìŒ');
                }
                
                // ìë™ì €ì¥ ì‹œì‘ (ê°œë°œìš©: 30ì´ˆ, ìš´ì˜: 3ë¶„)
                // ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ë©´ 30ì´ˆë§ˆë‹¤ ì €ì¥ (í…ŒìŠ¤íŠ¸ìš©)
                // autoSaveManager.interval = 30 * 1000;
                autoSaveManager.startAutoSave();
                
                console.log('âœ… ìë™ì €ì¥ ì‹œìŠ¤í…œ í™œì„±í™” ì™„ë£Œ!');
                
                // ì „ì—­ì—ì„œ ìˆ˜ë™ ì €ì¥ ê°€ëŠ¥í•˜ë„ë¡ ë…¸ì¶œ
                window.saveProject = () => {
                    if (autoSaveManager) {
                        autoSaveManager.manualSave();
                        console.log('ğŸ’¾ ìˆ˜ë™ ì €ì¥ ì™„ë£Œ!');
                    }
                };
            }
        }, 500);
        
        // 10ì´ˆ í›„ì—ë„ Entryê°€ ë¡œë“œë˜ì§€ ì•Šìœ¼ë©´ ê²½ê³ 
        setTimeout(() => {
            if (!window.Entry) {
                console.error('âŒ Entry ë¡œë“œ ì‹¤íŒ¨ - ìë™ì €ì¥ ì‚¬ìš© ë¶ˆê°€');
            }
        }, 10000);
    }
    
    // ğŸ”¥ URL íŒŒë¼ë¯¸í„° íŒŒì‹± í•¨ìˆ˜
    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const s3Url = params.get('s3Url');
        const userID = params.get('userID') || 'anonymous';
        const role = params.get('role') || 'student';
        
        // S3 URLì—ì„œ í”„ë¡œì íŠ¸ëª… ì¶”ì¶œ
        let projectName = 'ë‚´ì‘í’ˆ';
        if (s3Url) {
            try {
                const urlPath = decodeURIComponent(s3Url);
                const fileName = urlPath.split('/').pop(); // ë§ˆì§€ë§‰ ì„¸ê·¸ë¨¼íŠ¸
                projectName = fileName.replace('.ent', ''); // í™•ì¥ì ì œê±°
                console.log(`ğŸ“Œ S3 URL íŒŒì‹± ì„±ê³µ: ${urlPath} â†’ í”„ë¡œì íŠ¸ëª…: ${projectName}`);
            } catch (err) {
                console.error('âŒ í”„ë¡œì íŠ¸ëª… ì¶”ì¶œ ì˜¤ë¥˜:', err);
            }
        } else {
            console.log('â„¹ï¸ s3Url íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        return { projectName, userID, role };
    }
    
    // ğŸ”¥ ì €ì¥/ì œì¶œ/ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ ì´ˆê¸°í™”
    function initSaveButtons() {
        const checkSaver = setInterval(() => {
            if (window.EntryProjectSaver) {
                clearInterval(checkSaver);
                
                // ğŸ”¥ URL íŒŒë¼ë¯¸í„°ì—ì„œ ì •ë³´ ë¨¼ì € ì¶”ì¶œ
                const { projectName, userID, role } = getUrlParams();
                
                console.log(`ğŸ” ì¶”ì¶œëœ ì •ë³´:`, { projectName, userID, role });
                
                // ğŸ”¥ EntryProjectSaver ìƒì„± ì‹œ ëª¨ë“  ì •ë³´ ì „ë‹¬
                const saver = new EntryProjectSaver({
                    projectName: projectName !== 'ë‚´ì‘í’ˆ' ? projectName : undefined,
                    userID: userID,
                    role: role
                });
                
                console.log(`âœ… EntryProjectSaver ì´ˆê¸°í™” ì™„ë£Œ:`, {
                    projectName: saver.projectName,
                    userID: saver.userID,
                    role: saver.role
                });
                
                // ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼
                document.getElementById('loadProjectBtn').onclick = async () => {
                    try {
                        await saver.showLoadProjectModal();
                    } catch (error) {
                        console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                    }
                };
                
                // ì €ì¥ ë²„íŠ¼
                document.getElementById('saveProjectBtn').onclick = async () => {
                    try {
                        await saver.saveProject();
                    } catch (error) {
                        console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                    }
                };
                
                // ì œì¶œ ë²„íŠ¼
                document.getElementById('submitProjectBtn').onclick = async () => {
                    try {
                        await saver.submitProject();
                    } catch (error) {
                        console.error('ì œì¶œ ì˜¤ë¥˜:', error);
                    }
                };
                
                // ğŸ”¥ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ì‹ ê·œ)
                document.getElementById('downloadProjectBtn').onclick = async () => {
                    try {
                        await saver.downloadProject();
                    } catch (error) {
                        console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                    }
                };
                
                console.log('âœ… ë¶ˆëŸ¬ì˜¤ê¸°/ì €ì¥/ë‹¤ìš´ë¡œë“œ/ì œì¶œ ë²„íŠ¼ í™œì„±í™” ì™„ë£Œ!');
                
                // ğŸ”¥ ì „ì—­ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ saver ë…¸ì¶œ
                window.entryProjectSaver = saver;
            }
        }, 500);
    }
    
    // ğŸ”¥ Query Paramsì—ì„œ ì‚¬ìš©ì ID ì½ê¸° (ì¦‰ì‹œ ì‹¤í–‰)
    (function() {
        try {
            const params = new URLSearchParams(window.location.search);
            const userID = params.get('userID') || 'guest';
            const role = params.get('role') || 'guest';
            
            console.log('ğŸ” [ì¦‰ì‹œ ì‹¤í–‰] Query Params:', { userID, role });
            
            // DOM ë¡œë“œ ì „ì—ë„ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ ì‚¬ìš©
            function updateUserDisplay() {
                const headerUserID = document.getElementById('headerUserID');
                if (headerUserID) {
                    headerUserID.textContent = userID;
                    console.log('âœ… ì‚¬ìš©ì ID í‘œì‹œ:', userID);
                } else {
                    console.warn('âš ï¸ headerUserID ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }
            }
            
            // DOMì´ ì´ë¯¸ ë¡œë“œë˜ì—ˆìœ¼ë©´ ì¦‰ì‹œ ì‹¤í–‰, ì•„ë‹ˆë©´ DOMContentLoaded ëŒ€ê¸°
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', updateUserDisplay);
            } else {
                updateUserDisplay();
            }
            
            // window.EDUCODINGNPLAY_USER ê°ì²´ë„ ì„¤ì • (í•˜ìœ„ í˜¸í™˜ì„±)
            window.EDUCODINGNPLAY_USER = window.EDUCODINGNPLAY_USER || {};
            window.EDUCODINGNPLAY_USER.userID = userID;
            window.EDUCODINGNPLAY_USER.role = role;
            
        } catch (error) {
            console.error('âŒ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
        }
    })();
    
    // ğŸ”¥ ì‚¬ìš©ì ID í‘œì‹œ (ë ˆê±°ì‹œ ì§€ì›ìš© í•¨ìˆ˜)
    function loadUserInfo() {
        try {
            const params = new URLSearchParams(window.location.search);
            const userID = params.get('userID') || window.EDUCODINGNPLAY_USER?.userID || 'guest';
            
            const headerUserID = document.getElementById('headerUserID');
            if (headerUserID) {
                headerUserID.textContent = userID;
                console.log('âœ… [loadUserInfo] ì‚¬ìš©ì ID í‘œì‹œ:', userID);
            }
        } catch (error) {
            console.log('âš ï¸ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
        }
    }
    
    // í˜ì´ì§€ ë¡œë“œ í›„ ìë™ ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', () => {
        loadUserInfo();  // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        initSaveButtons();
    });
    </script>
    
    <!-- ğŸ”¥ Paint Editor ì €ì¥ í•¨ìˆ˜ ì»¤ìŠ¤í„°ë§ˆì´ì§• -->
    <script src="./js/custom-painter-save.js"></script>
</body>
</html>