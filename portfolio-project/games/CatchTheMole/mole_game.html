<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‘ë”ì§€ ì¡ê¸° ê²Œì„</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body {
      display: flex;
      flex-direction: row;
      font-family: "Arial", sans-serif;
      justify-content: center;
      gap: 30px;
      padding: 20px;
    }

    .left-panel {
      text-align: center;
    }

    #game-area {
      width: 600px;
      height: 400px;
      position: relative;
      background-color: #d3f8d3;
      border: 2px solid #4CAF50;
      border-radius: 10px;
      margin-top: 10px;
      overflow: hidden;
    }

    .mole {
      width: 60px;
      height: 60px;
      position: absolute;
      font-size: 50px;
      cursor: pointer;
      user-select: none;
      transition: transform 0.1s;
    }
    
    .mole:active {
      transform: scale(0.9);
    }

    #score {
      font-size: 24px;
      margin: 10px;
    }

    #timer {
      font-size: 20px;
    }

    #start-button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    #start-button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }

    #ranking {
      width: 300px;
      border-left: 2px dashed #aaa;
      padding-left: 20px;
    }

    #ranking h2 {
      margin-top: 0;
    }

    .ranking-entry {
      font-size: 16px;
      margin: 10px 0;
      padding: 8px;
      background-color: #f5f5f5;
      border-radius: 5px;
    }
    
    .ranking-entry.current-user {
      background-color: #e7f5e7;
      border-left: 3px solid #4CAF50;
    }
    
    .game-info {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .user-info {
      margin-bottom: 15px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
    }
    
    .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 20px;
      width: 300px;
      border-radius: 10px;
      text-align: center;
    }
    
    .trophy {
      font-size: 40px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="left-panel">
    <h1>ğŸ¾ ë‘ë”ì§€ ì¡ê¸° ê²Œì„</h1>
    <div class="game-info">
      <div class="user-info" id="user-info">ë¡œê·¸ì¸ ì¤‘...</div>
      <div id="score">ì ìˆ˜: 0</div>
      <div id="timer">ë‚¨ì€ ì‹œê°„: 30ì´ˆ</div>
    </div>
    <button id="start-button" class="btn btn-success">ê²Œì„ ì‹œì‘</button>
    <div id="game-area"></div>
  </div>

  <div id="ranking">
    <h2>ğŸ† ë­í‚¹</h2>
    <div id="ranking-list">
      <p>ë¡œë”© ì¤‘...</p>
    </div>
  </div>
  
  <div id="game-end-modal" class="modal">
    <div class="modal-content">
      <div class="trophy">ğŸ†</div>
      <h3>ê²Œì„ ì¢…ë£Œ!</h3>
      <p id="final-score">ìµœì¢… ì ìˆ˜: 0ì </p>
      <button id="close-modal" class="btn btn-primary">í™•ì¸</button>
    </div>
  </div>

  <script>
    // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    let currentUserID = '';
    let highestScore = 0;
    
    // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    async function getCurrentUser() {
      try {
        const response = await fetch('/api/get-user-session');
        const data = await response.json();
        
        if (data.is_logined) {
          currentUserID = data.userID;
          document.getElementById('user-info').textContent = `í”Œë ˆì´ì–´: ${currentUserID}`;
          return data.userID;
        } else {
          document.getElementById('user-info').textContent = 'ê²ŒìŠ¤íŠ¸ í”Œë ˆì´ì–´';
          return 'guest';
        }
      } catch (error) {
        console.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
        document.getElementById('user-info').textContent = 'ê²ŒìŠ¤íŠ¸ í”Œë ˆì´ì–´';
        return 'guest';
      }
    }
    
    // ë­í‚¹ ê°€ì ¸ì˜¤ê¸°
    async function getRankings() {
      try {
        const response = await fetch('/api/mole-game/rankings');
        return await response.json();
      } catch (error) {
        console.error('ë­í‚¹ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
        return [];
      }
    }
    
    // ì ìˆ˜ ì €ì¥í•˜ê¸°
    async function saveScore(score) {
      try {
        const response = await fetch('/api/mole-game/save-score', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ score }),
        });
        return await response.json();
      } catch (error) {
        console.error('ì ìˆ˜ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
        return { success: false };
      }
    }
    
    // ë­í‚¹ í‘œì‹œí•˜ê¸°
    async function displayRankings() {
      const rankings = await getRankings();
      const rankingList = document.getElementById('ranking-list');
      
      if (rankings.length === 0) {
        rankingList.innerHTML = '<p>ì•„ì§ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }
      
      let rankingHTML = '';
      rankings.forEach((entry, index) => {
        const isCurrentUser = entry.userID === currentUserID;
        const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}`;
        
        rankingHTML += `
          <div class="ranking-entry ${isCurrentUser ? 'current-user' : ''}">
            <div>${medal} ${entry.userID} â€” ${entry.score}ì </div>
          </div>
        `;
        
        // í˜„ì¬ ì‚¬ìš©ìì˜ ìµœê³  ì ìˆ˜ ì €ì¥
        if (isCurrentUser && entry.score > highestScore) {
          highestScore = entry.score;
        }
      });
      
      rankingList.innerHTML = rankingHTML;
    }

    const gameArea = document.getElementById('game-area');
    const scoreDisplay = document.getElementById('score');
    const timerDisplay = document.getElementById('timer');
    const startButton = document.getElementById('start-button');
    const modal = document.getElementById('game-end-modal');
    const finalScoreDisplay = document.getElementById('final-score');
    const closeModalButton = document.getElementById('close-modal');

    const animals = [
      { emoji: 'ğŸ°', score: 1, duration: 1500 },
      { emoji: 'ğŸ¹', score: 2, duration: 1200 },
      { emoji: 'ğŸ¸', score: 3, duration: 900 },
      { emoji: 'ğŸ¦Š', score: 5, duration: 600 }
    ];

    let score = 0;
    let timeLeft = 30;
    let gameInterval;
    let timerInterval;
    let animalClicked = false;

    function spawnRandomAnimal() {
      const randomAnimal = animals[Math.floor(Math.random() * animals.length)];

      const mole = document.createElement('div');
      mole.classList.add('mole');
      mole.innerText = randomAnimal.emoji;

      // í™”ë©´ í¬ê¸°ì— ë§ê²Œ ìœ„ì¹˜ ì¡°ì •
      const x = Math.random() * (gameArea.clientWidth - 60);
      const y = Math.random() * (gameArea.clientHeight - 60);
      mole.style.left = `${x}px`;
      mole.style.top = `${y}px`;

      mole.addEventListener('click', () => {
        score += randomAnimal.score;
        scoreDisplay.textContent = `ì ìˆ˜: ${score}`;
        mole.remove();
        animalClicked = true;
        
        // í´ë¦­ íš¨ê³¼ìŒ ì¬ìƒ (ë‚˜ì¤‘ì— ì¶”ê°€ ê°€ëŠ¥)
        // new Audio('/resource/sounds/click.mp3').play();
      });

      gameArea.appendChild(mole);

      setTimeout(() => mole.remove(), randomAnimal.duration);
    }

    async function startGame() {
      // ê²Œì„ ì‹œì‘ ì „ ì‚¬ìš©ì í™•ì¸
      await getCurrentUser();
      
      score = 0;
      timeLeft = 30;
      scoreDisplay.textContent = `ì ìˆ˜: ${score}`;
      timerDisplay.textContent = `ë‚¨ì€ ì‹œê°„: ${timeLeft}ì´ˆ`;
      startButton.disabled = true;
      document.getElementById('ranking-list').innerHTML = `<p>ê²Œì„ ì§„í–‰ ì¤‘...</p>`;
      
      // ê²Œì„ ì˜ì—­ ì´ˆê¸°í™”
      gameArea.innerHTML = '';

      // ë™ë¬¼ ìƒì„± ê°„ê²© ì„¤ì •
      gameInterval = setInterval(() => {
        spawnRandomAnimal();
      }, 1000); // 1ì´ˆë§ˆë‹¤ ë“±ì¥

      // íƒ€ì´ë¨¸ ì‹œì‘
      timerInterval = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `ë‚¨ì€ ì‹œê°„: ${timeLeft}ì´ˆ`;

        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          clearInterval(gameInterval);
          endGame();
        }
      }, 1000);
    }

    async function endGame() {
      // ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬
      gameArea.innerHTML = '';
      
      // ì ìˆ˜ ì €ì¥
      if (currentUserID !== 'guest') {
        await saveScore(score);
      }
      
      // ë­í‚¹ ì—…ë°ì´íŠ¸
      await displayRankings();
      
      // ëª¨ë‹¬ í‘œì‹œ
      finalScoreDisplay.textContent = `ìµœì¢… ì ìˆ˜: ${score}ì `;
      
      // ìƒˆ ê¸°ë¡ì¸ì§€ í™•ì¸
      if (score > highestScore && currentUserID !== 'guest') {
        finalScoreDisplay.textContent += ' (ìƒˆ ê¸°ë¡!)';
      }
      
      modal.style.display = 'block';
      startButton.disabled = false;
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    startButton.addEventListener('click', startGame);
    
    closeModalButton.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener('load', async () => {
      await getCurrentUser();
      await displayRankings();
    });
  </script>
</body>
</html>