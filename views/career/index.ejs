<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>진로진학 대시보드 | 코딩앤플레이</title>

    <!-- CSS Dependencies -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/board-layout.css">
    <link rel="stylesheet" href="/css/career.css"> <!-- New CSS file -->

    <style>
        /* Embedded CSS for rapid prototyping, move to career.css later */
        .career-container {
            padding: 20px;
        }

        .view-toggle-btn {
            width: 120px;
        }

        .map-container {
            background-color: #f8f9fa;
            border-radius: 12px;
            min-height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #dee2e6;
            position: relative;
        }

        .korea-map-svg {
            max-height: 450px;
            width: auto;
        }

        .univ-card {
            transition: transform 0.2s;
            cursor: pointer;
        }

        .univ-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .region-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 20px;
        }
    </style>
</head>

<body>
    <%- include('../partials/header') %>

        <div class="board-layout-container">
            <!-- Sidebar (공통 사이드바) -->
            <%- include('../teacher/partials/sidebar', { currentView: currentView === 'map' ? 'university' : 'cutlines' }) %>

            <!-- Main Content -->
            <div class="board-main-content">
                <div class="career-container">
                    <% if (isMock) { %>
                        <div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
                            <i class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2"></i>
                            <div>
                                <strong>Mock Data Mode</strong>: 현재 데이터베이스 연결 문제로 인해 모의 데이터가 표시되고 있습니다.
                            </div>
                        </div>
                        <% } %>

                            <!-- Header & Controls -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="fw-bold m-0 text-dark">
                                    <i class="bi bi-buildings me-2 text-primary"></i>대학/학과 대시보드
                                </h4>

                                <!-- View Toggle -->
                                <div class="btn-group" role="group" aria-label="View Toggle">
                                    <button type="button"
                                        class="btn btn-outline-primary <%= (typeof currentView === 'undefined' || currentView === 'map' || currentView === 'university') ? 'active' : '' %> view-toggle-btn"
                                        id="btn-map-view">
                                        <i class="bi bi-map me-1"></i> 지도 뷰
                                    </button>
                                    <button type="button"
                                        class="btn btn-outline-primary <%= (currentView === 'matrix' || currentView === 'cutlines') ? 'active' : '' %> view-toggle-btn"
                                        id="btn-matrix-view">
                                        <i class="bi bi-table me-1"></i> 매트릭스 뷰
                                    </button>
                                </div>
                            </div>

                            <!-- 1. Map View Section -->
                            <div id="view-map"
                                class="row <%= (currentView === 'matrix' || currentView === 'cutlines') ? 'd-none' : '' %>">
                                <!-- Left: Interactive Map Area -->
                                <div class="col-lg-5 mb-4 mb-lg-0">
                                    <div class="card h-100 shadow-sm border-0">
                                        <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                                            <h6 class="fw-bold">지역 선택</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="map-container text-center text-muted">
                                                <!-- Placeholder for Korea Map -->
                                                <div id="korea-map-placeholder">
                                                    <i class="bi bi-geo-alt display-4 mb-3 d-block text-secondary"></i>
                                                    <p>대한민국 지도 영역<br>(SVG Map Implementation Placeholder)</p>
                                                    <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
                                                        <% regions.forEach(region=> { %>
                                                            <button
                                                                class="btn btn-sm btn-light border region-filter-btn"
                                                                data-region="<%= region %>">
                                                                <%= region %>
                                                            </button>
                                                            <% }); %>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right: University List -->
                                <div class="col-lg-7">
                                    <div class="card h-100 shadow-sm border-0">
                                        <div
                                            class="card-header bg-white border-bottom-0 py-3 d-flex justify-content-between align-items-center">
                                            <h6 class="fw-bold m-0" id="univ-list-title">전국 대학 목록</h6>
                                            <span class="badge bg-primary rounded-pill">
                                                <%= universities.length %>개
                                            </span>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="list-group list-group-flush" id="univ-list-group"
                                                style="max-height: 600px; overflow-y: auto;">
                                                <% universities.forEach(univ=> { %>
                                                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3 univ-item"
                                                        data-region="<%= univ.region %>">
                                                        <div class="d-flex align-items-center">
                                                            <div class="bg-light rounded-circle p-2 me-3 d-flex align-items-center justify-content-center"
                                                                style="width: 40px; height: 40px;">
                                                                <i class="bi bi-building text-secondary"></i>
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-0 fw-bold">
                                                                    <%= univ.name %>
                                                                </h6>
                                                                <small class="text-muted">
                                                                    <%= univ.region %> 지역
                                                                </small>
                                                            </div>
                                                        </div>
                                                        <button
                                                            class="btn btn-sm btn-outline-primary rounded-pill px-3">
                                                            상세보기
                                                        </button>
                                                    </div>
                                                    <% }); %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. Matrix View Section (Hidden by default) -->
                            <div id="view-matrix"
                                class="<%= (currentView === 'matrix' || currentView === 'cutlines') ? '' : 'd-none' %>">
                                <div class="card shadow-sm border-0">
                                    <div class="card-header bg-white py-3">
                                        <h6 class="fw-bold m-0"><i class="bi bi-grid-3x3 me-2"></i>성적 구간별 지원 가능 대학
                                            (Matrix)</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-hover text-center align-middle"
                                                id="matrix-table">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th scope="col" style="width: 15%;">내신 등급 구간</th>
                                                        <th scope="col">지원 가능 대학 / 학과 예시</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="matrix-tbody">
                                                    <tr>
                                                        <td colspan="2" class="p-5 text-muted">
                                                            <div class="spinner-border text-primary mb-2" role="status">
                                                            </div>
                                                            <p class="m-0">데이터 로딩 중...</p>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const btnMap = document.getElementById('btn-map-view');
                const btnMatrix = document.getElementById('btn-matrix-view');
                const viewMap = document.getElementById('view-map');
                const viewMatrix = document.getElementById('view-matrix');

                // View Toggle Logic
                btnMap.addEventListener('click', () => {
                    btnMap.classList.add('active');
                    btnMatrix.classList.remove('active');
                    viewMap.classList.remove('d-none');
                    viewMatrix.classList.add('d-none');
                });

                btnMatrix.addEventListener('click', () => {
                    btnMatrix.classList.add('active');
                    btnMap.classList.remove('active');
                    viewMatrix.classList.remove('d-none');
                    viewMap.classList.add('d-none');
                    loadMatrixData(); // Fetch Data when tab is clicked
                });

                // Region Filter Logic (Simple Client-side)
                const regionBtns = document.querySelectorAll('.region-filter-btn');
                const univItems = document.querySelectorAll('.univ-item');
                const listTitle = document.getElementById('univ-list-title');

                regionBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const region = btn.dataset.region;
                        let count = 0;

                        // Reset active states
                        regionBtns.forEach(b => b.classList.remove('btn-primary', 'text-white'));
                        regionBtns.forEach(b => b.classList.add('btn-light'));

                        // Set active
                        btn.classList.remove('btn-light');
                        btn.classList.add('btn-primary', 'text-white');

                        univItems.forEach(item => {
                            if (item.dataset.region === region || region === 'All') {
                                item.classList.remove('d-none');
                                item.classList.add('d-flex');
                                count++;
                            } else {
                                item.classList.add('d-none');
                                item.classList.remove('d-flex');
                            }
                        });

                        document.querySelector('#view-map .badge').textContent = `${count}개`;
                        listTitle.textContent = `${region} 지역 대학 목록`;
                    });
                });

                // Matrix Data Loader
                let matrixLoaded = false;
                async function loadMatrixData() {
                    if (matrixLoaded) return;

                    try {
                        const response = await fetch('/teacher/career-info/api/results/matrix');
                        const json = await response.json();

                        if (json.success) {
                            renderMatrix(json.data);
                            matrixLoaded = true;
                        }
                    } catch (err) {
                        console.error("Matrix load failed", err);
                        document.getElementById('matrix-tbody').innerHTML = `
                        <tr><td colspan="2" class="text-danger">데이터를 불러오는데 실패했습니다.</td></tr>
                    `;
                    }
                }

                // Auto-load matrix data if initial view is matrix
                if (!document.getElementById('view-matrix').classList.contains('d-none')) {
                    loadMatrixData();
                }

                function renderMatrix(data) {
                    const tbody = document.getElementById('matrix-tbody');
                    tbody.innerHTML = '';

                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="2">데이터가 없습니다.</td></tr>';
                        return;
                    }

                    data.forEach(row => {
                        const univsHtml = Object.entries(row.universities).map(([univName, depts]) => {
                            return `<span class="badge bg-light text-dark border me-2 mb-1" style="font-size: 0.9rem;">
                            <strong>${univName}</strong>: ${depts.join(', ')}
                        </span>`;
                        }).join('');

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                        <td class="fw-bold bg-light">${row.grade_range}</td>
                        <td class="text-start p-3">${univsHtml}</td>
                    `;
                        tbody.appendChild(tr);
                    });
                }
            });
        </script>
</body>

</html>