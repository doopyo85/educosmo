<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= pageTitle %> - 코딩앤플레이
    </title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .my-gallery-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-header h1 i {
            color: #667eea;
        }

        /* 탭 네비게이션 */
        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 2rem;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #666;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 0;
            position: relative;
        }

        .nav-tabs .nav-link:hover {
            color: #667eea;
            border: none;
        }

        .nav-tabs .nav-link.active {
            color: #667eea;
            background: none;
            border: none;
        }

        .nav-tabs .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px 3px 0 0;
        }

        /* 통계 카드 */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }

        .stat-card .label {
            color: #666;
            font-size: 0.9rem;
        }

        /* 프로젝트 카드 그리드 */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .project-card-thumb {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            position: relative;
        }

        .project-card-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .project-card-thumb .play-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .project-card:hover .play-overlay {
            opacity: 1;
        }

        .play-overlay i {
            font-size: 3rem;
            color: white;
        }

        .project-card-body {
            padding: 1.25rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .project-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .project-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.4;
        }

        .project-card-description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 0.75rem;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            flex: 1;
        }

        .project-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem;
            border-top: 1px solid #f0f0f0;
            font-size: 0.85rem;
            color: #999;
        }

        .project-card-stats {
            display: flex;
            gap: 1rem;
        }

        .project-card-stats span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .project-card-footer {
            padding: 0 1.25rem 1.25rem;
            display: flex;
            gap: 0.5rem;
        }

        .project-card-footer .btn {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.85rem;
        }

        .platform-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .platform-badge.entry {
            background: #00c4b4;
        }

        .platform-badge.scratch {
            background: #ff9a00;
        }

        .platform-badge.python {
            background: #306998;
        }

        .visibility-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .visibility-badge.public {
            background: #d4edda;
            color: #155724;
        }

        .visibility-badge.class {
            background: #cce5ff;
            color: #004085;
        }

        .visibility-badge.private {
            background: #f8d7da;
            color: #721c24;
        }

        .action-btns .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        /* 빈 상태 */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* 로딩 */
        .loading-container {
            display: flex;
            justify-content: center;
            padding: 3rem;
        }

        /* 반응형 */
        @media (max-width: 768px) {
            .projects-grid {
                grid-template-columns: 1fr;
            }

            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <%- include('partials/header') %>

        <div class="board-layout-container">
            <!-- Sidebar -->
            <%- include('partials/my-universe-sidebar', { activeTab: 'gallery' , student: null }) %>

                <!-- Main Content -->
                <div class="board-main-content">
                    <div class="my-gallery-container" style="padding: 0; max-width: none;">
                        <div class="page-header">
                            <h1><i class="bi bi-folder-fill"></i> 내 포트폴리오</h1>
                            <a href="/gallery/share" class="btn btn-primary">
                                <i class="bi bi-plus-lg"></i> 새 작품 공유
                            </a>
                        </div>

                        <!-- 통계 -->
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="value" id="totalProjects">0</div>
                                <div class="label">공유한 작품</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="totalViews">0</div>
                                <div class="label">총 조회수</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="totalLikes">0</div>
                                <div class="label">총 좋아요</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="totalPlays">0</div>
                                <div class="label">총 실행수</div>
                            </div>
                        </div>

                        <!-- 탭 -->
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" data-filter="">전체</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-filter="entry">엔트리</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-filter="scratch">스크래치</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-filter="python">파이썬</a>
                            </li>
                        </ul>

                        <!-- 로딩 -->
                        <div class="loading-container" id="loading">
                            <div class="spinner-border text-primary"></div>
                        </div>

                        <!-- 프로젝트 카드 그리드 -->
                        <div class="projects-grid" id="projectsGrid" style="display: none;"></div>

                        <!-- 빈 상태 -->
                        <div class="empty-state" id="emptyState" style="display: none;">
                            <i class="bi bi-folder2-open"></i>
                            <h4>아직 공유한 작품이 없어요</h4>
                            <p>첫 번째 작품을 갤러리에 공유해보세요!</p>
                            <a href="/gallery/share" class="btn btn-primary mt-3">
                                <i class="bi bi-upload"></i> 작품 공유하기
                            </a>
                        </div>
                    </div>

                    <!-- 수정 모달 -->
                    <div class="modal fade" id="editModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title"><i class="bi bi-pencil"></i> 작품 정보 수정</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <input type="hidden" id="editProjectId">
                                    <div class="mb-3">
                                        <label class="form-label">제목</label>
                                        <input type="text" class="form-control" id="editTitle">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">설명</label>
                                        <textarea class="form-control" id="editDescription" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">공개 범위</label>
                                        <select class="form-select" id="editVisibility">
                                            <option value="public">전체 공개</option>
                                            <option value="class">같은 센터만</option>
                                            <option value="private">나만 보기</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">태그 (쉼표로 구분)</label>
                                        <input type="text" class="form-control" id="editTags"
                                            placeholder="예: 게임, 애니메이션">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                    <button type="button" class="btn btn-primary" onclick="saveEdit()">저장</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 삭제 확인 모달 -->
                    <div class="modal fade" id="deleteModal" tabindex="-1">
                        <div class="modal-dialog modal-sm">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title text-danger"><i class="bi bi-trash"></i> 삭제 확인</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>정말 이 작품을 갤러리에서 삭제하시겠습니까?</p>
                                    <p class="text-muted small">원본 프로젝트 파일은 삭제되지 않습니다.</p>
                                    <input type="hidden" id="deleteProjectId">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">삭제</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
                    <script>
                        let allProjects = [];
                        let currentFilter = '';

                        document.addEventListener('DOMContentLoaded', () => {
                            loadMyProjects();
                            setupTabs();
                        });

                        function setupTabs() {
                            document.querySelectorAll('.nav-tabs .nav-link').forEach(tab => {
                                tab.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    document.querySelectorAll('.nav-tabs .nav-link').forEach(t => t.classList.remove('active'));
                                    tab.classList.add('active');
                                    currentFilter = tab.dataset.filter;
                                    renderProjects();
                                });
                            });
                        }

                        async function loadMyProjects() {
                            const loading = document.getElementById('loading');
                            const grid = document.getElementById('projectsGrid');
                            const empty = document.getElementById('emptyState');

                            loading.style.display = 'flex';
                            grid.style.display = 'none';
                            empty.style.display = 'none';

                            try {
                                const response = await fetch('/api/gallery/my?limit=100');
                                const result = await response.json();

                                if (result.success && result.data.length > 0) {
                                    allProjects = result.data;
                                    updateStats();
                                    renderProjects();
                                    grid.style.display = 'grid';
                                } else {
                                    empty.style.display = 'block';
                                }
                            } catch (error) {
                                console.error('내 작품 로드 오류:', error);
                                empty.style.display = 'block';
                            } finally {
                                loading.style.display = 'none';
                            }
                        }

                        function updateStats() {
                            document.getElementById('totalProjects').textContent = allProjects.length;
                            document.getElementById('totalViews').textContent = formatNumber(
                                allProjects.reduce((sum, p) => sum + (p.view_count || 0), 0)
                            );
                            document.getElementById('totalLikes').textContent = formatNumber(
                                allProjects.reduce((sum, p) => sum + (p.like_count || 0), 0)
                            );
                            document.getElementById('totalPlays').textContent = formatNumber(
                                allProjects.reduce((sum, p) => sum + (p.play_count || 0), 0)
                            );
                        }

                        function renderProjects() {
                            const grid = document.getElementById('projectsGrid');
                            let filtered = allProjects;

                            if (currentFilter) {
                                filtered = allProjects.filter(p => p.platform === currentFilter);
                            }

                            if (filtered.length === 0) {
                                grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #999;">해당 플랫폼의 작품이 없습니다.</div>`;
                                return;
                            }

                            grid.innerHTML = filtered.map(p => {
                                const thumbContent = p.thumbnail_url
                                    ? `<img src="${p.thumbnail_url}" alt="${escapeHtml(p.title)}">`
                                    : `<i class="bi bi-${getPlatformIcon(p.platform)}"></i>`;

                                const description = p.description || '설명이 없습니다.';

                                return `
                    <div class="project-card" onclick="window.location.href='/gallery/project/${p.id}'">
                        <div class="project-card-thumb">
                            ${thumbContent}
                            <div class="play-overlay">
                                <i class="bi bi-play-circle-fill"></i>
                            </div>
                        </div>
                        <div class="project-card-body">
                            <div class="project-card-header">
                                <h3 class="project-card-title">${escapeHtml(p.title)}</h3>
                                <span class="platform-badge ${p.platform}">${getPlatformName(p.platform)}</span>
                            </div>
                            <p class="project-card-description">${escapeHtml(description)}</p>
                            <div class="project-card-meta">
                                <div class="project-card-stats">
                                    <span><i class="bi bi-eye"></i> ${formatNumber(p.view_count)}</span>
                                    <span><i class="bi bi-heart-fill text-danger"></i> ${formatNumber(p.like_count)}</span>
                                    <span><i class="bi bi-play-circle"></i> ${formatNumber(p.play_count)}</span>
                                </div>
                                <span class="visibility-badge ${p.visibility}">${getVisibilityName(p.visibility)}</span>
                            </div>
                        </div>
                        <div class="project-card-footer" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-outline-primary" onclick="openEdit(${p.id})">
                                <i class="bi bi-pencil"></i> 수정
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="openDelete(${p.id})">
                                <i class="bi bi-trash"></i> 삭제
                            </button>
                        </div>
                    </div>
                `;
                            }).join('');
                        }

                        function openEdit(id) {
                            const project = allProjects.find(p => p.id === id);
                            if (!project) return;

                            document.getElementById('editProjectId').value = id;
                            document.getElementById('editTitle').value = project.title;
                            document.getElementById('editDescription').value = project.description || '';
                            document.getElementById('editVisibility').value = project.visibility;
                            document.getElementById('editTags').value = (project.tags || []).join(', ');

                            new bootstrap.Modal(document.getElementById('editModal')).show();
                        }

                        async function saveEdit() {
                            const id = document.getElementById('editProjectId').value;
                            const data = {
                                title: document.getElementById('editTitle').value,
                                description: document.getElementById('editDescription').value,
                                visibility: document.getElementById('editVisibility').value,
                                tags: document.getElementById('editTags').value.split(',').map(t => t.trim()).filter(t => t)
                            };

                            try {
                                const response = await fetch(`/api/gallery/projects/${id}`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(data)
                                });

                                const result = await response.json();

                                if (result.success) {
                                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                                    loadMyProjects();
                                    alert('저장되었습니다.');
                                } else {
                                    alert('저장 실패: ' + result.error);
                                }
                            } catch (error) {
                                console.error('저장 오류:', error);
                                alert('저장 중 오류가 발생했습니다.');
                            }
                        }

                        function openDelete(id) {
                            document.getElementById('deleteProjectId').value = id;
                            new bootstrap.Modal(document.getElementById('deleteModal')).show();
                        }

                        async function confirmDelete() {
                            const id = document.getElementById('deleteProjectId').value;

                            try {
                                const response = await fetch(`/api/gallery/projects/${id}`, {
                                    method: 'DELETE'
                                });

                                const result = await response.json();

                                if (result.success) {
                                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                                    loadMyProjects();
                                    alert('삭제되었습니다.');
                                } else {
                                    alert('삭제 실패: ' + result.error);
                                }
                            } catch (error) {
                                console.error('삭제 오류:', error);
                                alert('삭제 중 오류가 발생했습니다.');
                            }
                        }

                        function getPlatformIcon(platform) {
                            const icons = { entry: 'box-fill', scratch: 'puzzle-fill', python: 'code-slash' };
                            return icons[platform] || 'file-code';
                        }

                        function getPlatformName(platform) {
                            const names = { entry: '엔트리', scratch: '스크래치', python: '파이썬' };
                            return names[platform] || platform;
                        }

                        function getVisibilityName(visibility) {
                            const names = { public: '전체', class: '센터', private: '비공개' };
                            return names[visibility] || visibility;
                        }

                        function formatNumber(num) {
                            return (num || 0).toLocaleString();
                        }

                        function formatDate(dateStr) {
                            return new Date(dateStr).toLocaleDateString('ko-KR');
                        }

                        function escapeHtml(text) {
                            const div = document.createElement('div');
                            div.textContent = text || '';
                            return div.innerHTML;
                        }
                    </script>

                    <script>
                        // ... script content ...
                    </script>

                </div> <!-- End board-main-content -->
        </div> <!-- End board-layout-container -->

        <%- include('partials/footer') %>
</body>

</html>