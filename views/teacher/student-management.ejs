<%
// Layout Data ì„¤ì •
var layoutData = {
    title: 'í•™ìƒ ê´€ë¦¬',
    sidebarType: 'teacher',
    currentView: typeof currentView !== 'undefined' ? currentView : 'progress',
    additionalCSS: [
        '/css/teacher.css',
        '/css/teacher/student-management.css?v=6'
    ],
    additionalJS: [
        '/js/teacher/student-management.js?v=8'
    ],
    body: renderBody()
};

function renderBody() {
%>
<!-- Inline Styles (Page-Specific) -->
<style>
    /* Thinner Calendar Header */
    .attendance-calendar {
        grid-template-rows: 40px !important;
        grid-auto-rows: minmax(calc((100vh - 350px) / 6), 1fr) !important;
        min-height: calc(100vh - 250px);
    }

    .calendar-header {
        padding: 0 !important;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
    }

    /* User Request: Calendar Year/Month Label Size */
    #currentMonthLabel {
        font-size: 2.2rem !important;
        min-width: 150px !important;
    }

    /* User Request: Move Day Row Higher */
    .calendar-header {
        align-items: flex-start !important;
        padding-top: 5px !important;
    }

    /* Holiday Styles */
    .holiday-text {
        color: #dc3545 !important;
    }

    .holiday-badge {
        display: inline-block;
        font-size: 0.7rem;
        color: #e03131;
        margin-left: 4px;
        font-weight: normal;
    }

    /* User Request: Reduce Title Spacing */
    .page-header-bar {
        padding-bottom: 5px !important;
        margin-bottom: 0 !important;
    }

    .page-description {
        margin-top: 4px !important;
        margin-bottom: 0 !important;
    }
</style>

<!-- í•™ìƒ ê´€ë¦¬ ë©”ì¸ ë·° -->
<div id="student-management-view" style="padding: 24px;">
    <%
    let pageTitle = 'í•™ìŠµ ì§„ë„';
    let pageSubtitle = 'í•™ìƒ ê´€ë¦¬ > í•™ìŠµ ì§„ë„';

    if (typeof currentView !== 'undefined') {
        if (currentView === 'list') {
            pageTitle = 'í•™ìƒ ëª©ë¡';
            pageSubtitle = 'í•™ìƒ ê´€ë¦¬ > í•™ìƒ ëª©ë¡';
        } else if (currentView === 'attendance') {
            pageTitle = 'ì¶œì„ë¶€';
            pageSubtitle = 'í•™ìƒ ê´€ë¦¬ > ì¶œì„ë¶€';
        } else if (currentView === 'class-materials') {
            pageTitle = 'ìˆ˜ì—… ìë£Œ';
            pageSubtitle = 'êµì‚¬ ì „ìš© > ìˆ˜ì—… ìë£Œ';
        } else if (currentView === 'career-info') {
            pageTitle = 'ì§„ë¡œ ì§„í•™';
            pageSubtitle = 'êµì‚¬ ì „ìš© > ì§„ë¡œ ì§„í•™';
        }
    }
    %>

    <!-- Header Bar -->
    <div class="page-header-bar mb-0 pb-3">
        <!-- Left Group: Title -->
        <div class="d-flex align-items-end gap-5">
            <div class="brand-section">
                <div class="d-flex flex-column">
                    <small class="text-muted fw-bold mb-1" id="page-subtitle" style="font-size: 0.85rem;">
                        <%= pageSubtitle %>
                    </small>
                    <h3 class="page-title mb-0" id="page-main-title">
                        <%= pageTitle %>
                    </h3>
                </div>

                <div class="page-description mt-2">
                    ìš°ë¦¬ ì„¼í„° í•™ìƒë“¤ì˜ ëª©ë¡ê³¼ í•™ìŠµ ì§„ë„ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>

        <!-- Center Group: Attendance Controls -->
        <div class="d-flex justify-content-center align-items-center">
            <div class="attendance-controls align-items-center <%= typeof currentView !== 'undefined' && currentView === 'attendance' ? 'd-flex' : 'd-none' %>" id="attendanceControls">
                <button class="btn btn-outline-secondary btn-sm" onclick="StudentManagement.prevMonth()">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <span class="fw-bold mx-3" id="currentMonthLabel" style="font-size: 1.1rem; min-width: 80px; text-align: center;">2024. 12</span>
                <button class="btn btn-outline-secondary btn-sm" onclick="StudentManagement.nextMonth()">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Right Group: Controls -->
        <div class="header-controls d-flex align-items-end justify-content-end">
            <!-- Add Button (List Only) -->
            <button class="btn btn-primary rounded-pill btn-sm px-3 me-3" id="addStudentBtn" style="<%= typeof currentView !== 'undefined' && currentView === 'list' ? '' : 'display: none;' %>">
                <i class="bi bi-person-plus me-1"></i> ì¶”ê°€
            </button>

            <!-- Vertical Stack: Center Select (Top) & Search (Bottom) -->
            <div class="d-flex flex-column align-items-end gap-2">
                <!-- ğŸ”¥ Admin Center Selector -->
                <% if (role === 'admin' && typeof centers !== 'undefined' && centers.length > 0) { %>
                <div class="me-1">
                    <select id="centerSelect" class="form-select form-select-sm text-start" style="width: 200px; border-color: #ff9f1c;" onchange="changeAdminCenter(this.value)">
                        <option value="">ì „ì²´ ì„¼í„° ë³´ê¸°</option>
                        <% centers.forEach(function(center) { %>
                        <option value="<%= center.id %>" <%= typeof centerID !== 'undefined' && center.id == centerID ? 'selected' : '' %>>
                            <%= center.name %>
                        </option>
                        <% }); %>
                    </select>
                    <script>
                        function changeAdminCenter(val) {
                            try {
                                const currentUrl = new window.URL(window.location.href);
                                if (val) {
                                    currentUrl.searchParams.set('centerID', val);
                                } else {
                                    currentUrl.searchParams.delete('centerID');
                                }
                                window.location.href = currentUrl.toString();
                            } catch (e) {
                                console.error('URL Update Error:', e);
                                alert('í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            }
                        }
                    </script>
                </div>
                <% } %>

                <!-- Search Inputs -->
                <div class="search-wrapper <%= typeof currentView !== 'undefined' && currentView === 'progress' ? '' : 'd-none' %>" id="progressSearchWrapper">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" id="progressSearch" class="form-control" placeholder="í•™ìƒ ì´ë¦„/ì•„ì´ë”” ê²€ìƒ‰..." />
                </div>

                <div class="search-wrapper <%= typeof currentView !== 'undefined' && currentView === 'list' ? '' : 'd-none' %>" id="studentSearchWrapper">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" id="studentSearch" class="form-control" placeholder="í•™ìƒ ì´ë¦„/ì•„ì´ë”” ê²€ìƒ‰..." />
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content (Tables) -->
    <div class="tab-content" id="studentTabContent">

        <!-- í•™ìŠµ ì§„ë„ íƒ­ (Default Visible) -->
        <div class="tab-pane fade <%= typeof currentView !== 'undefined' && currentView === 'progress' ? 'show active' : '' %>" id="student-progress" role="tabpanel">
            <div class="content-card">
                <div class="table-responsive" id="progressTableWrapper">
                    <table class="premium-table">
                        <colgroup>
                            <col style="width: 3%;"> <!-- No -->
                            <col style="width: 6%;"> <!-- Profile -->
                            <col style="width: 6%;"> <!-- CT -->
                            <col style="width: 10%;"> <!-- Name -->
                            <col style="width: 11%;"> <!-- ID -->
                            <col style="width: 8%;"> <!-- Scratch -->
                            <col style="width: 8%;"> <!-- Entry -->
                            <col style="width: 8%;"> <!-- AppInv -->
                            <col style="width: 8%;"> <!-- Python -->
                            <col style="width: 8%;"> <!-- Data -->
                            <col style="width: 10%;"> <!-- Storage -->
                            <col style="width: 10%;"> <!-- Last Learning -->
                        </colgroup>
                        <thead>
                            <tr>
                                <th rowspan="2">No.</th>
                                <th rowspan="2">í”„ë¡œí•„</th>
                                <th rowspan="2" data-sort="ct_level">CT <i class="bi bi-caret-down-fill sort-icon"></i></th>
                                <th rowspan="2" data-sort="name">ì´ë¦„ <i class="bi bi-caret-down-fill sort-icon"></i></th>
                                <th rowspan="2" data-sort="username">ì•„ì´ë”” <i class="bi bi-caret-down-fill sort-icon"></i></th>
                                <th colspan="5" class="text-center border-bottom">í”Œë«í¼ë³„ ì§„ë„ìœ¨</th>
                                <th rowspan="2" data-sort="storage_usage">ìŠ¤í† ë¦¬ì§€ <i class="bi bi-caret-down-fill sort-icon"></i></th>
                                <th rowspan="2" data-sort="last_learning_at">ìµœê·¼í•™ìŠµ <i class="bi bi-caret-down-fill sort-icon"></i></th>
                            </tr>
                            <tr>
                                <th class="text-center small text-muted">ìŠ¤í¬ë˜ì¹˜</th>
                                <th class="text-center small text-muted">ì—”íŠ¸ë¦¬</th>
                                <th class="text-center small text-muted">ì•±ì¸ë²¤í„°</th>
                                <th class="text-center small text-muted">íŒŒì´ì¬</th>
                                <th class="text-center small text-muted">ë°ì´í„°</th>
                            </tr>
                        </thead>
                        <tbody id="progressTableBody">
                            <!-- ë™ì ìœ¼ë¡œ ë¡œë“œ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- í•™ìƒ ëª©ë¡ íƒ­ -->
        <div class="tab-pane fade <%= typeof currentView !== 'undefined' && currentView === 'list' ? 'show active' : '' %>" id="student-list" role="tabpanel">
            <div class="content-card">
                <div class="table-responsive">
                    <table class="premium-table">
                        <colgroup>
                            <col style="width: 5%;"> <!-- No -->
                            <col style="width: 5%;"> <!-- Profile -->
                            <col style="width: 10%;"> <!-- Name -->
                            <col style="width: 10%;"> <!-- ID -->
                            <col style="width: 20%;"> <!-- Email -->
                            <col style="width: 15%;"> <!-- Join Date -->
                            <col style="width: 15%;"> <!-- Last Access -->
                            <col style="width: 10%;"> <!-- Management -->
                        </colgroup>
                        <thead class="single-line-header">
                            <tr>
                                <th>No.</th>
                                <th>í”„ë¡œí•„</th>
                                <th data-sort="name">ì´ë¦„ <i class="bi bi-caret-down-fill sort-icon"></i></th>
                                <th data-sort="username">ì•„ì´ë”” <i class="bi bi-caret-down-fill sort-icon"></i></th>
                                <th>ì´ë©”ì¼</th>
                                <th data-sort="created_at">ê°€ì…ì¼ <i class="bi bi-caret-down-fill sort-icon"></i></th>
                                <th data-sort="last_access">ìµœê·¼ì ‘ì† <i class="bi bi-caret-down-fill sort-icon"></i></th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            <!-- ë™ì ìœ¼ë¡œ ë¡œë“œ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ì¶œì„ë¶€ íƒ­ -->
        <div class="tab-pane fade <%= typeof currentView !== 'undefined' && currentView === 'attendance' ? 'show active' : '' %>" id="student-attendance" role="tabpanel">
            <div class="content-card" style="min-height: 600px;">
                <div id="attendance-calendar" class="attendance-calendar p-3">
                    <!-- JS renders calendar here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Coming Soon View -->
<div id="coming-soon-view" style="<%= (typeof currentView !== 'undefined' && (currentView === 'class-materials' || currentView === 'career-info')) ? 'display: flex;' : 'display: none;' %> height: 100%; min-height: 600px; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
    <i class="bi bi-cone-striped fs-1 text-muted mb-3"></i>
    <h4 class="text-muted">ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤. ê³§ ë§Œë‚˜ì‹¤ ìˆ˜ ìˆìœ¼ì‹¤ê±°ì—ìš” ^~^/. ê¸°ëŒ€í•´ì£¼ì„¸ìš”</h4>
</div>

<!-- í•™ìƒ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">í•™ìƒ ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="studentForm">
                    <input type="hidden" id="studentId">
                    <div class="mb-3">
                        <label class="form-label">ì•„ì´ë”” <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="userID" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì´ë¦„ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì´ë©”ì¼</label>
                        <input type="email" class="form-control" id="email">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ë¹„ë°€ë²ˆí˜¸ <small class="text-muted">(ìˆ˜ì • ì‹œ ê³µë€ì´ë©´ ë³€ê²½ ì•ˆ í•¨)</small></label>
                        <input type="password" class="form-control" id="password">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì „í™”ë²ˆí˜¸</label>
                        <input type="tel" class="form-control" id="phone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ìƒë…„ì›”ì¼</label>
                        <input type="date" class="form-control" id="birthdate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" id="saveStudentBtn">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<!-- S3 íŒŒì¼ ë¸Œë¼ìš°ì € ëª¨ë‹¬ -->
<div class="modal fade" id="s3BrowserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-body p-0">
                <iframe id="s3BrowserFrame" src="" style="width: 100%; height: 100%; border: none;" frameborder="0"></iframe>
            </div>
        </div>
    </div>
</div>

<!-- Timeline (Portfolio) Browser Modal -->
<div class="modal fade" id="timelineBrowserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="timelineBrowserTitle">í•™ìŠµ íƒ€ì„ë¼ì¸</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" style="background: #f8f9fa;">
                <iframe id="timelineBrowserFrame" src="" style="width: 100%; height: 100%; border: none;" frameborder="0"></iframe>
            </div>
        </div>
    </div>
</div>

<!-- S3 ëª¨ë‹¬ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    // í•™ìƒ S3 í´ë” ì—´ê¸° í•¨ìˆ˜
    function openStudentS3Folder(userID) {
        const iframe = document.getElementById('s3BrowserFrame');
        iframe.src = `/s3/browser?initialPath=users/${encodeURIComponent(userID)}/`;
        const modal = new bootstrap.Modal(document.getElementById('s3BrowserModal'));
        modal.show();
    }

    // ëª¨ë‹¬ì´ ë‹«í ë•Œ iframe src ì´ˆê¸°í™” (ë©”ëª¨ë¦¬ ì ˆì•½)
    document.getElementById('s3BrowserModal').addEventListener('hidden.bs.modal', function () {
        const iframe = document.getElementById('s3BrowserFrame');
        iframe.src = '';
    });
</script>

<!-- Global Popover Container -->
<div id="global-platform-popover"></div>

<!-- Daily Attendance Modal -->
<div class="modal fade" id="dailyAttendanceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="dailyModalTitle">ì¶œì„ í˜„í™©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>í”„ë¡œí•„</th>
                                <th>ì´ë¦„</th>
                                <th>ë“±ì› ì‹œê°„</th>
                            </tr>
                        </thead>
                        <tbody id="dailyModalBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Detail Modal -->
<div class="modal fade" id="studentDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="studentDetailTitle">í•™ìƒ ìƒì„¸ ì •ë³´</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <img src="/resource/profiles/default.webp" id="studentDetailImage" class="rounded-circle mb-2" style="width: 80px; height: 80px; object-fit: cover;">
                    <h4 id="studentDetailName" class="fw-bold mb-0"></h4>
                    <p id="studentDetailId" class="text-muted"></p>
                </div>
                <h6 class="fw-bold border-bottom pb-2 mb-3">ì´ë²ˆ ë‹¬ ì¶œì„ ê¸°ë¡</h6>
                <div id="studentDetailList" class="d-flex flex-column gap-2" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>

<%
}
%>

<%- include('../layouts/board-base-layout', layoutData) %>
