<!-- 학생 관리 페이지 (Button Toggle Layout) -->
<link rel="stylesheet" href="/css/board-layout.css">
<link rel="stylesheet" href="/css/teacher/student-management.css?v=6">

<div class="board-layout-container">
    <!-- 🔥 왼쪽 네비게이션 (Board Style) -->
    <div class="board-sidebar">
        <div class="board-sidebar-header">
            <i class="bi bi-person-video3"></i> 교사 전용 메뉴
        </div>

        <a href="#" class="board-category-item active" id="nav-student-management"
            onclick="StudentManagement.switchMainView('student-management'); return false;">
            <i class="bi bi-people"></i> 학생 관리
        </a>

        <a href="#" class="board-category-item" id="nav-class-materials"
            onclick="StudentManagement.switchMainView('class-materials'); return false;">
            <i class="bi bi-journal-text"></i> 수업 자료
        </a>

        <a href="#" class="board-category-item" id="nav-career-info">
            <i class="bi bi-signpost-split"></i> 진로 진학
        </a>
    </div>

    <!-- 🔥 메인 콘텐츠 -->
    <div class="board-main-content">
        <!-- 1. 학생 관리 뷰 -->
        <div id="student-management-view" style="padding: 24px;">
            <!-- Header Bar -->
            <div class="page-header-bar d-flex justify-content-between align-items-end mb-0 pb-3">
                <!-- Left Group: Title + Tabs -->
                <div class="d-flex align-items-end gap-5">
                    <!-- Title -->
                    <div class="brand-section">
                        <div class="d-flex flex-column">
                            <small class="text-muted fw-bold mb-1" id="page-subtitle" style="font-size: 0.85rem;">학생 관리
                                &gt; 학습 진도</small>
                            <h3 class="page-title mb-0" id="page-main-title">학습 진도</h3>
                        </div>
                        <div class="page-description mt-2">
                            우리 센터 학생들의 목록과 학습 진도를 관리할 수 있습니다.
                        </div>
                    </div>

                    <!-- Tabs (Moved here for alignment with title) -->
                    <div class="header-toggle mb-1">
                        <div class="d-flex gap-2">
                            <button class="apple-toggle-btn active" id="btn-progress"
                                onclick="StudentManagement.switchView('progress')">
                                <i class="bi bi-graph-up-arrow me-2"></i>학습 진도
                            </button>
                            <button class="apple-toggle-btn" id="btn-list"
                                onclick="StudentManagement.switchView('list')">
                                <i class="bi bi-people-fill me-2"></i>학생 목록
                            </button>
                            <button class="apple-toggle-btn" id="btn-attendance"
                                onclick="StudentManagement.switchView('attendance')">
                                <i class="bi bi-calendar-check me-2"></i>출석부
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Group: Controls -->
                <div class="header-controls">
                    <!-- Add Button -->
                    <button class="btn btn-primary rounded-pill btn-sm px-3" id="addStudentBtn" style="display: none;">
                        <i class="bi bi-person-plus me-1"></i> 추가
                    </button>

                    <!-- Search Inputs -->
                    <div class="search-wrapper" id="progressSearchWrapper">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" id="progressSearch" class="form-control" placeholder="학생 이름/아이디 검색..." />
                    </div>

                    <div class="search-wrapper" id="studentSearchWrapper" style="display: none;">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" id="studentSearch" class="form-control" placeholder="학생 이름/아이디 검색..." />
                    </div>

                    <!-- Attendance Controls (Hidden by default) -->
                    <div class="attendance-controls d-flex align-items-center" id="attendanceControls"
                        style="display: none;">
                        <button class="btn btn-outline-secondary btn-sm" onclick="StudentManagement.prevMonth()">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <span class="fw-bold mx-3" id="currentMonthLabel"
                            style="font-size: 1.1rem; min-width: 80px; text-align: center;">2024. 12</span>
                        <button class="btn btn-outline-secondary btn-sm" onclick="StudentManagement.nextMonth()">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content (Tables) -->
            <div class="tab-content" id="studentTabContent">

                <!-- 학습 진도 탭 (Default Visible) -->
                <div class="tab-pane fade show active" id="student-progress" role="tabpanel">
                    <div class="content-card">
                        <div class="table-responsive" id="progressTableWrapper">
                            <table class="premium-table">
                                <colgroup>
                                    <col style="width: 3%;"> <!-- No -->
                                    <col style="width: 6%;"> <!-- Profile (Higher) -->
                                    <col style="width: 6%;"> <!-- CT (Higher) -->
                                    <col style="width: 10%;"> <!-- Name (Lower) -->
                                    <col style="width: 11%;"> <!-- ID (Lower) -->

                                    <!-- Platforms (Total 40%) -->
                                    <col style="width: 8%;"> <!-- Scratch -->
                                    <col style="width: 8%;"> <!-- Entry -->
                                    <col style="width: 8%;"> <!-- AppInv -->
                                    <col style="width: 8%;"> <!-- Python -->
                                    <col style="width: 8%;"> <!-- Data -->

                                    <!-- Right (Total 20%) -->
                                    <col style="width: 10%;"> <!-- Storage (Size + Mgmt) -->
                                    <col style="width: 10%;"> <!-- Last Learning -->
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th rowspan="2">No.</th>
                                        <th rowspan="2">프로필</th>
                                        <th rowspan="2" data-sort="ct_level">CT <i
                                                class="bi bi-caret-down-fill sort-icon"></i>
                                        </th>
                                        <th rowspan="2" data-sort="name">이름 <i
                                                class="bi bi-caret-down-fill sort-icon"></i></th>
                                        <th rowspan="2" data-sort="username">아이디 <i
                                                class="bi bi-caret-down-fill sort-icon"></i>
                                        </th>

                                        <th colspan="5" class="text-center border-bottom">플랫폼별 진도율</th>

                                        <th rowspan="2" data-sort="storage_usage">스토리지 <i
                                                class="bi bi-caret-down-fill sort-icon"></i></th>
                                        <th rowspan="2" data-sort="last_learning_at">최근학습 <i
                                                class="bi bi-caret-down-fill sort-icon"></i></th>
                                    </tr>
                                    <tr>
                                        <th class="text-center small text-muted">스크래치</th>
                                        <th class="text-center small text-muted">엔트리</th>
                                        <th class="text-center small text-muted">앱인벤터</th>
                                        <th class="text-center small text-muted">파이썬</th>
                                        <th class="text-center small text-muted">데이터</th>
                                    </tr>
                                </thead>
                                <tbody id="progressTableBody">
                                    <!-- 동적으로 로드 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 학생 목록 탭 -->
                <div class="tab-pane fade" id="student-list" role="tabpanel">
                    <div class="content-card">
                        <div class="table-responsive">
                            <table class="premium-table">
                                <colgroup>
                                    <col style="width: 5%;"> <!-- No -->
                                    <col style="width: 5%;"> <!-- Profile -->
                                    <col style="width: 10%;"> <!-- Name -->
                                    <col style="width: 10%;"> <!-- ID -->
                                    <col style="width: 20%;"> <!-- Email -->
                                    <col style="width: 15%;"> <!-- Join Date -->
                                    <col style="width: 15%;"> <!-- Last Access -->
                                    <col style="width: 10%;"> <!-- Management -->
                                </colgroup>
                                <thead class="single-line-header">
                                    <tr>
                                        <th>No.</th>
                                        <th>프로필</th>
                                        <th data-sort="name">이름 <i class="bi bi-caret-down-fill sort-icon"></i></th>
                                        <th data-sort="username">아이디 <i class="bi bi-caret-down-fill sort-icon"></i>
                                        </th>
                                        <th>이메일</th>
                                        <th data-sort="created_at">가입일 <i class="bi bi-caret-down-fill sort-icon"></i>
                                        </th>
                                        <th data-sort="last_access">최근접속 <i class="bi bi-caret-down-fill sort-icon"></i>
                                        </th>
                                        <th>관리</th>
                                    </tr>
                                </thead>
                                <tbody id="studentTableBody">
                                    <!-- 동적으로 로드 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="coming-soon-view"
            style="display: none; height: 100%; min-height: 600px; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
            <i class="bi bi-cone-striped fs-1 text-muted mb-3"></i>
            <h4 class="text-muted">준비중입니다. 곧 만나실 수 있으실거에요 ^~^/. 기대해주세요</h4>
        </div>
    </div>
</div>

<!-- 학생 추가/수정 모달 -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">학생 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="studentForm">
                    <input type="hidden" id="studentId">

                    <div class="mb-3">
                        <label class="form-label">아이디 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="userID" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">이름 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">이메일</label>
                        <input type="email" class="form-control" id="email">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">비밀번호 <small class="text-muted">(수정 시 공란이면 변경 안 함)</small></label>
                        <input type="password" class="form-control" id="password">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">전화번호</label>
                        <input type="tel" class="form-control" id="phone">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">생년월일</label>
                        <input type="date" class="form-control" id="birthdate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="saveStudentBtn">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- 🔥 S3 파일 브라우저 모달 -->
<div class="modal fade" id="s3BrowserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-body p-0">
                <iframe id="s3BrowserFrame" src="" style="width: 100%; height: 100%; border: none;" frameborder="0">
                </iframe>
            </div>
        </div>
    </div>
</div>

<!-- 🔥 S3 모달 초기화 스크립트 -->
<script>
    // 학생 S3 폴더 열기 함수
    function openStudentS3Folder(userID) {
        const iframe = document.getElementById('s3BrowserFrame');
        // S3 브라우저에 학생 폴더 경로 전달
        iframe.src = `/s3/browser?initialPath=users/${encodeURIComponent(userID)}/`;
        const modal = new bootstrap.Modal(document.getElementById('s3BrowserModal'));
        modal.show();
    }

    // 모달이 닫힐 때 iframe src 초기화 (메모리 절약)
    document.getElementById('s3BrowserModal').addEventListener('hidden.bs.modal', function () {
        const iframe = document.getElementById('s3BrowserFrame');
        iframe.src = '';
    });
</script>

<!-- Global Popover Container -->
<div id="global-platform-popover"></div>

<!-- 학생 관리 전용 스크립트 -->
<script src="/js/teacher/student-management.js?v=6"></script>