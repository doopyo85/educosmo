<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python 게임 포트폴리오</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .project-card {
            transition: transform 0.3s ease;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        .project-img {
            height: 180px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .upload-zone {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #0d6efd;
            background-color: #e9ecef;
        }
        .project-actions {
            display: flex;
            gap: 8px;
        }
    </style>
</head>
<body>
    <!-- 헤더 포함 -->
    <%- include('partials/header') %>
    
    <div class="container py-5">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-center">Python 게임 포트폴리오</h1>
                <p class="text-center text-muted">나만의 Python 게임 프로젝트를 만들고 공유해보세요!</p>
            </div>
        </div>
        
        <!-- 프로젝트 업로드 영역 -->
        <div class="row mb-5">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">새 프로젝트 업로드</h5>
                        <p class="card-text">Pygame으로 만든 게임 프로젝트를 업로드하세요. main.py 파일과 필요한 리소스를 포함한 ZIP 파일로 업로드해주세요.</p>
                        
                        <div id="uploadZone" class="upload-zone mb-3">
                            <i class="bi bi-cloud-upload fs-1 text-primary"></i>
                            <h5 class="mt-3">여기에 ZIP 파일을 드래그하거나 클릭하세요</h5>
                            <p class="text-muted small">최대 파일 크기: 10MB</p>
                            <input type="file" id="projectFile" accept=".zip" class="d-none">
                        </div>
                        
                        <div id="uploadInfo" class="d-none mb-3">
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                <div>
                                    <span id="fileName"></span> (<span id="fileSize"></span>)
                                </div>
                                <button type="button" id="removeFile" class="btn-close ms-auto"></button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="projectName" class="form-label">프로젝트 이름</label>
                            <input type="text" class="form-control" id="projectName" placeholder="프로젝트 이름을 입력하세요">
                        </div>
                        
                        <div class="mb-3">
                            <label for="projectDesc" class="form-label">프로젝트 설명</label>
                            <textarea class="form-control" id="projectDesc" rows="3" placeholder="게임에 대한 간단한 설명을 작성하세요"></textarea>
                        </div>
                        
                        <button id="uploadBtn" class="btn btn-primary">업로드</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 프로젝트 목록 -->
        <div class="row mb-4">
            <div class="col-12">
                <h2>내 프로젝트</h2>
            </div>
        </div>
        
        <div class="row" id="projectList">
            <!-- 샘플 프로젝트: QwerFighter -->
            <div class="col-md-4 mb-4">
                <div class="card project-card h-100">
                    <div class="project-img" style="background-image: url('/resource/pygame-default.png');"></div>
                    <div class="card-body">
                        <h5 class="card-title">QwerFighter</h5>
                        <p class="card-text">간단한 슈팅 게임 데모입니다. Pygame을 활용한 예제 프로젝트입니다.</p>
                    </div>
                    <div class="card-footer">
                        <div class="project-actions">
                            <button class="btn btn-primary" onclick="location.href='/portfolio/run/qwerfighter'">
                                <i class="bi bi-play-fill"></i> 실행
                            </button>
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="bi bi-pin-angle-fill"></i> 샘플
                            </button>
                        </div>
                    </div>
                </div>
            </div>
           
            <!-- 프로젝트 목록은 JavaScript로 동적 생성됩니다 -->
        </div>
    </div>
    
    <!-- 로딩 모달 -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">로딩 중...</span>
                    </div>
                    <h5 id="loadingMessage">처리 중...</h5>
                    <p class="text-muted small mt-2" id="loadingDetail">잠시만 기다려주세요.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 확인 모달 -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">확인</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmMessage">
                    정말 삭제하시겠습니까?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-danger" id="confirmAction">삭제</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOM 요소
        const uploadZone = document.getElementById('uploadZone');
        const projectFile = document.getElementById('projectFile');
        const uploadInfo = document.getElementById('uploadInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removeFile = document.getElementById('removeFile');
        const projectName = document.getElementById('projectName');
        const projectDesc = document.getElementById('projectDesc');
        const uploadBtn = document.getElementById('uploadBtn');
        const projectList = document.getElementById('projectList');
        
        // 로딩 모달
        const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        const loadingMessage = document.getElementById('loadingMessage');
        const loadingDetail = document.getElementById('loadingDetail');
        
        // 확인 모달
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmAction = document.getElementById('confirmAction');
        
        // 페이지 로드 시 프로젝트 목록 가져오기
        document.addEventListener('DOMContentLoaded', function() {
            loadProjects();
            setupUploadListeners();
        });
        
        // 업로드 영역 이벤트 리스너 설정
        function setupUploadListeners() {
            // 파일 선택 다이얼로그 열기
            uploadZone.addEventListener('click', () => projectFile.click());
            
            // 드래그 앤 드롭 이벤트
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });
            
            // 파일 선택 이벤트
            projectFile.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFileSelect(e.target.files[0]);
                }
            });
            
            // 파일 제거 버튼
            removeFile.addEventListener('click', () => {
                projectFile.value = '';
                uploadInfo.classList.add('d-none');
                uploadZone.classList.remove('d-none');
            });
            
            // 업로드 버튼
            uploadBtn.addEventListener('click', uploadProject);
        }
        
        // 파일 선택 처리
        function handleFileSelect(file) {
            // ZIP 파일 유효성 검사
            if (!file.name.toLowerCase().endsWith('.zip')) {
                alert('ZIP 파일만 업로드할 수 있습니다.');
                return;
            }
            
            // 파일 크기 제한 (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('파일 크기는 10MB 이하여야 합니다.');
                return;
            }
            
            // 선택한 파일 정보 표시
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            uploadInfo.classList.remove('d-none');
            uploadZone.classList.add('d-none');
            
            // 프로젝트 이름 자동 설정 (파일명에서 .zip 제외)
            if (!projectName.value) {
                projectName.value = file.name.replace('.zip', '');
            }
        }
        
        // 파일 크기 포맷팅
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        // 프로젝트 업로드
        function uploadProject() {
            // 유효성 검사
            if (!projectFile.files.length) {
                alert('ZIP 파일을 선택해주세요.');
                return;
            }
            
            if (!projectName.value.trim()) {
                alert('프로젝트 이름을 입력해주세요.');
                projectName.focus();
                return;
            }
            
            // FormData 객체 생성
            const formData = new FormData();
            formData.append('projectFile', projectFile.files[0]);
            formData.append('projectName', projectName.value.trim());
            formData.append('projectDesc', projectDesc.value.trim());
            
            // 로딩 모달 표시
            loadingMessage.textContent = '프로젝트 업로드 중...';
            loadingDetail.textContent = '파일을 서버에 업로드하고 있습니다. 잠시만 기다려주세요.';
            loadingModal.show();
            
            // 서버로 전송
            fetch('/api/portfolio/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loadingModal.hide();
                
                if (data.success) {
                    alert('프로젝트가 성공적으로 업로드되었습니다.');
                    resetUploadForm();
                    loadProjects();
                } else {
                    alert('업로드 실패: ' + data.message);
                }
            })
            .catch(error => {
                loadingModal.hide();
                console.error('Error:', error);
                alert('업로드 중 오류가 발생했습니다.');
            });
        }
        
        // 업로드 폼 초기화
        function resetUploadForm() {
            projectFile.value = '';
            projectName.value = '';
            projectDesc.value = '';
            uploadInfo.classList.add('d-none');
            uploadZone.classList.remove('d-none');
        }
        
        // 프로젝트 목록 로드
        function loadProjects() {
            fetch('/api/portfolio/projects')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderProjects(data.projects);
                } else {
                    console.error('프로젝트 로드 실패:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // 프로젝트 목록 렌더링
        function renderProjects(projects) {
            // 기존 샘플 프로젝트 HTML 저장
            const sampleProjectHTML = projectList.children[0].outerHTML;
            
            // 프로젝트 목록 초기화 (샘플 프로젝트 유지)
            projectList.innerHTML = sampleProjectHTML;
            
            // 사용자 프로젝트 추가
            if (projects && projects.length > 0) {
                projects.forEach(project => {
                    const projectElement = document.createElement('div');
                    projectElement.className = 'col-md-4 mb-4';
                    projectElement.innerHTML = `
                        <div class="card project-card h-100">
                            <div class="project-img" style="background-image: url('${project.thumbnail || '/resource/pygame-default.png'}');"></div>
                            <div class="card-body">
                                <h5 class="card-title">${project.name}</h5>
                                <p class="card-text">${project.description || '설명이 없습니다.'}</p>
                            </div>
                            <div class="card-footer">
                                <div class="project-actions">
                                    <button class="btn btn-primary" onclick="runProject('${project.id}')">
                                        <i class="bi bi-play-fill"></i> 실행
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="confirmDelete('${project.id}', '${project.name}')">
                                        <i class="bi bi-trash"></i> 삭제
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    projectList.appendChild(projectElement);
                });
            }
        }
        
        // 프로젝트 실행
        function runProject(projectId) {
            loadingMessage.textContent = '게임 실행 준비 중...';
            loadingDetail.textContent = '게임 환경을 구성하고 있습니다. 잠시만 기다려주세요.';
            loadingModal.show();
            
            fetch(`/portfolio/run/${projectId}`)
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else {
                        return response.json();
                    }
                })
                .then(data => {
                    if (data && data.error) {
                        loadingModal.hide();
                        alert('실행 오류: ' + data.error);
                    }
                })
                .catch(error => {
                    loadingModal.hide();
                    console.error('Error:', error);
                    alert('게임 실행 중 오류가 발생했습니다.');
                });
        }
        
        // 삭제 확인
        function confirmDelete(projectId, projectName) {
            confirmMessage.textContent = `"${projectName}" 프로젝트를 삭제하시겠습니까?`;
            
            confirmAction.onclick = () => {
                deleteProject(projectId);
                confirmModal.hide();
            };
            
            confirmModal.show();
        }
        
        // 프로젝트 삭제
        function deleteProject(projectId) {
            loadingMessage.textContent = '프로젝트 삭제 중...';
            loadingDetail.textContent = '프로젝트 파일을 삭제하고 있습니다.';
            loadingModal.show();
            
            fetch(`/api/portfolio/delete/${projectId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                loadingModal.hide();
                
                if (data.success) {
                    alert('프로젝트가 삭제되었습니다.');
                    loadProjects();
                } else {
                    alert('삭제 실패: ' + data.message);
                }
            })
            .catch(error => {
                loadingModal.hide();
                console.error('Error:', error);
                alert('삭제 중 오류가 발생했습니다.');
            });
        }
    </script>
    
    <!-- 푸터 포함 -->
    <%- include('partials/footer') %>
</body>
</html>