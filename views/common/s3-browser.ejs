<!-- S3 ë¸Œë¼ìš°ì € ëª¨ë‹¬ (í†µí•© ë²„ì „) -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
    
    <!-- S3 Browser CSS -->
    <link rel="stylesheet" href="/css/admin/s3-browser.css">
</head>
<body>
    <!-- í†µí•© í—¤ë” -->
    <div class="">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div>
                    <h5 class="mb-1">
                        <i class="bi bi-folder-open me-2"></i>
                        <% if (role === 'admin') { %>
                            S3 íŒŒì¼ ê´€ë¦¬ (ì „ì²´)
                        <% } else if (role === 'teacher' || role === 'manager') { %>
                            í•™ìƒ íŒŒì¼ ê´€ë¦¬ (ì„¼í„° <%= centerID %>)
                        <% } else { %>
                            ë‚´ íŒŒì¼ ê´€ë¦¬
                        <% } %>
                    </h5>
                    <p class="text-muted mb-0 small">
                        <% if (role === 'admin') { %>
                            ëª¨ë“  ì‚¬ìš©ìì˜ ì €ì¥ íŒŒì¼ì„ ì¡°íšŒí•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        <% } else if (role === 'teacher' || role === 'manager') { %>
                            ì†Œì† í•™ìƒë“¤ì˜ ì €ì¥ íŒŒì¼ì„ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        <% } else { %>
                            ë‚˜ì˜ ì €ì¥ íŒŒì¼ì„ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        <% } %>
                    </p>
                </div>
            </div>

            <div class="d-flex align-items-center gap-3">
                <!-- ê¶Œí•œ ë°°ì§€ -->
                <div>
                    <% if (role === 'admin') { %>
                        <span class="badge bg-danger">Admin</span>
                        <span class="badge bg-secondary">ì „ì²´ ì ‘ê·¼</span>
                    <% } else if (role === 'teacher' || role === 'manager') { %>
                        <span class="badge bg-success"><%= role %></span>
                        <span class="badge bg-info">ì„¼í„° ID: <%= centerID %></span>
                    <% } else { %>
                        <span class="badge bg-primary"><%= role %></span>
                        <span class="badge bg-secondary">ê°œì¸</span>
                    <% } %>
                </div>
                <button type="button" class="btn-close-custom" onclick="closeS3Browser()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- S3 ë¸Œë¼ìš°ì € ì»¨í…Œì´ë„ˆ -->
    <div id="s3-browser"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/components/S3Explorer.js"></script>

    <!-- ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        (function() {
            console.log('ğŸš€ S3 Browser ì´ˆê¸°í™” ì‹œì‘...');

            const role = '<%= role %>';
            const userID = '<%= userID %>';
            const scope = '<%= scope %>';

            // ì—­í• ë³„ ë£¨íŠ¸ ê²½ë¡œ ì„¤ì •
            let rootPath = '';
            if (role === 'admin') {
                rootPath = '';
            } else if (role === 'teacher' || role === 'manager') {
                rootPath = 'users/';
            } else if (role === 'student') {
                rootPath = `users/${userID}/`; // âœ… í•™ìƒì€ ë³¸ì¸ í´ë”ì—ì„œ ì‹œì‘
            }

            // ğŸ”¥ ì—­í• ë³„ ì—…ë¡œë“œ ê¶Œí•œ ì„¤ì •
            let enableUpload = false;
            if (role === 'admin') {
                enableUpload = true;  // Adminì€ ëª¨ë“  ê³³ì— ì—…ë¡œë“œ ê°€ëŠ¥
            } else if (role === 'teacher' || role === 'manager') {
                enableUpload = true;  // Teacher/ManagerëŠ” í•™ìƒ í´ë”ì— ì—…ë¡œë“œ ê°€ëŠ¥
            } else if (role === 'student') {
                enableUpload = true;  // StudentëŠ” ë³¸ì¸ í´ë”ì— ì—…ë¡œë“œ ê°€ëŠ¥
            }

            window.s3Explorer = new S3Explorer({
                containerId: 's3-browser',
                apiEndpoint: '/api/s3/browse',
                scope: scope,
                rootPath: rootPath,
                userID: userID,        // âœ… ë°˜ë“œì‹œ ì „ë‹¬
                userRole: role,        // âœ… ì—­í•  ì „ë‹¬
                allowedPlatforms: ['scratch', 'entry', 'gallery', 'portfolio'],
                enableUpload: enableUpload,  // ğŸ”¥ ì—­í• ë³„ ì—…ë¡œë“œ ê¶Œí•œ
                enableDelete: <%= enableDelete %>,
                enablePreview: true,
                onFolderOpen: function(path) {
                    console.log('ğŸ“‚ í´ë” ì—´ë¦¼:', path);
                },
                onFileSelect: function(file) {
                    console.log('ğŸ“„ íŒŒì¼ ì„ íƒ:', file);
                },
                onError: function(error) {
                    console.error('âŒ ì˜¤ë¥˜ ë°œìƒ:', error);
                    showModalNotification('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
                }
            });

            console.log('âœ… S3 Browser ì´ˆê¸°í™” ì™„ë£Œ');

            function showModalNotification(message, type = 'info') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.style.cssText = 'position: absolute; top: 10px; right: 10px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 5000);
            }

            window.showModalNotification = showModalNotification;
        })();

        function closeS3Browser() {
            // ğŸ”¥ index.ejsë¡œ ëŒì•„ê°€ê¸° (ë¡œê·¸ì¸ í˜ì´ì§€ ì•„ë‹˜)
            if (window.parent !== window) {
                // ëª¨ë‹¬ë¡œ ì—´ë ¸ì„ ê²½ìš°
                const modal = window.parent.bootstrap.Modal.getInstance(
                    window.parent.document.getElementById('s3BrowserModal')
                );
                if (modal) {
                    modal.hide();
                    // ëª¨ë‹¬ ë‹«íŒ í›„ index.ejsë¡œ ì´ë™
                    setTimeout(() => {
                        window.parent.location.href = '/';
                    }, 300);
                } else {
                    window.parent.location.href = '/';
                }
            } else {
                // ì¼ë°˜ í˜ì´ì§€ë¡œ ì—´ë ¸ì„ ê²½ìš° ë°”ë¡œ index.ejsë¡œ ì´ë™
                window.location.href = '/';
            }
        }
    </script>

    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; background: #fff; }
        .s3-browser-header { flex-shrink: 0; background: #f1f3f5; padding: 20px 30px; border-bottom: 2px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .s3-browser-header h5 { font-size: 1.5rem; font-weight: 700; color: #212529; margin: 0; }
        .s3-browser-header .text-muted { color: #6c757d !important; font-size: 0.9rem; }
        .btn-close-custom { width: 36px; height: 36px; border: none; background: #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-close-custom:hover { background: #dc3545; transform: scale(1.05); box-shadow: 0 4px 8px rgba(220,53,69,0.3); }
        .btn-close-custom:hover i { color: white; }
        .btn-close-custom i { font-size: 18px; color: #495057; transition: color 0.2s ease; }
        #s3-browser { flex: 1; padding: 25px; overflow-y: auto; background: #f8f9fa; }
        .badge { font-size: 0.75rem; padding: 0.4em 0.8em; font-weight: 600; border-radius: 6px; letter-spacing: 0.3px; }
        #s3-browser::-webkit-scrollbar { width: 10px; }
        #s3-browser::-webkit-scrollbar-track { background: #e9ecef; border-radius: 5px; }
        #s3-browser::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 5px; }
        #s3-browser::-webkit-scrollbar-thumb:hover { background: #868e96; }
    </style>
</body>
</html>
