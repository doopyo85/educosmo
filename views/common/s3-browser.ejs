<!-- S3 ë¸Œë¼ìš°ì € ëª¨ë‹¬ (í†µí•© ë²„ì „) -->
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">

    <!-- S3 Browser CSS -->
    <!-- S3 Browser CSS -->
    <link rel="stylesheet" href="/css/admin/s3-browser.css">
    <!-- Teacher Board Layout CSS -->
    <link rel="stylesheet" href="/css/board-layout.css">
</head>

<body>
    <!-- ê³µí†µ í—¤ë” í¬í•¨ -->
    <%- include('../partials/header') %>

        <% if (role==='teacher' || role==='manager' ) { %>
            <div class="board-layout-container">
                <!-- ğŸ”¥ ì™¼ìª½ ë„¤ë¹„ê²Œì´ì…˜ (Shared Sidebar) -->
                <div class="board-sidebar">
                    <div class="board-sidebar-header">
                        <i class="bi bi-person-video3"></i> êµì‚¬ ì „ìš© ë©”ë‰´
                    </div>

                    <!-- í•™ìƒ ê´€ë¦¬ -->
                    <div class="board-nav-group mb-2">
                        <div class="board-category-item text-dark fw-bold" style="cursor: default; background: none;">
                            <i class="bi bi-people me-2"></i> í•™ìƒ ê´€ë¦¬
                        </div>
                        <div class="d-flex flex-column gap-1">
                            <a href="/teacher/student-management/progress" class="board-category-item ps-5 py-2"
                                style="border-radius: 0 20px 20px 0; font-size: 0.9rem;">
                                í•™ìŠµ ì§„ë„
                            </a>
                            <a href="/teacher/student-management/list" class="board-category-item ps-5 py-2"
                                style="border-radius: 0 20px 20px 0; font-size: 0.9rem;">
                                í•™ìƒ ëª©ë¡
                            </a>
                            <a href="/teacher/student-management/attendance" class="board-category-item ps-5 py-2"
                                style="border-radius: 0 20px 20px 0; font-size: 0.9rem;">
                                ì¶œì„ë¶€
                            </a>
                        </div>
                    </div>

                    <a href="/teacher/class-materials" class="board-category-item">
                        <i class="bi bi-journal-text"></i> ìˆ˜ì—… ìë£Œ
                    </a>

                    <!-- ğŸ”¥ Active File Manager -->
                    <a href="/s3/student-files" class="board-category-item active">
                        <i class="bi bi-folder2-open"></i> í•™ìƒ íŒŒì¼
                    </a>

                    <a href="/teacher/career-info" class="board-category-item">
                        <i class="bi bi-signpost-split"></i> ì§„ë¡œ ì§„í•™
                    </a>
                </div>

                <!-- ğŸ”¥ ë©”ì¸ ì½˜í…ì¸  (Wrapped) -->
                <div class="board-main-content p-0 d-flex flex-column">
                    <!-- í†µí•© í—¤ë” (í˜ì´ì§€ íƒ€ì´í‹€ ë°”) -->
                    <div class="s3-browser-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div>
                                    <h5 class="mb-1">
                                        <i class="bi bi-folder-open me-2"></i>
                                        í•™ìƒ íŒŒì¼ ê´€ë¦¬ (ì„¼í„° <%= centerID %>)
                                    </h5>
                                    <p class="text-muted mb-0 small">
                                        ì†Œì† í•™ìƒë“¤ì˜ ì €ì¥ íŒŒì¼ì„ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                    </p>
                                </div>
                            </div>

                            <div class="d-flex align-items-center gap-3">
                                <span class="badge bg-success">
                                    <%= role %>
                                </span>
                                <span class="badge bg-info">ì„¼í„° ID: <%= centerID %></span>
                            </div>
                        </div>
                    </div>

                    <!-- S3 ë¸Œë¼ìš°ì € ì»¨í…Œì´ë„ˆ -->
                    <div id="s3-browser" style="flex: 1;"></div>
                </div>
            </div>
            <% } else { %>
                <!-- í†µí•© í—¤ë” (í˜ì´ì§€ íƒ€ì´í‹€ ë°”) - Regular View -->
                <div class="s3-browser-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div>
                                <h5 class="mb-1">
                                    <i class="bi bi-folder-open me-2"></i>
                                    <% if (role==='admin' ) { %>
                                        S3 íŒŒì¼ ê´€ë¦¬ (ì „ì²´)
                                        <% } else { %>
                                            ë‚´ íŒŒì¼ ê´€ë¦¬
                                            <% } %>
                                </h5>
                                <p class="text-muted mb-0 small">
                                    <% if (role==='admin' ) { %>
                                        ëª¨ë“  ì‚¬ìš©ìì˜ ì €ì¥ íŒŒì¼ì„ ì¡°íšŒí•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                        <% } else { %>
                                            ë‚˜ì˜ ì €ì¥ íŒŒì¼ì„ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                            <% } %>
                                </p>
                            </div>
                        </div>

                        <div class="d-flex align-items-center gap-3">
                            <div>
                                <% if (role==='admin' ) { %>
                                    <span class="badge bg-danger">Admin</span>
                                    <span class="badge bg-secondary">ì „ì²´ ì ‘ê·¼</span>
                                    <% } else { %>
                                        <span class="badge bg-primary">
                                            <%= role %>
                                        </span>
                                        <span class="badge bg-secondary">ê°œì¸</span>
                                        <% } %>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- S3 ë¸Œë¼ìš°ì € ì»¨í…Œì´ë„ˆ -->
                <div id="s3-browser"></div>
                <% } %>

                    <!-- Bootstrap JS -->
                    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
                    <script src="/js/components/S3Explorer.js"></script>

                    <!-- ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
                    <script>
                        (function () {
                            console.log('ğŸš€ S3 Browser ì´ˆê¸°í™” ì‹œì‘...');

                            const role = '<%= role %>';
                            const userID = '<%= userID %>';
                            const scope = '<%= scope %>';

                            const initialPath = '<%= typeof initialPath !== "undefined" ? initialPath : "" %>'; // ğŸ”¥ ì´ˆê¸° ê²½ë¡œ
                            const s3AssetUrl = '<%= typeof s3AssetUrl !== "undefined" ? s3AssetUrl : "" %>'; // ğŸ”¥ NCP Asset URL

                            // ì—­í• ë³„ ë£¨íŠ¸ ê²½ë¡œ ì„¤ì •
                            let rootPath = '';
                            if (initialPath) {
                                rootPath = initialPath; // ğŸ”¥ ì´ˆê¸° ê²½ë¡œê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©
                            } else if (role === 'admin') {
                                rootPath = '';
                            } else if (role === 'teacher' || role === 'manager') {
                                rootPath = 'users/';
                            } else if (role === 'student') {
                                rootPath = `users/${userID}/`; // âœ… í•™ìƒì€ ë³¸ì¸ í´ë”ì—ì„œ ì‹œì‘
                            }

                            console.log('ğŸ“ Initial Path:', rootPath);

                            // ğŸ”¥ ì—­í• ë³„ ì—…ë¡œë“œ ê¶Œí•œ ì„¤ì •
                            let enableUpload = false;
                            if (role === 'admin') {
                                enableUpload = true;  // Adminì€ ëª¨ë“  ê³³ì— ì—…ë¡œë“œ ê°€ëŠ¥
                            } else if (role === 'teacher' || role === 'manager') {
                                enableUpload = true;  // Teacher/ManagerëŠ” í•™ìƒ í´ë”ì— ì—…ë¡œë“œ ê°€ëŠ¥
                            } else if (role === 'student') {
                                enableUpload = true;  // StudentëŠ” ë³¸ì¸ í´ë”ì— ì—…ë¡œë“œ ê°€ëŠ¥
                            }

                            window.s3Explorer = new S3Explorer({
                                containerId: 's3-browser',
                                apiEndpoint: '/api/s3/browse',
                                scope: scope,
                                rootPath: rootPath,
                                s3AssetUrl: s3AssetUrl, // ğŸ”¥ NCP Asset URL ì „ë‹¬
                                userID: userID,        // âœ… ë°˜ë“œì‹œ ì „ë‹¬
                                userRole: role,        // âœ… ì—­í•  ì „ë‹¬
                                allowedPlatforms: ['scratch', 'entry', 'gallery', 'portfolio'],
                                enableUpload: enableUpload,  // ğŸ”¥ ì—­í• ë³„ ì—…ë¡œë“œ ê¶Œí•œ
                                enableDelete: <%= enableDelete %>,
                                enablePreview: true,
                                onError: function (error) {
                                    console.error('âŒ ì˜¤ë¥˜ ë°œìƒ:', error);
                                    showModalNotification('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
                                }
            });

                        console.log('âœ… S3 Browser ì´ˆê¸°í™” ì™„ë£Œ');

                        function showModalNotification(message, type = 'info') {
                            const alertDiv = document.createElement('div');
                            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                            alertDiv.style.cssText = 'position: absolute; top: 10px; right: 10px; z-index: 9999; min-width: 300px;';
                            alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                            document.body.appendChild(alertDiv);
                            setTimeout(() => alertDiv.remove(), 5000);
                        }

                        window.showModalNotification = showModalNotification;
        }) ();
                    </script>

                    <style>
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
                            display: flex;
                            flex-direction: column;
                            height: 100vh;
                            background: #fff;
                        }

                        .s3-browser-header {
                            flex-shrink: 0;
                            background: #f1f3f5;
                            padding: 15px 25px;
                        }

                        .s3-browser-header h5 {
                            font-size: 1.5rem;
                            font-weight: 700;
                            color: #212529;
                            margin: 0;
                        }

                        .s3-browser-header .text-muted {
                            color: #6c757d !important;
                            font-size: 0.9rem;
                        }

                        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ Style (Full Stretch) */
                        #s3-browser {
                            flex: 1;
                            padding: 20px;
                            overflow: hidden;
                            background: #f8f9fa;
                            display: flex;
                            flex-direction: column;
                        }

                        /* S3Wrapper ê°•ì œ ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ */
                        .s3-browser-wrapper {
                            height: 100% !important;
                            width: 100% !important;
                            border: none !important;
                            /* ğŸ”¥ ì´ì¤‘ í…Œë‘ë¦¬ ì œê±° */
                            border-radius: 0 !important;
                            box-shadow: none !important;
                            /* ğŸ”¥ ê·¸ë¦¼ì ì œê±° */
                        }

                        .badge {
                            font-size: 0.75rem;
                            padding: 0.4em 0.8em;
                            font-weight: 600;
                            border-radius: 6px;
                            letter-spacing: 0.3px;
                        }

                        #s3-browser::-webkit-scrollbar {
                            width: 10px;
                        }

                        #s3-browser::-webkit-scrollbar-track {
                            background: #e9ecef;
                            border-radius: 5px;
                        }

                        #s3-browser::-webkit-scrollbar-thumb {
                            background: #adb5bd;
                            border-radius: 5px;
                        }

                        #s3-browser::-webkit-scrollbar-thumb:hover {
                            background: #868e96;
                        }
                    </style>
</body>

</html>