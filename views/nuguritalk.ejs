<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼í•´ë¼ ë„ˆêµ¬ë¦¬ - ì½”ë”©ì•¤í”Œë ˆì´</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/board.css">
    <script src="https://apis.google.com/js/api.js"></script>
</head>

<body>
    <!-- ê³µí†µ í—¤ë” í¬í•¨ -->
    <%- include('partials/header') %>

    <!-- íƒ€ì´í‹€ & ì†Œì œëª© -->
    <div class="container-fluid text-center mt-4">
        <h1 class="fw-bold">ì¼í•´ë¼ ë„ˆêµ¬ë¦¬</h1>
        <h5 class="chat-subtitle">í•„ìš”í•œ ê²ƒì„ ì—¬ê¸°ì— ë‚¨ê¸°ë©´, ë„ˆêµ¬ë¦¬ê°€ ë§Œë“­ë‹ˆë‹¤.</h5>
    </div>

    <div class="container mt-4">
        <div class="row">
            <!-- ğŸ“Œ ì™¼ìª½ ì±„íŒ… ì»¨í…Œì´ë„ˆ (50%) -->
            <div class="col-lg-6 col-md-6">
                <main class="direct-message">
                    <div class="messages" id="chat-box">
                        <% if (messages && messages.length > 0) { %>
                            <% messages.forEach(message => { %>
                                <div class="message-container">
                                    <div class="profile-wrapper">
                                        <img src="/resource/co.ico" class="favicon">
                                    </div>
                                    <div class="message-content">
                                        <div class="message-header">
                                            <span class="message-author"><%= message.author_name || message.author %></span>
                                            <span class="message-time"><%= message.created_at %></span>
                                        </div>
                                        <div class="message-bubble">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                                <p style="margin: 0; padding-right: 16px;"><%= message.title %></p>
                                                <% if (message.canDelete) { %>
                                                    <a href="/nuguritalk/delete/<%= message.id %>" class="delete-btn" style="color: inherit; text-decoration: none; position: absolute; right: 8px; top: 8px;">
                                                        <i class="bi bi-x"></i>
                                                    </a>
                                                <% } %>
                                            </div>
                                            <% if (message.image) { %>
                                                <div class="message-image mt-2">
                                                    <img src="<%= message.image %>" alt="ì²¨ë¶€ ì´ë¯¸ì§€" style="max-width: 200px; border-radius: 8px;">
                                                </div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="text-center text-muted p-4">
                                <i class="bi bi-chat-dots" style="font-size: 48px; opacity: 0.3;"></i>
                                <p class="mt-2">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
                            </div>
                        <% } %>
                    </div>
                    
                    <!-- ğŸ”¥ ì…ë ¥ì°½ -->
                    <div class="new">
                        <textarea class="new-input" id="chat-input" placeholder="í•œë§ˆë””ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 50ì)" maxlength="50"></textarea>
                        <button type="submit" class="material-button" id="send-btn">
                            <i class="bi bi-send" aria-hidden="true"></i>
                            <span class="screen-reader-text">ë³´ë‚´ê¸°</span>
                        </button>
                    </div>
                </main>
            </div>

            <!-- ğŸ“Œ ì˜¤ë¥¸ìª½ ì—…ë¬´ ì»¨í…Œì´ë„ˆ (50%) -->
            <% 
                const images = [
                    { src: "sleep_nuguri.webp", text: "ìëŠ” ì¤‘..." },
                    { src: "coffee_nuguri.webp", text: "ì»¤í”¼ ë§ˆì‹œëŠ” ì¤‘..." },
                    { src: "coding_nuguri.webp", text: "ì½”ë”© í•˜ëŠ” ì¤‘..." }
                ];
                const randomImage = images[Math.floor(Math.random() * images.length)];
            %>

            <div class="col-lg-6 col-md-6">
                <div class="task-container">
                    <div class="text-center position-relative">
                        <img src="/resource/<%= randomImage.src %>" alt="ë„ˆêµ¬ë¦¬" class="naguri-img">
                        <div class="speech-bubble"><%= randomImage.text %></div>
                    </div>
                    <h4 class="mt-3">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì—…ë¬´</h4>
                    <div id="task-list">
                        <div class="task-item">
                            <div class="task-status">ğŸ”„</div>
                            <div class="task-content">
                                <h6>ê²Œì‹œíŒ ì‹œìŠ¤í…œ ê°œë°œ</h6>
                                <p>í´ë¦¬ì•™ ìŠ¤íƒ€ì¼ ê²Œì‹œíŒ êµ¬í˜„ ì¤‘...</p>
                                <small class="text-muted">ì§„í–‰ë¥ : 95%</small>
                            </div>
                        </div>
                        <div class="task-item">
                            <div class="task-status">â°</div>
                            <div class="task-content">
                                <h6>ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”</h6>
                                <p>ì¸ë±ìŠ¤ ì¶”ê°€ ë° ì¿¼ë¦¬ ìµœì í™” ì˜ˆì •</p>
                                <small class="text-muted">ëŒ€ê¸° ì¤‘</small>
                            </div>
                        </div>
                        <div class="task-item">
                            <div class="task-status">âœ…</div>
                            <div class="task-content">
                                <h6>ë¼ìš°í„° ë¶„ë¦¬ ì‘ì—…</h6>
                                <p>ê²Œì‹œíŒê³¼ ë„ˆêµ¬ë¦¬í†¡ ë¼ìš°í„° ë¶„ë¦¬ ì™„ë£Œ</p>
                                <small class="text-muted">ì™„ë£Œ</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/header.js"></script>
    <script>
        /**
         * ë„ˆêµ¬ë¦¬í†¡ ì „ìš© í´ë¼ì´ì–¸íŠ¸ ìŠ¤í¬ë¦½íŠ¸
         */
        
        // DOMì´ ë¡œë“œëœ í›„ ì‹¤í–‰
        document.addEventListener("DOMContentLoaded", function() {
            console.log("ë„ˆêµ¬ë¦¬í†¡ í´ë¼ì´ì–¸íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨");
            
            // ë©”ì‹œì§€ ì „ì†¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
            const sendBtn = document.getElementById("send-btn");
            if (sendBtn) {
                sendBtn.addEventListener("click", sendMessage);
            }
            
            // ì…ë ¥ í•„ë“œ ì—”í„°í‚¤ ì´ë²¤íŠ¸ ì—°ê²°
            const chatInput = document.getElementById("chat-input");
            if (chatInput) {
                chatInput.addEventListener("keypress", function(event) {
                    if (event.key === "Enter" && !event.shiftKey) {
                        event.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            // ì‚­ì œ ë²„íŠ¼ë“¤ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            setupDeleteButtons();
        });

        // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
        function setupDeleteButtons() {
            const deleteButtons = document.querySelectorAll('.delete-btn');
            console.log("ì‚­ì œ ë²„íŠ¼ ê°œìˆ˜:", deleteButtons.length);
            
            deleteButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    
                    if (confirm('ì´ ë©”ì‹œì§€ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        const deleteUrl = this.getAttribute('href');
                        console.log("ì‚­ì œ URL:", deleteUrl);
                        
                        // AJAXë¡œ ì‚­ì œ ìš”ì²­ ë³´ë‚´ê¸°
                        fetch(deleteUrl, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => {
                            console.log("ì‚­ì œ ì‘ë‹µ:", response.status);
                            if (response.ok) {
                                // ì‚­ì œ ì„±ê³µ ì‹œ í™”ë©´ì—ì„œ ë©”ì‹œì§€ ìš”ì†Œ ì œê±°
                                const messageContainer = this.closest('.message-container');
                                if (messageContainer) {
                                    messageContainer.remove();
                                } else {
                                    // ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                                    location.reload();
                                }
                            } else if (response.status === 403) {
                                alert('ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                            } else {
                                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                                console.error('ì‚­ì œ ì‹¤íŒ¨:', response.status);
                            }
                        })
                        .catch(error => {
                            console.error('ì‚­ì œ ìš”ì²­ ì˜¤ë¥˜:', error);
                            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        });
                    }
                });
            });
        }

        // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
        async function sendMessage() {
            const inputField = document.getElementById("chat-input");
            const message = inputField.value.trim();
            if (!message) return;

            console.log("ë©”ì‹œì§€ ì „ì†¡ ì‹œë„:", message);

            try {
                const response = await fetch("/nuguritalk/write", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ title: message })
                });

                console.log("ë©”ì‹œì§€ ì „ì†¡ ì‘ë‹µ ìƒíƒœ:", response.status);

                // ì‘ë‹µì´ JSONì¸ì§€ í™•ì¸
                const contentType = response.headers.get("content-type");
                const isJson = contentType && contentType.includes("application/json");
                console.log("ì‘ë‹µ ì½˜í…ì¸  íƒ€ì…:", contentType);

                if (response.status === 403) {
                    if (isJson) {
                        const data = await response.json();
                        alert(data.error || "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    } else {
                        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    }
                    return;
                }

                if (!response.ok) {
                    if (isJson) {
                        const data = await response.json();
                        alert(data.error || "ë©”ì‹œì§€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
                    } else {
                        alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
                    }
                    return;
                }

                // ì„±ê³µ ì‹œ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” & ìƒˆë¡œê³ ì¹¨
                inputField.value = "";
                location.reload();
            } catch (error) {
                console.error("ë©”ì‹œì§€ ì‘ì„± ì˜¤ë¥˜:", error);
                alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
    </script>
    
    <%- include('partials/footer') %>
</body>
</html>