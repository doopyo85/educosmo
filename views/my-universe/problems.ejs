<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold mb-0" style="color: #1d1d1f;">문제 풀이 (Problem Solving)</h2>
    </div>

    <style>
        /* Flat White Theme */
        .exam-group {
            margin-bottom: 16px;
            background: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .exam-header {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            background: #FFFFFF;
            border-bottom: 1px solid #F0F0F0;
            cursor: pointer;
            gap: 12px;
        }

        .exam-header:hover {
            background: #FAFAFA;
        }

        .exam-header.collapsed {
            border-bottom: none;
        }

        .exam-title {
            font-weight: 700;
            font-size: 0.95rem;
            color: #1D1D1F;
            flex: 1;
        }

        .exam-stats {
            font-size: 0.75rem;
            color: #86868B;
            background: #F5F5F7;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .exam-chevron {
            color: #86868B;
            transition: transform 0.2s;
        }

        .exam-header.collapsed .exam-chevron {
            transform: rotate(-90deg);
        }

        .exam-content {
            background: #FFFFFF;
        }

        .exam-header.collapsed+.exam-content {
            display: none;
        }

        /* Problem Row */
        .problem-row {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            gap: 12px;
            border-bottom: 1px solid #F5F5F7;
            cursor: pointer;
            transition: background 0.15s;
        }

        .problem-row:hover {
            background: #FAFAFA;
        }

        .problem-row:last-child {
            border-bottom: none;
        }

        .problem-info {
            min-width: 120px;
        }

        .problem-number {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1D1D1F;
        }

        .problem-concept {
            font-size: 0.7rem;
            color: #86868B;
        }

        .problem-tags {
            flex: 1;
        }

        .problem-tags .badge {
            font-size: 0.7rem;
            font-weight: 500;
            padding: 4px 8px;
        }

        .problem-stats {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            min-width: 55px;
        }

        .stat-value {
            font-weight: 700;
            font-size: 0.85rem;
        }

        .stat-label {
            font-size: 0.6rem;
            color: #86868B;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .status-success {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .status-failed {
            background: #FFEBEE;
            color: #C62828;
        }

        /* Attempts */
        .attempts-container {
            display: none;
            background: #FAFAFA;
        }

        .attempts-container.show {
            display: block;
        }

        .attempt-row {
            display: flex;
            align-items: center;
            padding: 8px 20px 8px 52px;
            gap: 12px;
            font-size: 0.75rem;
            border-bottom: 1px solid #EFEFEF;
            color: #666;
        }

        .attempt-row:last-child {
            border-bottom: none;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #86868B;
            background: #FFFFFF;
            border-radius: 12px;
        }
    </style>

    <% if (locals.groupedByExam && locals.groupedByExam.length> 0) { %>
        <% locals.groupedByExam.forEach((exam, eIndex)=> { %>
            <div class="exam-group">
                <div class="exam-header" onclick="toggleExam(this)">
                    <i class="bi bi-folder2 text-muted"></i>
                    <span class="exam-title">
                        <%= exam.exam_name %>
                    </span>
                    <span class="exam-stats">
                        <%= exam.problems.length %>개 문제
                    </span>
                    <i class="bi bi-chevron-down exam-chevron"></i>
                </div>
                <div class="exam-content">
                    <% exam.problems.forEach((problem, pIndex)=> { %>
                        <div class="problem-row" onclick="toggleAttempts(this, '<%= eIndex %>-<%= pIndex %>')">
                            <div class="problem-info">
                                <div class="problem-number">
                                    <%= problem.problem_number %>
                                </div>
                                <% if (problem.concept) { %>
                                    <div class="problem-concept">
                                        <%= problem.concept %>
                                    </div>
                                    <% } %>
                            </div>

                            <div class="problem-tags">
                                <% if (problem.tags) { %>
                                    <% problem.tags.split(',').slice(0, 3).forEach(tag=> { %>
                                        <span class="badge bg-secondary-subtle text-secondary me-1">
                                            <%= tag.trim() %>
                                        </span>
                                        <% }); %>
                                            <% } %>
                            </div>

                            <div class="problem-stats">
                                <div class="stat-item">
                                    <% if (problem.latestTotalTests> 0) { %>
                                        <div
                                            class="stat-value <%= problem.latestPassedTests === problem.latestTotalTests ? 'text-success' : 'text-warning' %>">
                                            <%= problem.latestPassedTests %>/<%= problem.latestTotalTests %>
                                        </div>
                                        <% } else { %>
                                            <div class="stat-value text-muted">-</div>
                                            <% } %>
                                                <div class="stat-label">테스트</div>
                                </div>
                                <div class="stat-item">
                                    <% const rate=problem.accuracyRate || 0; let rateClass='text-danger' ; if (rate>=
                                        80) rateClass = 'text-success';
                                        else if (rate >= 50) rateClass = 'text-warning';
                                        %>
                                        <div class="stat-value <%= rateClass %>">
                                            <%= rate %>%
                                        </div>
                                        <div class="stat-label">
                                            <%= problem.successAttempts %>/<%= problem.totalAttempts %>회
                                        </div>
                                </div>
                                <div>
                                    <% if (problem.latestStatus) { %>
                                        <span class="status-badge status-success">✓ Success</span>
                                        <% } else { %>
                                            <span class="status-badge status-failed">✗ Failed</span>
                                            <% } %>
                                </div>
                            </div>

                            <i class="bi bi-chevron-down text-muted" style="font-size: 0.7rem;"></i>
                        </div>

                        <div class="attempts-container" id="attempts-<%= eIndex %>-<%= pIndex %>">
                            <% problem.attempts.sort((a, b)=> new Date(b.timestamp) - new
                                Date(a.timestamp)).forEach((attempt, aIndex) => { %>
                                <div class="attempt-row">
                                    <span style="min-width: 35px;">#<%= aIndex + 1 %></span>
                                    <span style="min-width: 120px;">
                                        <%= new Date(attempt.timestamp).toLocaleString('ko-KR', { month: '2-digit' ,
                                            day: '2-digit' , hour: '2-digit' , minute: '2-digit' }) %>
                                    </span>
                                    <span style="min-width: 50px;">
                                        <% if (attempt.totalTests> 0) { %>
                                            <%= attempt.passedTests %>/<%= attempt.totalTests %>
                                                    <% } else { %>
                                                        -
                                                        <% } %>
                                    </span>
                                    <% if (attempt.is_correct) { %>
                                        <span class="text-success">✓ Success</span>
                                        <% } else { %>
                                            <span class="text-danger">✗ Failed</span>
                                            <% } %>
                                </div>
                                <% }); %>
                        </div>
                        <% }); %>
                </div>
            </div>
            <% }); %>
                <% } else { %>
                    <div class="empty-state">
                        <i class="bi bi-clipboard-x fs-1 d-block mb-3 opacity-25"></i>
                        아직 푼 문제가 없습니다.
                    </div>
                    <% } %>
</div>

<script>
    function toggleExam(header) {
        header.classList.toggle('collapsed');
    }

    function toggleAttempts(row, id) {
        event.stopPropagation();
        const container = document.getElementById('attempts-' + id);
        container.classList.toggle('show');
    }
</script>