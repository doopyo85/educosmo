<!-- CSS íŒŒì¼ ì°¸ì¡° ì¶”ê°€ -->
<link rel="stylesheet" href="/css/report.css">
<link rel="stylesheet" href="/css/report_bookslist.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

<%- include('../partials/header') %>

<div class="container mt-5"> 
  <div class="row mb-4">
    <div class="col-md-11 offset-md-0.5"> <!-- col-md-10ì„ col-md-11ë¡œ ë³€ê²½ -->
      <h1 class="text-center fw-bold mb-2">ì›”ê°„ í•™ìŠµë¦¬í¬íŠ¸ POD</h1>
      <p class="text-center text-muted mb-4">êµì¬ ì¹´í…Œê³ ë¦¬ì™€ í˜¸ìˆ˜ë¥¼ ì„ íƒí•˜ì—¬ í•™ìŠµ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”</p>
      
      <!-- í…Œì´ë¸” í˜•ì‹ì˜ êµì¬ ì„ íƒ UI -->
      <div class="card shadow-sm" style="transition: none !important; transform: none !important;">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">êµì¬ ì„ íƒ</h4>
        </div>
        <div class="card-body p-4">
          <div id="booksTableContainer">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">êµì¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ì¶”ê°€ -->
<style>
  /* ğŸ”¥ styles.cssì˜ ì¹´ë“œ ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ - í‰ê°€ì§€ í˜ì´ì§€ìš© */
  .card {
    height: auto !important;           /* ê³ ì • ë†’ì´ ì œê±° */
    overflow: visible !important;      /* ë„˜ì¹˜ëŠ” ë‚´ìš© í‘œì‹œ */
    min-height: auto !important;       /* ìµœì†Œ ë†’ì´ë„ ì œê±° */
    max-height: none !important;       /* ìµœëŒ€ ë†’ì´ ì œí•œ ì œê±° */
    transition: none !important;
    transform: none !important;
  }

  .card-body {
    height: auto !important;           /* ì¹´ë“œ ë³¸ë¬¸ ë†’ì´ ìë™ */
    overflow: visible !important;      /* ì¹´ë“œ ë³¸ë¬¸ ì˜¤ë²„í”Œë¡œìš° í‘œì‹œ */
    max-height: none !important;       /* ì¹´ë“œ ë³¸ë¬¸ ìµœëŒ€ ë†’ì´ ì œí•œ ì œê±° */
    padding: 1.5rem !important;        /* ì ì ˆí•œ íŒ¨ë”© ìœ ì§€ */
  }
  
  .card:hover {
    transform: none !important;        /* í˜¸ë²„ ì‹œ í™•ëŒ€ íš¨ê³¼ ì œê±° */
    box-shadow: none !important;
  }
  
  .book-button {
    min-width: 60px;
    margin: 3px;
    font-size: 0.85rem;
    font-weight: normal;
    background-color: white;
    color: #0d6efd;
    border: 1px solid #0d6efd;
    white-space: nowrap;
  }
  
  .book-button:hover {
    background-color: #e7f1ff;
    color: #0d6efd;
  }
  
  .category-row {
    background-color: #f8f9fa;
  }
  
  .category-name {
    font-weight: bold;
    min-width: 140px; /* 120pxì—ì„œ 140pxë¡œ ì•½ê°„ ì¦ê°€ */
    white-space: nowrap;
  }
  
  .books-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 3px;
    table-layout: auto;                /* í…Œì´ë¸” ë ˆì´ì•„ì›ƒ ìë™ */
  }
  
  .books-table th {
    text-align: center;
    background-color: #e9ecef;
    padding: 8px;
    border-radius: 4px;
    white-space: nowrap;
  }
  
  .books-table td {
    padding: 5px;
    vertical-align: middle;
  }
  
  /* í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
  #booksTableContainer {
    width: 100%;
    height: auto;                      /* ìë™ ë†’ì´ */
    overflow: visible;                 /* ë‚´ìš© ëª¨ë‘ í‘œì‹œ */
    min-height: 400px;                 /* ìµœì†Œ ë†’ì´ë§Œ ì„¤ì • */
  }
</style>

<!-- Bootstrap JS ëª…ì‹œì  í¬í•¨ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // êµì¬ í…Œì´ë¸” ì»¨í…Œì´ë„ˆ
  const booksTableContainer = document.getElementById('booksTableContainer');
  
  // ê³ ì •ëœ êµì¬ ì •ë³´
  const fixedCategories = [
    { id: 'preschool', name: 'í”„ë¦¬ìŠ¤ì¿¨ LV1', volumes: 12 },
    { id: 'preschool', name: 'í”„ë¦¬ìŠ¤ì¿¨ LV2', volumes: 12 },
    { id: 'preschool', name: 'í”„ë¦¬ìŠ¤ì¿¨ LV3', volumes: 12 },
    { id: 'junior', name: 'ì£¼ë‹ˆì–´ LV1', volumes: 12 },
    { id: 'junior', name: 'ì£¼ë‹ˆì–´ LV2', volumes: 12 },
    { id: 'cps', name: 'CPS', volumes: 6 },
    { id: 'cpa', name: 'CPA', volumes: 3 },
    { id: 'ctr_appinventor', name: 'CTRì•±ì¸ë²¤í„°', volumes: 5 },
    { id: 'ctr_python', name: 'CTRíŒŒì´ì¬', volumes: 3 }
  ];
  
  // êµì¬ ë°ì´í„° ë¡œë“œ ë° í‘œì‹œ í•¨ìˆ˜
  function renderBooksTable() {
    // í…Œì´ë¸” ìƒì„±
    const table = document.createElement('table');
    table.className = 'books-table';
  
    // í…Œì´ë¸” í—¤ë” ìƒì„± (1í˜¸ ~ 12í˜¸)
    const headerRow = document.createElement('tr');
    
    // ì²« ë²ˆì§¸ ì…€ì€ ë¹ˆ ì…€
    const emptyHeaderCell = document.createElement('th');
    emptyHeaderCell.textContent = 'êµì¬ ì¹´í…Œê³ ë¦¬';
    headerRow.appendChild(emptyHeaderCell);
    
    // í˜¸ìˆ˜ í—¤ë” (1í˜¸ ~ 12í˜¸)
    for (let i = 1; i <= 12; i++) {
      const headerCell = document.createElement('th');
      headerCell.textContent = `${i}í˜¸`;
      headerRow.appendChild(headerCell);
    }
    
    table.appendChild(headerRow);
    
    // ì¹´í…Œê³ ë¦¬ë³„ í–‰ ìƒì„±
    fixedCategories.forEach(category => {
      const row = document.createElement('tr');
      row.className = 'category-row';
      
      // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ì…€
      const categoryCell = document.createElement('td');
      categoryCell.className = 'category-name';
      categoryCell.textContent = category.name;
      row.appendChild(categoryCell);
      
      // í˜¸ìˆ˜ ë²„íŠ¼ ìƒì„± (1í˜¸ ~ category.volumesê¹Œì§€)
      for (let i = 1; i <= 12; i++) {
        const volumeCell = document.createElement('td');
        
        if (i <= category.volumes) {
          // í˜„ì¬ ì¹´í…Œê³ ë¦¬ì˜ ìœ íš¨í•œ í˜¸ìˆ˜ë©´ ë²„íŠ¼ ìƒì„±
          const button = document.createElement('button');
          button.className = 'btn btn-sm btn-outline-primary book-button';
          button.textContent = `${i}í˜¸`;
          
          // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸: ë¦¬í¬íŠ¸ ìƒì„± í˜ì´ì§€ë¡œ ì´ë™
          button.addEventListener('click', function() {
            // Bì—´ ê°’ìœ¼ë¡œ ì¹´í…Œê³ ë¦¬ ì„¤ì • (êµì¬ì¹´í…Œê³ ë¦¬)
            let categoryId = category.name; // Bì—´ ê°’(ì˜ˆ: 'ì£¼ë‹ˆì–´ LV1')
            
            // Cì—´ ê°’ìœ¼ë¡œ ë³¼ë¥¨ ì„¤ì • (êµì¬ë ˆë²¨-í˜¸)
            let bookId = '';
            
            // í”„ë¦¬ìŠ¤ì¿¨/ì£¼ë‹ˆì–´ì˜ ê²½ìš° Cì—´ ê°’ í˜•ì„±
            if (category.name.includes('í”„ë¦¬ìŠ¤ì¿¨')) {
              const lvMatch = category.name.match(/LV(\d+)/i);
              if (lvMatch) {
                const levelNum = lvMatch[1];
                bookId = `í”„ë¦¬ìŠ¤ì¿¨${levelNum}-${i}`;
              } else {
                bookId = `í”„ë¦¬ìŠ¤ì¿¨1-${i}`;
              }
            } else if (category.name.includes('ì£¼ë‹ˆì–´')) {
              const lvMatch = category.name.match(/LV(\d+)/i);
              if (lvMatch) {
                const levelNum = lvMatch[1];
                bookId = `ì£¼ë‹ˆì–´${levelNum}-${i}`;
              } else {
                bookId = `ì£¼ë‹ˆì–´1-${i}`;
              }
            } else if (category.name.includes('CPS')) {
              bookId = `cps${i}`;
            } else if (category.name.includes('CPA')) {
              bookId = `cpa${i}`;
            } else if (category.name.includes('ì•±ì¸ë²¤í„°')) {
              bookId = `ctrì•±ì¸ë²¤í„°${i}`;
            } else if (category.name.includes('íŒŒì´ì¬')) {
              bookId = `ctríŒŒì´ì¬${i}`;
            } else {
              bookId = `${category.id}${i}`;
            }
            
            console.log(`ë¦¬í¬íŠ¸ ìƒì„±: Bì—´=${encodeURIComponent(categoryId)}, Cì—´=${encodeURIComponent(bookId)}`);
            
            // ë¦¬í¬íŠ¸ ìƒì„± í˜ì´ì§€ë¡œ ì´ë™ - Bì—´/Cì—´ ê°’ ì§ì ‘ ì‚¬ìš©
            window.location.href = `/report/generate/${encodeURIComponent(categoryId)}/${encodeURIComponent(bookId)}`;
          });
          
          volumeCell.appendChild(button);
        } else {
          // ìœ íš¨í•˜ì§€ ì•Šì€ í˜¸ìˆ˜ì¸ ê²½ìš° ë¹ˆ ì…€
          volumeCell.innerHTML = '&nbsp;';
        }
        
        row.appendChild(volumeCell);
      }
      table.appendChild(row);
    });
    
    // ì»¨í…Œì´ë„ˆì— í…Œì´ë¸” ì¶”ê°€
    booksTableContainer.innerHTML = '';
    booksTableContainer.appendChild(table);
  }
  
  // ì´ˆê¸° ë¡œë“œ
  renderBooksTable();
});
</script>

<%- include('../partials/footer') %>