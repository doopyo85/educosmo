<!-- CSS íŒŒì¼ ì°¸ì¡° ì¶”ê°€ -->
<link rel="stylesheet" href="/css/report.css">
<%- include('../partials/header') %>

<div class="container my-4">
  <div class="row mb-3">
    <div class="col-md-6">
      <h2>ì›”ê°„ í•™ìŠµë¦¬í¬íŠ¸ POD</h2>
      <p class="text-muted" id="reportTitle">...</p>
    </div>
    <div class="col-md-6 text-md-end">
      <button id="printBtn" class="btn btn-outline-secondary me-2">
        <i class="bi bi-printer"></i> ì¸ì‡„í•˜ê¸°
      </button>
      <a href="/report/books-page" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ
      </a>
    </div>
  </div>

  <div class="alert alert-success d-none" id="saveAlert">
    <i class="bi bi-check-circle me-2"></i> ë¦¬í¬íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm" id="reportPreview">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0">ë¦¬í¬íŠ¸ í¸ì§‘</h5>
          <small class="text-muted">ë¹ˆì¹¸ì„ í´ë¦­í•˜ì—¬ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”</small>
        </div>
        <div class="card-body">
          <div id="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">êµì¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
          
          <div id="reportContent" class="d-none">
            <!-- ë¦¬í¬íŠ¸ ì»¨í…ì¸  ì‹œì‘ -->
            <div id="printableReport" class="a4-page">
              <div class="text-center mb-4">
                <h1 class="display-6 fw-bold">Monthly Assessment</h1>
                <div class="text-end">
                  <h6>ì„¼í„°: <span id="headerCenterName" class="editable" data-field="centerName" contenteditable="true">(ì„¼í„°ëª… ì…ë ¥)</span></h6>
                </div>
              </div>
              
              <table class="table table-bordered fixed-width">
                <tr>
                  <th style="width: 15%;" class="text-center bg-light">í•™ìŠµ ê¸°ê°„</th>
                  <td style="width: 35%;" id="studyPeriodCell">
                    <div class="d-flex align-items-center">
                      <input type="date" id="startDate" class="form-control form-control-sm me-1" style="width: 45%;">
                      <span class="mx-1">~</span>
                      <input type="date" id="endDate" class="form-control form-control-sm" style="width: 45%;">
                    </div>
                  </td>
                  <th style="width: 15%;" class="text-center bg-light">í”„ë¡œê·¸ë¨ëª…</th>
                  <td style="width: 35%;" id="programNameCell"></td>
                </tr>
                <tr>
                  <th class="text-center bg-light">í•™ ìƒ ëª…</th>
                  <td id="studentNameCell" class="editable" data-field="studentName" contenteditable="true">(í•™ìƒëª… ì…ë ¥)</td>
                  <th class="text-center bg-light">ê°• ì‚¬ ëª…</th>
                  <td id="teacherNameCell" class="editable" data-field="teacherName" contenteditable="true">(ê°•ì‚¬ëª… ì…ë ¥)</td>
                </tr>
              </table>
              
              <!-- êµì¬ ì •ë³´ - ìˆœì„œ ë³€ê²½ë¨ -->
              <div class="mt-4 mb-4">
                <h5 class="mb-3 text-center" id="contentsTitle"></h5>
                
                <table class="table table-bordered fixed-width">
                  <tr>
                    <th class="text-center bg-light" style="width: 15%;">êµì¬</th>
                    <td id="bookThumbnailsCell" class="text-center">
                      <!-- ì¸ë„¤ì¼ ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                    </td>
                  </tr>
                </table>
              </div>
              
              <!-- ì„ ìƒë‹˜ ì˜ê²¬ - ìˆœì„œ ë³€ê²½ë¨ -->
              <div class="mt-4">
                <h5 class="mb-3">ì„ ìƒë‹˜ ì˜ê²¬</h5>
                <div class="teacher-comment-area mb-4 editable" id="teacherCommentCell" data-field="teacherComment" contenteditable="true">
                  í•™ìƒì˜ ì„±ì·¨ì™€ ë°œì „ ì‚¬í•­, ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„, í–¥í›„ í•™ìŠµ ë°©í–¥ì— ëŒ€í•´ ì˜ê²¬ì„ ì‘ì„±í•˜ì„¸ìš”.
                </div>
              </div>
              
              <!-- CT ìš”ì†Œ í‰ê°€ í…Œì´ë¸” - ìˆœì„œ ë³€ê²½ë¨ -->
              <div class="evaluation-container">
                <table class="table table-bordered mt-4 fixed-width">
                  <colgroup>
                    <col style="width: 5%;">
                    <col style="width: 20%;">
                    <col style="width: 55%;">
                    <col style="width: 6%;">
                    <col style="width: 7%;">
                    <col style="width: 7%;">
                  </colgroup>
                  <thead>
                    <tr>
                      <th class="text-center bg-light">í•­ëª©</th>
                      <th class="text-center bg-light">
                        CT<br>
                        <small>(ì»´í“¨íŒ… ì‚¬ê³ ë ¥)</small>
                      </th>
                      <th class="text-center bg-light">í‰ê°€ ë‚´ìš©</th>
                      <th class="text-center bg-light">ìƒ</th>
                      <th class="text-center bg-light">ì¤‘</th>
                      <th class="text-center bg-light">í•˜</th>
                    </tr>
                  </thead>
                  <tbody id="evaluationTableBody">
                    <!-- í‰ê°€ í•­ëª©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                  </tbody>
                </table>
              </div>
              
              <div class="text-center mt-4 page-footer">
                <img src="/resource/codingnplay_logo.png" alt="ì½”ë”©ì•¤í”Œë ˆì´" style="max-width: 80px;" />
              </div>
            </div>
            <!-- ë¦¬í¬íŠ¸ ì»¨í…ì¸  ë -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<%- include('../partials/footer') %>

<style>
  /* ğŸ”¥ styles.css ì¹´ë“œ ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ - ë¦¬í¬íŠ¸ ìƒì„± í˜ì´ì§€ìš© */
  .card {
    height: auto !important;           /* ê³ ì • ë†’ì´ ì œê±° */
    overflow: visible !important;      /* ë„˜ì¹˜ëŠ” ë‚´ìš© í‘œì‹œ */
    min-height: auto !important;       /* ìµœì†Œ ë†’ì´ë„ ì œê±° */
    max-height: none !important;       /* ìµœëŒ€ ë†’ì´ ì œí•œ ì œê±° */
  }

  .card-body {
    height: auto !important;           /* ì¹´ë“œ ë³¸ë¬¸ ë†’ì´ ìë™ */
    overflow: visible !important;      /* ì¹´ë“œ ë³¸ë¬¸ ì˜¤ë²„í”Œë¡œìš° í‘œì‹œ */
    max-height: none !important;       /* ì¹´ë“œ ë³¸ë¬¸ ìµœëŒ€ ë†’ì´ ì œí•œ ì œê±° */
    padding: 1.5rem !important;        /* ì ì ˆí•œ íŒ¨ë”© ìœ ì§€ */
  }

  /* í‰ê°€ í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ê°•ì œ í‘œì‹œ */
  .evaluation-container {
    width: 100% !important;
    overflow: visible !important;      /* ìŠ¤í¬ë¡¤ ì œê±°, ëª¨ë“  ë‚´ìš© í‘œì‹œ */
    max-height: none !important;       /* ë†’ì´ ì œí•œ ì œê±° */
    height: auto !important;           /* ìë™ ë†’ì´ */
  }

  /* í‰ê°€ í…Œì´ë¸” ìì²´ ìŠ¤íƒ€ì¼ */
  #evaluationTableBody {
    display: table-row-group !important; /* í…Œì´ë¸” ë³¸ë¬¸ ê°•ì œ í‘œì‹œ */
  }

  /* ë¦¬í¬íŠ¸ í”„ë¦¬ë·° ì¹´ë“œ */
  #reportPreview {
    min-height: auto !important;       /* ìµœì†Œ ë†’ì´ ì œê±° */
    height: auto !important;           /* ìë™ ë†’ì´ */
  }

  /* A4 í˜ì´ì§€ ì»¨í…Œì´ë„ˆ */
  .a4-page {
    height: auto !important;           /* ìë™ ë†’ì´ë¡œ ëª¨ë“  ë‚´ìš© í‘œì‹œ */
    min-height: auto !important;       /* ìµœì†Œ ë†’ì´ ì œê±° */
  }

  /* ì¸ì‡„ ê°€ëŠ¥í•œ ë¦¬í¬íŠ¸ */
  #printableReport {
    height: auto !important;           /* ìë™ ë†’ì´ */
    overflow: visible !important;      /* ëª¨ë“  ë‚´ìš© í‘œì‹œ */
  }

  /* A4 ìš©ì§€ í¬ê¸°ì— ë§ëŠ” ìŠ¤íƒ€ì¼ */
  @media screen {
    .a4-page {
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
      background: white;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .fixed-width {
      width: 100% !important;
      table-layout: fixed;
    }
    
    /* ìŠ¤í¬ë¡¤ ì œê±° */
    .evaluation-container {
      width: 100%;
      overflow-x: visible;
    }
    
    /* hover íš¨ê³¼ ì œê±° */
    .card {
      transition: none !important;
      transform: none !important;
    }
    
    .card:hover {
      transform: none !important;
      box-shadow: none !important;
    }
  }
  
  /* í¸ì§‘ ê°€ëŠ¥í•œ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
  .editable {
    min-height: 20px;
    border: 1px dashed transparent;
    padding: 2px 5px;
    transition: all 0.2s;
  }
  
  .editable:hover, .editable:focus {
    border-color: #80bdff;
    background-color: #f8f9fa;
    outline: none;
  }
  
  .editable:empty:before {
    content: attr(data-placeholder);
    color: #aaa;
    font-style: italic;
  }
  
  /* ì¸ì‡„ ì‹œ ì ìš©ë˜ëŠ” ìŠ¤íƒ€ì¼ - ìˆ˜ì •ë¨ */
  @media print {
    @page {
      size: A4 portrait;
      margin: 10mm;
    }
    
    /* ëª¨ë“  ìš”ì†Œ ìˆ¨ê¹€ */
    body * {
      visibility: hidden;
    }
    
    /* ì¸ì‡„í•  ìš”ì†Œë§Œ í‘œì‹œ */
    #printableReport, 
    #printableReport * {
      visibility: visible !important;
    }
    
    /* ì¸ì‡„í•  ì»¨í…ì¸  ìœ„ì¹˜ ì¡°ì • */
    #printableReport {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 190mm !important;
      margin: 0;
      padding: 0;
    }
    
    .a4-page {
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .fixed-width {
      width: 100% !important;
      table-layout: fixed;
    }
    
    /* í¸ì§‘ ê°€ëŠ¥ ìš”ì†Œ ì¸ì‡„ ìŠ¤íƒ€ì¼ */
    .editable {
      border: none !important;
    }
    
    /* ë‚ ì§œ ì…ë ¥ í•„ë“œ ì¸ì‡„ ìŠ¤íƒ€ì¼ */
    #studyPeriodCell input {
      display: none !important;
    }
    
    #studyPeriodCell:before {
      content: attr(data-formatted-period);
      display: inline-block;
    }
    
    #studyPeriodCell .align-self-center {
      display: none !important;
    }
    
    /* ë‚´ìš©ì´ ë§ì•„ì§ˆ ê²½ìš° ìë™ìœ¼ë¡œ í˜ì´ì§€ ë‚˜ëˆ„ê¸° */
    .evaluation-container {
      page-break-inside: auto;
      overflow: visible !important;
    }
    
    tr {
      page-break-inside: avoid;
    }
    
    .page-footer {
      position: static !important;
      margin-top: 20px;
      text-align: center;
    }

    
    /* ë¶ˆí•„ìš”í•œ ìš”ì†Œ ìˆ¨ê¹€ */
    .navbar, .btn, 
    .card-header,
    .container > .row:first-child,
    #saveAlert {
      display: none !important;
    }
  }
  
  /* í…Œì´ë¸” ì—´ ë„ˆë¹„ ê³ ì • */
  th, td {
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  
  /* ì„ ìƒë‹˜ ì˜ê²¬ ì˜ì—­ ìŠ¤íƒ€ì¼ */
  .teacher-comment-area {
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 1rem;
    min-height: 100px;
  }
  
  /* ë„ì„œ ì¸ë„¤ì¼ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
  .book-thumbnail {
    max-height: 150px;
    max-width: 100%;
    object-fit: contain;
  }
  
  /* ì €ì¥ ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
  #saveAlert {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    width: 300px;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    animation: fadeOut 3s forwards;
    animation-delay: 3s;
  }
  
  @keyframes fadeOut {
    0% { opacity: 1; }
    100% { opacity: 0; visibility: hidden; }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', async function() {
    // URLì—ì„œ ì¹´í…Œê³ ë¦¬ì™€ ë³¼ë¥¨ ê°’ ê°€ì ¸ì˜¤ê¸°
    const pathParts = window.location.pathname.split('/');
    const category = decodeURIComponent(pathParts[pathParts.length - 2]);
    const volume = decodeURIComponent(pathParts[pathParts.length - 1]);
    
    console.log(`ë¦¬í¬íŠ¸ ìƒì„± í˜ì´ì§€ ë¡œë“œ: Bì—´=${category}, Cì—´=${volume}`);
    
    // ì´ˆê¸° ë¡œë”© ìƒíƒœ
    const loadingElement = document.getElementById('loading');
    const reportContentElement = document.getElementById('reportContent');
    const saveAlertElement = document.getElementById('saveAlert');
    
    // ë¦¬í¬íŠ¸ ìš”ì†Œ
    const reportTitleElement = document.getElementById('reportTitle');
    const studentNameCell = document.getElementById('studentNameCell');
    const teacherNameCell = document.getElementById('teacherNameCell');
    const headerCenterName = document.getElementById('headerCenterName');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const studyPeriodCell = document.getElementById('studyPeriodCell');
    const programNameCell = document.getElementById('programNameCell');
    const teacherCommentCell = document.getElementById('teacherCommentCell');
    const evaluationTableBody = document.getElementById('evaluationTableBody');
    const contentsTitle = document.getElementById('contentsTitle');
    const bookThumbnailsCell = document.getElementById('bookThumbnailsCell');
    
    // ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì • (ì˜¤ëŠ˜ ë° 1ê°œì›” ì „)
    const today = new Date();
    const oneMonthAgo = new Date();
    oneMonthAgo.setMonth(today.getMonth() - 1);
    
    startDateInput.value = formatDateForInput(oneMonthAgo);
    endDateInput.value = formatDateForInput(today);
    
    // ë‚ ì§œ ë³€ê²½ ì‹œ ê¸°ê°„ í¬ë§·íŒ…
    function updateFormattedPeriod() {
      if (startDateInput.value && endDateInput.value) {
        const formattedPeriod = formatDateRange(startDateInput.value, endDateInput.value);
        studyPeriodCell.setAttribute('data-formatted-period', formattedPeriod);
      }
    }
    
    startDateInput.addEventListener('change', updateFormattedPeriod);
    endDateInput.addEventListener('change', updateFormattedPeriod);
    
    // ì´ˆê¸° í¬ë§·íŒ… ì‹¤í–‰
    updateFormattedPeriod();
    
    // ë³´ê³ ì„œ ì €ì¥ í‚¤ ìƒì„±
    const reportStorageKey = `report_${category}_${volume}`;
    
    // ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    loadSavedReportData();
    
    try {
      // êµì¬ ì •ë³´ ë° CTìš”ì†Œ ê°€ì ¸ì˜¤ê¸° - Bì—´/Cì—´ ê°’ ì§ì ‘ ì „ë‹¬
      const response = await fetch(`/report/book-ct-elements/${encodeURIComponent(category)}/${encodeURIComponent(volume)}`);
      
      if (!response.ok) {
        throw new Error('êµì¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
      
      const data = await response.json();
      console.log('ë¶ˆëŸ¬ì˜¨ ë°ì´í„°:', data);
      
      // ì¹´í…Œê³ ë¦¬ í‘œì‹œ ê°’ (Bì—´) ë° ë³¼ë¥¨ í‘œì‹œ ê°’ (Cì—´ì—ì„œ íŒŒì‹±)
      let displayCategory = category;
      let displayVolume = volume;
      
      // ë³¼ë¥¨ì—ì„œ í˜¸ìˆ˜ ë¶€ë¶„ ì¶”ì¶œ (Cì—´ ê°’ íŒŒì‹±)
      const volumeMatch = volume.match(/(\d+)(?:-(\d+))?/);
      if (volumeMatch) {
        if (volumeMatch[2]) {
          // '1-2' í˜•ì‹ì¸ ê²½ìš°
          displayVolume = `${volumeMatch[2]}í˜¸`;
        } else {
          // '2' í˜•ì‹ì¸ ê²½ìš°
          displayVolume = `${volumeMatch[1]}í˜¸`;
        }
      }
      
      // ë¦¬í¬íŠ¸ ì œëª© ì„¤ì •
      reportTitleElement.textContent = `${displayCategory} ${displayVolume}`;
      
      // í”„ë¡œê·¸ë¨ ì´ë¦„ ì„¤ì •
      programNameCell.textContent = `${displayCategory}`;
      
      // ì»¨í…ì¸  íƒ€ì´í‹€ ì„¤ì •
      contentsTitle.textContent = `${displayCategory} CTì»´í“¨íŒ… ì‚¬ê³ ë ¥ ì‹ ê·œí™•ì¥ ì½˜í…ì¸ `;
      
      // ì¸ë„¤ì¼ ì´ë¯¸ì§€ í‘œì‹œ
      if (data.book && data.book.thumbnail) {
        bookThumbnailsCell.innerHTML = `
          <img src="${data.book.thumbnail}" alt="${data.book.title}" class="book-thumbnail">
          <p class="small mt-2">${data.book.title}</p>
        `;
      } else {
        bookThumbnailsCell.innerHTML = `
          <p class="text-muted small">ì´ë¯¸ì§€ ì—†ìŒ</p>
          <p class="small mt-2">${data.book?.title || 'êµì¬ ì •ë³´ ì—†ìŒ'}</p>
        `;
      }
      
      // CT ìš”ì†Œ í‰ê°€ í…Œì´ë¸” ì´ˆê¸°í™”
      evaluationTableBody.innerHTML = '';
      
      // í‰ê°€ í•­ëª© í‘œì‹œ
      if (data.ctElements && data.ctElements.length > 0) {
        data.ctElements.forEach((item, index) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="text-center">${index + 1}</td>
            <td class="text-center">${item.ctElement || ''}</td>
            <td>${item.evaluationItem || ''}</td>
            <td class="text-center">
              <div class="form-check form-check-inline justify-content-center">
                <input class="form-check-input evaluation-radio" type="radio" 
                  name="evaluation-${index}" id="eval-${index}-high" value="ìƒ" checked>
              </div>
            </td>
            <td class="text-center">
              <div class="form-check form-check-inline justify-content-center">
                <input class="form-check-input evaluation-radio" type="radio" 
                  name="evaluation-${index}" id="eval-${index}-mid" value="ì¤‘">
              </div>
            </td>
            <td class="text-center">
              <div class="form-check form-check-inline justify-content-center">
                <input class="form-check-input evaluation-radio" type="radio" 
                  name="evaluation-${index}" id="eval-${index}-low" value="í•˜">
              </div>
            </td>
          `;
          evaluationTableBody.appendChild(row);
        });
        
        // í‰ê°€ í•­ëª©ì´ ë§ì„ ê²½ìš° í˜ì´ì§€ ë‚˜ëˆ„ê¸°ë¥¼ ìœ„í•œ ì²˜ë¦¬
        if (data.ctElements.length > 7) {
          document.querySelector('.evaluation-container').classList.add('multi-page');
        }
        
        console.log(`${data.ctElements.length}ê°œì˜ í‰ê°€ í•­ëª©ì´ í‘œì‹œë¨`);
        
        // ì €ì¥ëœ í‰ê°€ ë°ì´í„° ë³µì›
        restoreEvaluationData();
      } else {
        evaluationTableBody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-muted py-3">
              í•´ë‹¹ êµì¬ì— ëŒ€í•œ í‰ê°€ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. (${volume})
            </td>
          </tr>
        `;
        console.log('í‘œì‹œí•  í‰ê°€ í•­ëª©ì´ ì—†ìŒ');
      }
      
      // ë¡œë”© ì™„ë£Œ í›„ ì»¨í…ì¸  í‘œì‹œ
      loadingElement.classList.add('d-none');
      reportContentElement.classList.remove('d-none');
      
      // ìë™ ì €ì¥ ì„¤ì •
      setupAutoSave();
      
    } catch (error) {
      console.error('Error:', error);
      loadingElement.innerHTML = `
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-circle me-2"></i>
          êµì¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
        </div>
      `;
    }
    
    // ì €ì¥ëœ ë¦¬í¬íŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    function loadSavedReportData() {
      try {
        const savedData = localStorage.getItem(reportStorageKey);
        if (savedData) {
          const data = JSON.parse(savedData);
          
          // ë°ì´í„° ë³µì›
          if (data.centerName) headerCenterName.innerText = data.centerName;
          if (data.studentName) studentNameCell.innerText = data.studentName;
          if (data.teacherName) teacherNameCell.innerText = data.teacherName;
          if (data.teacherComment) teacherCommentCell.innerText = data.teacherComment;
          if (data.startDate) startDateInput.value = data.startDate;
          if (data.endDate) endDateInput.value = data.endDate;
          
          console.log('ì €ì¥ëœ ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
      }
    }
    
    // ì €ì¥ëœ í‰ê°€ ë°ì´í„° ë³µì›
    function restoreEvaluationData() {
      try {
        const savedData = localStorage.getItem(reportStorageKey);
        if (savedData) {
          const data = JSON.parse(savedData);
          
          if (data.evaluations) {
            data.evaluations.forEach((value, index) => {
              const radioSelector = `input[name="evaluation-${index}"][value="${value}"]`;
              const radio = document.querySelector(radioSelector);
              if (radio) radio.checked = true;
            });
          }
        }
      } catch (error) {
        console.error('í‰ê°€ ë°ì´í„° ë³µì› ì˜¤ë¥˜:', error);
      }
    }
    
    // ìë™ ì €ì¥ ì„¤ì •
    function setupAutoSave() {
      // í¸ì§‘ ê°€ëŠ¥ ìš”ì†Œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      document.querySelectorAll('.editable').forEach(el => {
        el.addEventListener('blur', saveReportData);
      });
      
      // ë‚ ì§œ ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      startDateInput.addEventListener('change', saveReportData);
      endDateInput.addEventListener('change', saveReportData);
      
      // ë¼ë””ì˜¤ ë²„íŠ¼ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      document.querySelectorAll('.evaluation-radio').forEach(radio => {
        radio.addEventListener('change', saveReportData);
      });
      
      // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ë²„íŠ¼ì´ ìˆëŠ” ê²½ìš°)
      const saveBtn = document.getElementById('saveReportBtn');
      if (saveBtn) {
        saveBtn.addEventListener('click', function() {
          saveReportData();
          showSaveAlert();
        });
      }
    }
    
    // ë¦¬í¬íŠ¸ ë°ì´í„° ì €ì¥ í•¨ìˆ˜
    function saveReportData() {
      const reportData = {
        centerName: headerCenterName.innerText,
        studentName: studentNameCell.innerText,
        teacherName: teacherNameCell.innerText,
        teacherComment: teacherCommentCell.innerText,
        startDate: startDateInput.value,
        endDate: endDateInput.value,
        evaluations: []
      };
      
      // í‰ê°€ í•­ëª© ê°’ ìˆ˜ì§‘
      document.querySelectorAll('[name^="evaluation-"]').forEach((input, groupIndex) => {
        if (input.checked) {
          const groupName = input.name;
          const index = parseInt(groupName.split('-')[1]);
          reportData.evaluations[index] = input.value;
        }
      });
      
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
      localStorage.setItem(reportStorageKey, JSON.stringify(reportData));
      console.log('ë¦¬í¬íŠ¸ ë°ì´í„°ê°€ ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    // ì €ì¥ ì•Œë¦¼ í‘œì‹œ
    function showSaveAlert() {
      saveAlertElement.classList.remove('d-none');
      
      // 6ì´ˆ í›„ ì•Œë¦¼ ìˆ¨ê¸°ê¸°
      setTimeout(() => {
        saveAlertElement.classList.add('d-none');
      }, 6000);
    }
    
    // ì¸ì‡„ ë²„íŠ¼ ì´ë²¤íŠ¸
    const printBtn = document.getElementById('printBtn');
    if (printBtn) {
      printBtn.addEventListener('click', function() {
        // ì¸ì‡„ ì „ ë ˆì´ì•„ì›ƒ ìµœì í™”
        optimizeForPrinting();
        window.print();
      });
    }
    
    // ì¸ì‡„ë¥¼ ìœ„í•œ ìµœì í™” í•¨ìˆ˜
    function optimizeForPrinting() {
      // í•™ìŠµ ê¸°ê°„ í‘œì‹œë¥¼ ìœ„í•œ ì†ì„± ì—…ë°ì´íŠ¸
      studyPeriodCell.setAttribute('data-formatted-period', formatDateRange(startDateInput.value, endDateInput.value));
      
      // ì„ ìƒë‹˜ ì˜ê²¬ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ìµœì†Œ ë†’ì´ ì„¤ì •
      const teacherComment = document.getElementById('teacherCommentCell');
      if (teacherComment && (!teacherComment.textContent.trim() || teacherComment.textContent === 'í•™ìƒì˜ ì„±ì·¨ì™€ ë°œì „ ì‚¬í•­, ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„, í–¥í›„ í•™ìŠµ ë°©í–¥ì— ëŒ€í•´ ì˜ê²¬ì„ ì‘ì„±í•˜ì„¸ìš”.')) {
        teacherComment.innerHTML = '&nbsp;'; // ë¹„ì–´ìˆì„ ê²½ìš° ê³µë°± ì¶”ê°€
      }
      
      console.log('ì¸ì‡„ë¥¼ ìœ„í•œ ë ˆì´ì•„ì›ƒì„ ìµœì í™”í–ˆìŠµë‹ˆë‹¤.');
    }
    
    // ë‚ ì§œ í¬ë§· í•¨ìˆ˜ (YYYY-MM-DD)
    function formatDateForInput(date) {
      return date.toISOString().split('T')[0];
    }
    
    // ë‚ ì§œ ë²”ìœ„ í¬ë§· í•¨ìˆ˜ (YYYY.MM.DD ~ YYYY.MM.DD)
    function formatDateRange(start, end) {
      const formatDate = (dateStr) => {
        const parts = dateStr.split('-');
        return `${parts[0]}.${parts[1]}.${parts[2]}`;
      };
      
      return `${formatDate(start)} ~ ${formatDate(end)}`;
    }
  });
</script>