<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>새 글 작성 - <%= blog.title %>
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #191919;
            color: #d3d3d3;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
            overflow-y: scroll;
            /* 항상 스크롤바 표시 */
        }

        .editor-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 60px 20px;
            min-height: 100vh;
        }

        .title-input {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 30px;
            outline: none;
            padding: 0;
            line-height: 1.2;
        }

        .title-input::placeholder {
            color: #555;
        }

        /* Editor.js Styles Overrides for Dark Mode */
        .codex-editor {
            color: #d3d3d3;
        }

        .ce-block__content {
            max-width: 100%;
        }

        .ce-toolbar__content {
            max-width: 100%;
        }

        /* Block text color */
        .ce-paragraph {
            font-size: 18px;
            line-height: 1.6;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            color: #fff;
        }

        .ce-header {
            color: #fff;
            font-weight: bold;
            padding-bottom: 0.5em !important;
        }

        /* Toolbar and Popups */
        .ce-toolbar__plus,
        .ce-toolbar__settings-btn {
            color: #888;
            background-color: transparent;
        }

        .ce-toolbar__plus:hover,
        .ce-toolbar__settings-btn:hover {
            color: #fff;
            background-color: #333;
        }

        .ce-popover {
            background-color: #252525;
            border: 1px solid #444;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .ce-popover__item:hover {
            background-color: #333;
        }

        .ce-popover__item-icon {
            background-color: #333;
            color: #fff;
        }

        .ce-popover__item-label {
            color: #ddd;
        }

        .ce-inline-toolbar {
            background-color: #252525;
            border: 1px solid #444;
            color: #fff;
        }

        .ce-inline-tool {
            color: #ddd;
        }

        .ce-inline-tool:hover {
            background-color: #333;
            color: #fff;
        }

        .ce-inline-tool--active {
            color: #5b9bf8;
        }

        .ce-conversion-toolbar {
            background-color: #252525;
            border: 1px solid #444;
        }

        .ce-conversion-tool:hover {
            background-color: #333;
        }

        .ce-conversion-tool__icon {
            background-color: #333;
        }

        /* Image Tool Override */
        .image-tool__image-picture {
            border-radius: 4px;
        }

        .image-tool__caption {
            color: #888;
        }

        .action-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .btn-save {
            background-color: white;
            color: black;
            border: none;
            padding: 8px 16px;
            font-weight: 600;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-save:hover {
            background-color: #f0f0f0;
        }

        .btn-cancel {
            background-color: transparent;
            color: #888;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-cancel:hover {
            color: #fff;
        }

        /* Checklist */
        .cdx-checklist__item--checked .cdx-checklist__item-text {
            color: #666;
            text-decoration: line-through;
        }

        .cdx-checklist__item-checkbox {
            border-color: #666;
            background-color: transparent;
        }

        .cdx-checklist__item-checkbox-check {
            background-color: #5b9bf8;
            border-color: #5b9bf8;
        }

        /* Code Box */
        .ce-code__textarea {
            background-color: #2d2d2d;
            color: #f8f8f2;
            border: 1px solid #444;
        }
    </style>

    <!-- Editor.js Core -->
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>

    <!-- Tools -->
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/checklist@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/raw@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/code@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/embed@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/marker@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/inline-code@latest"></script>

</head>

<body>
    <div class="galaxy-layout">
        <!-- Sidebar -->
        <%- include('includes/galaxy_sidebar') %>

            <!-- Main Content (Editor) -->
            <div class="main-content" style="background-color: #191919;">
                <div class="action-bar" style="position: absolute;">
                    <button class="btn-cancel" onclick="history.back()">취소</button>
                    <button class="btn-save" onclick="savePost()">저장</button>
                </div>

                <div class="editor-container">
                    <input type="text" id="postTitle" class="title-input" placeholder="제목 없음" autocomplete="off">
                    <div id="editorjs"></div>
                </div>
            </div>
    </div>

    <script>
        const editor = new EditorJS({
            holder: 'editorjs',
            placeholder: '이곳을 클릭하여 내용을 입력하세요. ("/"를 눌러 메뉴 호출)',

            tools: {
                header: {
                    class: Header,
                    inlineToolbar: true,
                    config: {
                        placeholder: 'Heading',
                        levels: [1, 2, 3],
                        defaultLevel: 1
                    }
                },
                list: {
                    class: List,
                    inlineToolbar: true,
                    config: {
                        defaultStyle: 'unordered'
                    }
                },
                checklist: {
                    class: Checklist,
                    inlineToolbar: true,
                },
                image: {
                    class: ImageTool,
                    config: {
                        endpoints: {
                            byFile: '/upload/image', // Backend upload endpoint
                        },
                        field: 'image',
                        types: 'image/*',
                    }
                },
                quote: {
                    class: Quote,
                    inlineToolbar: true,
                    config: {
                        quotePlaceholder: '인용문을 입력하세요',
                        captionPlaceholder: '저자',
                    },
                },
                code: CodeTool,
                embed: {
                    class: Embed,
                    inlineToolbar: true,
                    config: {
                        services: {
                            youtube: true,
                            coub: true,
                            imgur: true
                        }
                    }
                },
                marker: {
                    class: Marker,
                    shortcut: 'CMD+SHIFT+M',
                },
                inlineCode: {
                    class: InlineCode,
                    shortcut: 'CMD+SHIFT+C',
                },
            },

            data: {}, // Initial Data (Empty for new post)

            onChange: (api, event) => {
                // Auto-save or draft logic could go here
                console.log('Now I know that Editor\'s content changed!');
            }
        });

        async function savePost() {
            const title = document.getElementById('postTitle').value;

            if (!title) {
                alert('제목을 입력해주세요.');
                return;
            }

            try {
                // Get JSON data from Editor.js
                const savedData = await editor.save();

                // Helper to extract plain text for excerpt
                let plainText = '';
                if (savedData.blocks && savedData.blocks.length > 0) {
                    // Simple extraction from paragraphs and headers
                    plainText = savedData.blocks
                        .filter(block => ['paragraph', 'header'].includes(block.type))
                        .map(block => block.data.text)
                        .join(' ')
                        .substring(0, 200);
                }

                // First image validation for thumbnail (optional)
                let thumbnail_url = null;
                const imageBlock = savedData.blocks.find(block => block.type === 'image');
                if (imageBlock && imageBlock.data && imageBlock.data.file) {
                    thumbnail_url = imageBlock.data.file.url;
                }

                const response = await fetch('/write', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        content_json: savedData, // Save the structural data
                        content: plainText,      // Legacy HTML content for old views/excerpts
                        excerpt: plainText,
                        thumbnail_url: thumbnail_url
                    })
                });

                const result = await response.json();
                if (result.success) {
                    window.location.href = result.redirect;
                } else {
                    alert('저장 실패: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error(error);
                alert('저장 중 오류가 발생했습니다.');
            }
        }
    </script>
</body>

</html>