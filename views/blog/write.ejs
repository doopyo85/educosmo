<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒˆ ê¸€ ì‘ì„± - <%= blog.title %>
    </title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Toast UI Editor CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/theme/toastui-editor-dark.min.css" />

    <style>
        body {
            background-color: #191919;
            color: #d3d3d3;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif;
            overflow-y: scroll;
            /* Always show scrollbar to prevent jump */
        }

        /* Layout overrides for Notion-like feel */
        .editor-layout {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Title Input */
        .title-input {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            font-size: 40px;
            font-weight: 700;
            margin-bottom: 30px;
            outline: none;
            padding: 10px 0;
        }

        .title-input::placeholder {
            color: #555;
        }

        /* Editor Customization */
        .toastui-editor-defaultUI {
            border: none !important;
            background-color: transparent !important;
        }

        .toastui-editor-main-container {
            color: #d3d3d3 !important;
        }

        .toastui-editor-mode-switch {
            display: none !important;
            /* Hide Markdown/WYSIWYG switch if we want to enforce one, or keep it */
        }

        /* Use Dark Theme Base */
        .toastui-editor-dark {
            background-color: #191919 !important;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn-save {
            background-color: #2eaadc;
            color: white;
            border: none;
            padding: 8px 16px;
            font-weight: 600;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .btn-save:hover {
            background-color: #2589b1;
        }

        .btn-cancel {
            color: #888;
            text-decoration: none;
        }

        .btn-cancel:hover {
            color: #bbb;
        }
    </style>
</head>

<body>
    <div class="editor-layout">
        <div class="action-bar">
            <a href="javascript:history.back()" class="btn-cancel">â† ë’¤ë¡œê°€ê¸°</a>
            <div class="d-flex gap-2">
                <span id="statusMessage" class="text-muted small align-self-center me-2"></span>
                <button class="btn-save" onclick="savePost()">ê²Œì‹œí•˜ê¸°</button>
            </div>
        </div>

        <!-- Cover Image Placeholder (For future) -->
        <!-- <div class="cover-image-area mb-4 p-4 text-center border border-dark rounded text-muted" style="border-style: dashed !important; cursor: pointer;">
            ğŸ“¸ ì»¤ë²„ ì´ë¯¸ì§€ ì¶”ê°€ (ì¤€ë¹„ì¤‘)
        </div> -->

        <input type="text" id="postTitle" class="title-input" placeholder="ì œëª© ì—†ìŒ" autocomplete="off">

        <!-- Editor Container -->
        <div id="editor"></div>
    </div>

    <!-- Scripts -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script>
        const Editor = toastui.Editor;
        const editor = new Editor({
            el: document.querySelector('#editor'),
            height: '70vh',
            initialEditType: 'wysiwyg', // Start in WYSIWYG mode for Notion feel
            previewStyle: 'vertical',
            theme: 'dark',
            placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”... ( / ë¥¼ ëˆŒëŸ¬ ëª…ë ¹ì–´ í™•ì¸)',
            autofocus: false,
            toolbarItems: [
                ['heading', 'bold', 'italic', 'strike'],
                ['hr', 'quote'],
                ['ul', 'ol', 'task', 'indent', 'outdent'],
                ['table', 'image', 'link'],
                ['code', 'codeblock']
            ]
        });

        async function savePost() {
            const title = document.getElementById('postTitle').value;
            const content = editor.getMarkdown(); // Save as Markdown
            // note: You can also use editor.getHTML() if you prefer storing HTML

            if (!title) {
                alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const btn = document.querySelector('.btn-save');
            const status = document.getElementById('statusMessage');

            btn.disabled = true;
            status.textContent = 'ì €ì¥ ì¤‘...';

            try {
                // Determine save URL based on current context (relative)
                const saveUrl = 'write'; // Relative path works for both /write and /blog/user/write

                const response = await fetch(saveUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        content,
                        thumbnail_url: extractFirstImage(content) // Helper to grab first image
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Redirect to home (relative)
                    window.location.href = './';
                } else { // error
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + (result.error || 'Unknown error'));
                    btn.disabled = false;
                    status.textContent = '';
                }
            } catch (error) {
                console.error(error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                btn.disabled = false;
                status.textContent = '';
            }
        }

        function extractFirstImage(markdown) {
            // Simple regex to find markdown image syntax ![alt](url)
            const match = markdown.match(/!\[.*?\]\((.*?)\)/);
            return match ? match[1] : null;
        }

        // Auto-save draft functionality could go here
    </script>
</body>

</html>