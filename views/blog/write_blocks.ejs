<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÉà Í∏Ä ÏûëÏÑ± - <%= blog.title %></title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">

    <!-- Tiptap Notion CSS -->
    <link rel="stylesheet" href="/css/tiptap-notion.css">

    <style>
        body {
            background-color: #191919;
            color: #d3d3d3;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif;
            overflow-y: scroll;
        }

        /* Layout */
        .editor-layout {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Title Input */
        .title-input {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            font-size: 40px;
            font-weight: 700;
            margin-bottom: 10px;
            outline: none;
            padding: 10px 0;
        }

        .title-input::placeholder {
            color: #555;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background-color: #191919;
            z-index: 100;
            padding: 10px 0;
        }

        .btn-save {
            background-color: #2eaadc;
            color: white;
            border: none;
            padding: 8px 20px;
            font-weight: 600;
            border-radius: 6px;
            transition: background 0.2s;
            cursor: pointer;
        }

        .btn-save:hover {
            background-color: #2589b1;
        }

        .btn-save:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .btn-cancel {
            color: #888;
            text-decoration: none;
            padding: 8px 16px;
        }

        .btn-cancel:hover {
            color: #bbb;
        }

        /* Toolbar */
        .editor-toolbar {
            display: flex;
            gap: 8px;
            padding: 12px;
            background-color: #1e1e1e;
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            background-color: transparent;
            border: 1px solid #333;
            color: #d3d3d3;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background-color: #2a2a2a;
            border-color: #2eaadc;
        }

        .toolbar-btn.is-active {
            background-color: #2eaadc;
            border-color: #2eaadc;
            color: white;
        }

        .toolbar-separator {
            width: 1px;
            background-color: #333;
            margin: 0 4px;
        }

        /* Save Status */
        #saveStatus {
            font-size: 14px;
            margin-right: 10px;
        }

        /* Image Upload Button */
        #imageUploadInput {
            display: none;
        }

        /* Editor Container */
        #editor {
            min-height: 500px;
        }

        /* Slash Command Menu */
        .slash-menu {
            position: absolute;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            min-width: 280px;
            max-height: 400px;
            overflow-y: auto;
        }

        .slash-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .slash-menu-item:hover,
        .slash-menu-item.selected {
            background-color: #2eaadc;
        }

        .slash-menu-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            font-size: 16px;
        }

        .slash-menu-content {
            flex: 1;
        }

        .slash-menu-title {
            font-size: 14px;
            font-weight: 500;
            color: white;
            margin-bottom: 2px;
        }

        .slash-menu-desc {
            font-size: 12px;
            color: #aaa;
        }

        .slash-menu-category {
            font-size: 11px;
            color: #888;
            font-weight: 600;
            padding: 8px 12px 4px;
            margin-top: 8px;
        }

        .slash-menu-category:first-child {
            margin-top: 0;
        }
    </style>
</head>

<body>
    <div class="editor-layout">
        <!-- Action Bar -->
        <div class="action-bar">
            <a href="javascript:history.back()" class="btn-cancel">‚Üê Îí§Î°úÍ∞ÄÍ∏∞</a>
            <div class="d-flex align-items-center gap-2">
                <span id="saveStatus" class="text-muted small"></span>
                <button class="btn-save" id="publishBtn" onclick="savePost()">Í≤åÏãúÌïòÍ∏∞</button>
            </div>
        </div>

        <!-- Title Input -->
        <input type="text" id="postTitle" class="title-input" placeholder="Ï†úÎ™© ÏóÜÏùå" autocomplete="off">

        <!-- Toolbar -->
        <div class="editor-toolbar">
            <button class="toolbar-btn" onclick="editorInstance.editor.chain().focus().toggleHeading({ level: 1 }).run()" title="Ï†úÎ™© 1">
                H1
            </button>
            <button class="toolbar-btn" onclick="editorInstance.editor.chain().focus().toggleHeading({ level: 2 }).run()" title="Ï†úÎ™© 2">
                H2
            </button>
            <button class="toolbar-btn" onclick="editorInstance.editor.chain().focus().toggleHeading({ level: 3 }).run()" title="Ï†úÎ™© 3">
                H3
            </button>

            <div class="toolbar-separator"></div>

            <button class="toolbar-btn" onclick="editorInstance.editor.chain().focus().toggleBold().run()" title="ÍµµÍ≤å">
                <strong>B</strong>
            </button>
            <button class="toolbar-btn" onclick="editorInstance.editor.chain().focus().toggleItalic().run()" title="Í∏∞Ïö∏ÏûÑ">
                <em>I</em>
            </button>
            <button class="toolbar-btn" onclick="editorInstance.editor.chain().focus().toggleStrike().run()" title="Ï∑®ÏÜåÏÑ†">
                <s>S</s>
            </button>
            <button class="toolbar-btn" onclick="editorInstance.editor.chain().focus().toggleCode().run()" title="Ïù∏ÎùºÏù∏ ÏΩîÎìú">
                &lt;/&gt;
            </button>

            <div class="toolbar-separator"></div>

            <button class="toolbar-btn" onclick="editorInstance.editor.chain().focus().toggleBulletList().run()" title="Í∏ÄÎ®∏Î¶¨ Í∏∞Ìò∏">
                ‚Ä¢ Î™©Î°ù
            </button>
            <button class="toolbar-btn" onclick="editorInstance.editor.chain().focus().toggleOrderedList().run()" title="Î≤àÌò∏ Îß§Í∏∞Í∏∞">
                1. Î™©Î°ù
            </button>
            <button class="toolbar-btn" onclick="editorInstance.editor.chain().focus().toggleBlockquote().run()" title="Ïù∏Ïö©">
                " Ïù∏Ïö©
            </button>

            <div class="toolbar-separator"></div>

            <button class="toolbar-btn" onclick="editorInstance.editor.chain().focus().toggleCodeBlock().run()" title="ÏΩîÎìú Î∏îÎ°ù">
                { } ÏΩîÎìú
            </button>
            <button class="toolbar-btn" onclick="handleImageUpload()" title="Ïù¥ÎØ∏ÏßÄ">
                üñºÔ∏è Ïù¥ÎØ∏ÏßÄ
            </button>
            <button class="toolbar-btn" onclick="handleLinkInsert()" title="ÎßÅÌÅ¨">
                üîó ÎßÅÌÅ¨
            </button>
            <button class="toolbar-btn" onclick="editorInstance.insertTable()" title="ÌÖåÏù¥Î∏î">
                ‚äû ÌÖåÏù¥Î∏î
            </button>

            <div class="toolbar-separator"></div>

            <button class="toolbar-btn" onclick="editorInstance.editor.chain().focus().setHorizontalRule().run()" title="Íµ¨Î∂ÑÏÑ†">
                ‚îÄ Íµ¨Î∂ÑÏÑ†
            </button>
        </div>

        <!-- Hidden Image Upload Input -->
        <input type="file" id="imageUploadInput" accept="image/*" onchange="uploadImage(this.files[0])">

        <!-- Editor Container -->
        <div id="editor"></div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { Editor } from 'https://cdn.jsdelivr.net/npm/@tiptap/core@2.1.13/+esm';
        import StarterKit from 'https://cdn.jsdelivr.net/npm/@tiptap/starter-kit@2.1.13/+esm';
        import Image from 'https://cdn.jsdelivr.net/npm/@tiptap/extension-image@2.1.13/+esm';
        import Link from 'https://cdn.jsdelivr.net/npm/@tiptap/extension-link@2.1.13/+esm';
        import Table from 'https://cdn.jsdelivr.net/npm/@tiptap/extension-table@2.1.13/+esm';
        import TableRow from 'https://cdn.jsdelivr.net/npm/@tiptap/extension-table-row@2.1.13/+esm';
        import TableCell from 'https://cdn.jsdelivr.net/npm/@tiptap/extension-table-cell@2.1.13/+esm';
        import TableHeader from 'https://cdn.jsdelivr.net/npm/@tiptap/extension-table-header@2.1.13/+esm';
        import Placeholder from 'https://cdn.jsdelivr.net/npm/@tiptap/extension-placeholder@2.1.13/+esm';

        // Slash Command Menu Data
        const slashCommands = [
            {
                category: 'BASIC BLOCKS',
                items: [
                    { title: 'Text', desc: 'ÏùºÎ∞ò ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî', icon: 'üìÑ', command: 'paragraph' },
                    { title: 'Heading 1', desc: 'ÌÅ∞ Ï†úÎ™©', icon: 'H1', command: 'heading1' },
                    { title: 'Heading 2', desc: 'Ï§ëÍ∞Ñ Ï†úÎ™©', icon: 'H2', command: 'heading2' },
                    { title: 'Heading 3', desc: 'ÏûëÏùÄ Ï†úÎ™©', icon: 'H3', command: 'heading3' },
                ]
            },
            {
                category: 'LISTS',
                items: [
                    { title: 'Bulleted List', desc: 'Í∏ÄÎ®∏Î¶¨ Í∏∞Ìò∏ Î™©Î°ù', icon: '‚Ä¢', command: 'bulletList' },
                    { title: 'Numbered List', desc: 'Î≤àÌò∏ Îß§Í∏∞Í∏∞ Î™©Î°ù', icon: '1.', command: 'orderedList' },
                ]
            },
            {
                category: 'MEDIA',
                items: [
                    { title: 'Image', desc: 'Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú', icon: 'üñºÔ∏è', command: 'image' },
                    { title: 'Code Block', desc: 'ÏΩîÎìú Î∏îÎ°ù ÏÇΩÏûÖ', icon: '{ }', command: 'codeBlock' },
                    { title: 'Table', desc: 'Ìëú ÏÇΩÏûÖ', icon: '‚äû', command: 'table' },
                ]
            },
            {
                category: 'ADVANCED',
                items: [
                    { title: 'Quote', desc: 'Ïù∏Ïö©Î¨∏ Î∏îÎ°ù', icon: '"', command: 'blockquote' },
                    { title: 'Divider', desc: 'Íµ¨Î∂ÑÏÑ† ÏÇΩÏûÖ', icon: '‚îÄ', command: 'divider' },
                ]
            }
        ];

        // Slash Menu Component
        class SlashMenu {
            constructor(editor) {
                this.editor = editor;
                this.element = null;
                this.selectedIndex = 0;
                this.isVisible = false;
                this.filteredCommands = [];
                this.searchQuery = '';
            }

            show(query = '') {
                this.searchQuery = query.toLowerCase();
                this.filterCommands();

                if (this.filteredCommands.length === 0) {
                    this.hide();
                    return;
                }

                if (!this.element) {
                    this.createElement();
                }

                this.updatePosition();
                this.render();
                this.element.style.display = 'block';
                this.isVisible = true;
                this.selectedIndex = 0;
            }

            hide() {
                if (this.element) {
                    this.element.style.display = 'none';
                }
                this.isVisible = false;
                this.searchQuery = '';
            }

            createElement() {
                this.element = document.createElement('div');
                this.element.className = 'slash-menu';
                document.body.appendChild(this.element);

                this.element.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                });
            }

            filterCommands() {
                this.filteredCommands = [];
                slashCommands.forEach(category => {
                    const filtered = category.items.filter(item =>
                        item.title.toLowerCase().includes(this.searchQuery) ||
                        item.desc.toLowerCase().includes(this.searchQuery) ||
                        item.command.toLowerCase().includes(this.searchQuery)
                    );
                    if (filtered.length > 0) {
                        this.filteredCommands.push({ category: category.category, items: filtered });
                    }
                });
            }

            render() {
                if (!this.element) return;

                let html = '';
                this.filteredCommands.forEach((category, catIndex) => {
                    html += `<div class="slash-menu-category">${category.category}</div>`;
                    category.items.forEach((item, itemIndex) => {
                        const globalIndex = this.getGlobalIndex(catIndex, itemIndex);
                        const isSelected = globalIndex === this.selectedIndex;
                        html += `
                            <div class="slash-menu-item ${isSelected ? 'selected' : ''}" data-command="${item.command}">
                                <div class="slash-menu-icon">${item.icon}</div>
                                <div class="slash-menu-content">
                                    <div class="slash-menu-title">${item.title}</div>
                                    <div class="slash-menu-desc">${item.desc}</div>
                                </div>
                            </div>
                        `;
                    });
                });

                this.element.innerHTML = html;

                // Add click handlers
                this.element.querySelectorAll('.slash-menu-item').forEach((el, index) => {
                    el.addEventListener('click', () => {
                        this.executeCommand(el.dataset.command);
                    });
                });
            }

            getGlobalIndex(catIndex, itemIndex) {
                let index = 0;
                for (let i = 0; i < catIndex; i++) {
                    index += this.filteredCommands[i].items.length;
                }
                return index + itemIndex;
            }

            getTotalItems() {
                return this.filteredCommands.reduce((sum, cat) => sum + cat.items.length, 0);
            }

            updatePosition() {
                const { selection } = this.editor.state;
                const { from } = selection;
                const coords = this.editor.view.coordsAtPos(from);

                this.element.style.top = `${coords.bottom + window.scrollY + 5}px`;
                this.element.style.left = `${coords.left + window.scrollX}px`;
            }

            navigateDown() {
                const total = this.getTotalItems();
                this.selectedIndex = (this.selectedIndex + 1) % total;
                this.render();
            }

            navigateUp() {
                const total = this.getTotalItems();
                this.selectedIndex = (this.selectedIndex - 1 + total) % total;
                this.render();
            }

            executeSelected() {
                let currentIndex = 0;
                for (const category of this.filteredCommands) {
                    for (const item of category.items) {
                        if (currentIndex === this.selectedIndex) {
                            this.executeCommand(item.command);
                            return;
                        }
                        currentIndex++;
                    }
                }
            }

            executeCommand(command) {
                const { state, dispatch, view } = this.editor;
                const { from, to } = state.selection;

                // Delete the slash and query text
                const tr = state.tr.delete(from - this.searchQuery.length - 1, to);
                dispatch(tr);

                // Execute command
                setTimeout(() => {
                    switch(command) {
                        case 'paragraph':
                            this.editor.chain().focus().setParagraph().run();
                            break;
                        case 'heading1':
                            this.editor.chain().focus().setHeading({ level: 1 }).run();
                            break;
                        case 'heading2':
                            this.editor.chain().focus().setHeading({ level: 2 }).run();
                            break;
                        case 'heading3':
                            this.editor.chain().focus().setHeading({ level: 3 }).run();
                            break;
                        case 'bulletList':
                            this.editor.chain().focus().toggleBulletList().run();
                            break;
                        case 'orderedList':
                            this.editor.chain().focus().toggleOrderedList().run();
                            break;
                        case 'codeBlock':
                            this.editor.chain().focus().toggleCodeBlock().run();
                            break;
                        case 'blockquote':
                            this.editor.chain().focus().toggleBlockquote().run();
                            break;
                        case 'divider':
                            this.editor.chain().focus().setHorizontalRule().run();
                            break;
                        case 'table':
                            this.editor.chain().focus().insertTable({ rows: 3, cols: 3, withHeaderRow: true }).run();
                            break;
                        case 'image':
                            handleImageUpload();
                            break;
                    }
                    this.hide();
                }, 10);
            }
        }

        // Initialize Slash Menu
        let slashMenu = null;

        // Initialize Editor
        const editor = new Editor({
            element: document.querySelector('#editor'),
            extensions: [
                StarterKit.configure({
                    heading: {
                        levels: [1, 2, 3, 4]
                    }
                }),
                Placeholder.configure({
                    placeholder: 'ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî... / Î•º ÎàåÎü¨ Î™ÖÎ†πÏñ¥ Î≥¥Í∏∞'
                }),
                Image.configure({
                    inline: true,
                    allowBase64: false,
                    HTMLAttributes: {
                        class: 'editor-image'
                    }
                }),
                Link.configure({
                    openOnClick: false,
                    HTMLAttributes: {
                        class: 'editor-link',
                        target: '_blank',
                        rel: 'noopener noreferrer'
                    }
                }),
                Table.configure({
                    resizable: true,
                    HTMLAttributes: {
                        class: 'editor-table'
                    }
                }),
                TableRow,
                TableHeader,
                TableCell
            ],
            editorProps: {
                attributes: {
                    class: 'notion-editor-content'
                },
                handleKeyDown: (view, event) => {
                    if (!slashMenu || !slashMenu.isVisible) return false;

                    if (event.key === 'ArrowDown') {
                        event.preventDefault();
                        slashMenu.navigateDown();
                        return true;
                    }

                    if (event.key === 'ArrowUp') {
                        event.preventDefault();
                        slashMenu.navigateUp();
                        return true;
                    }

                    if (event.key === 'Enter') {
                        event.preventDefault();
                        slashMenu.executeSelected();
                        return true;
                    }

                    if (event.key === 'Escape') {
                        slashMenu.hide();
                        return true;
                    }

                    return false;
                }
            },
            onUpdate: ({ editor }) => {
                handleEditorUpdate(editor);
                handleSlashCommand(editor);
            }
        });

        // Initialize slash menu after editor is ready
        slashMenu = new SlashMenu(editor);

        // Handle slash command detection
        function handleSlashCommand(editor) {
            const { state } = editor;
            const { selection } = state;
            const { $from } = selection;

            // Get text before cursor
            const textBefore = $from.parent.textContent.substring(0, $from.parentOffset);

            // Check for slash command
            const match = textBefore.match(/\/(\w*)$/);

            if (match) {
                const query = match[1];
                slashMenu.show(query);
            } else {
                slashMenu.hide();
            }
        }

        // Global reference
        window.editorInstance = {
            editor: editor,
            insertTable: () => {
                editor.chain().focus().insertTable({ rows: 3, cols: 3, withHeaderRow: true }).run();
            }
        };

        // Auto-save functionality
        let autosaveTimer = null;
        function handleEditorUpdate(editor) {
            if (autosaveTimer) {
                clearTimeout(autosaveTimer);
            }

            autosaveTimer = setTimeout(() => {
                saveDraft();
            }, 3000);
        }

        function saveDraft() {
            try {
                const json = window.editorInstance.editor.getJSON();
                const html = window.editorInstance.editor.getHTML();

                localStorage.setItem('blog_draft_new', JSON.stringify({
                    title: document.getElementById('postTitle').value,
                    json,
                    html,
                    savedAt: new Date().toISOString()
                }));

                showSaveStatus('Ï†ÄÏû•Îê®');
            } catch (error) {
                console.error('[Draft] Save failed:', error);
            }
        }

        function showSaveStatus(message, isError = false) {
            const statusElement = document.getElementById('saveStatus');
            statusElement.textContent = message;
            statusElement.className = `small ${isError ? 'text-danger' : 'text-success'}`;

            setTimeout(() => {
                statusElement.textContent = '';
            }, 2000);
        }

        // Load draft on page load
        window.addEventListener('DOMContentLoaded', () => {
            const draft = localStorage.getItem('blog_draft_new');
            if (draft) {
                try {
                    const { title, json, savedAt } = JSON.parse(draft);
                    const savedDate = new Date(savedAt);
                    const hoursDiff = (new Date() - savedDate) / 1000 / 60 / 60;

                    if (hoursDiff < 24) {
                        const restore = confirm(`${Math.floor(hoursDiff)}ÏãúÍ∞Ñ Ï†ÑÏóê Ï†ÄÏû•Îêú Ï¥àÏïàÏù¥ ÏûàÏäµÎãàÎã§. Î≥µÍµ¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`);
                        if (restore) {
                            document.getElementById('postTitle').value = title || '';
                            window.editorInstance.editor.commands.setContent(json);
                        }
                    }
                } catch (error) {
                    console.error('[Draft] Load failed:', error);
                }
            }
        });

        // Make functions global
        window.handleImageUpload = handleImageUpload;
        window.handleLinkInsert = handleLinkInsert;
        window.uploadImage = uploadImage;
        window.savePost = savePost;
    </script>

    <script>
        // Image upload handler
        function handleImageUpload() {
            document.getElementById('imageUploadInput').click();
        }

        async function uploadImage(file) {
            if (!file) return;

            const formData = new FormData();
            formData.append('image', file);

            const statusElement = document.getElementById('saveStatus');
            statusElement.textContent = 'Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ï§ë...';
            statusElement.className = 'small text-info';

            try {
                const response = await fetch('/upload/image', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success && result.url) {
                    // Insert image into editor
                    window.editorInstance.editor.chain().focus().setImage({ src: result.url }).run();
                    statusElement.textContent = 'Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÏôÑÎ£å';
                    statusElement.className = 'small text-success';
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('[Image] Upload failed:', error);
                alert('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                statusElement.textContent = 'ÏóÖÎ°úÎìú Ïã§Ìå®';
                statusElement.className = 'small text-danger';
            }

            setTimeout(() => {
                statusElement.textContent = '';
            }, 2000);
        }

        // Link insert handler
        function handleLinkInsert() {
            const url = prompt('ÎßÅÌÅ¨ URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            if (url) {
                window.editorInstance.editor.chain().focus().setLink({ href: url }).run();
            }
        }

        // Save post
        async function savePost() {
            const title = document.getElementById('postTitle').value.trim();
            const json = window.editorInstance.editor.getJSON();
            const html = window.editorInstance.editor.getHTML();
            const text = window.editorInstance.editor.getText();

            if (!title) {
                alert('Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                document.getElementById('postTitle').focus();
                return;
            }

            if (!text.trim()) {
                alert('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const btn = document.getElementById('publishBtn');
            const status = document.getElementById('saveStatus');

            btn.disabled = true;
            status.textContent = 'Í≤åÏãú Ï§ë...';
            status.className = 'small text-info';

            try {
                // Extract first image for thumbnail
                const firstImageBlock = json.content?.find(block => block.type === 'image');
                const thumbnail_url = firstImageBlock?.attrs?.src || null;

                // Extract excerpt (first 200 characters)
                const excerpt = text.substring(0, 200);

                const response = await fetch('write', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        content: html, // HTML for fallback/display
                        content_json: JSON.stringify(json), // JSON for editor
                        thumbnail_url,
                        excerpt
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Clear draft
                    localStorage.removeItem('blog_draft_new');

                    // Redirect to home
                    window.location.href = './';
                } else {
                    alert('Í≤åÏãú Ïã§Ìå®: ' + (result.error || 'Unknown error'));
                    btn.disabled = false;
                    status.textContent = '';
                }
            } catch (error) {
                console.error('[Publish] Error:', error);
                alert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                btn.disabled = false;
                status.textContent = '';
            }
        }
    </script>
</body>

</html>
