<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= mode === 'edit' ? 'ê²Œì‹œê¸€ ìˆ˜ì •' : 'ê¸€ì“°ê¸°' %> - <%= category ? category.name : 'ê²Œì‹œíŒ' %></title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/board-layout.css">
    
    <!-- CKEditor 5 -->
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
    
    <style>
        /* ğŸ”¥ ê¸€ì“°ê¸° í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
        body {
            background-color: #f8f9fa;
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        }
        
        /* ê¸€ì“°ê¸° í—¤ë” */
        .write-header {
            padding: 20px 25px;
            border-bottom: 2px solid #e9ecef;
            background-color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .write-title {
            font-size: 24px;
            font-weight: bold;
            color: #495057;
            margin: 0;
        }
        
        /* í—¤ë” ì•¡ì…˜ ë²„íŠ¼ */
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .header-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            border: 1px solid;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .header-btn-cancel {
            background-color: #fff;
            color: #6c757d;
            border-color: #dee2e6;
        }
        
        .header-btn-cancel:hover {
            background-color: #f8f9fa;
            color: #495057;
            border-color: #adb5bd;
            text-decoration: none;
        }
        
        .header-btn-submit {
            background-color: #0066cc;
            color: white;
            border-color: #0066cc;
            cursor: pointer;
        }
        
        .header-btn-submit:hover:not(:disabled) {
            background-color: #0052a3;
            border-color: #0052a3;
        }
        
        .header-btn-submit:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }
        
        /* ê¸€ì“°ê¸° í¼ */
        .write-form-container {
            padding: 25px;
            background-color: #fff;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .required {
            color: #dc3545;
        }
        
        /* ğŸ”¥ CKEditor ë° ì´ë¯¸ì§€ ì—…ë¡œë“œ ìŠ¤íƒ€ì¼ */
        .ck-editor__editable {
            min-height: 300px;
            border-radius: 6px;
        }
        
        /* ì´ë¯¸ì§€ ì—…ë¡œë“œ ì§„í–‰ë¥  í‘œì‹œ */
        .image-upload-progress {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            z-index: 9999;
            display: none;
        }
        
        .image-upload-progress .progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .image-upload-progress .progress-bar {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* ì—ë””í„° ë‚´ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .ck-content img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* ë“œë˜ê·¸ ì˜¤ë²„ íš¨ê³¼ */
        .ck-editor__editable.drag-over {
            background-color: #e3f2fd !important;
            border: 2px dashed #2196f3 !important;
        }
        
        /* ğŸ”¥ ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ UI ìŠ¤íƒ€ì¼ */
        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .upload-zone {
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-zone:hover {
            background-color: #f8f9fa;
            border-color: #6c757d;
        }
        
        .upload-zone.drag-over {
            background-color: #e3f2fd;
            border-color: #2196f3;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 48px;
            color: #6c757d;
            margin-bottom: 16px;
        }
        
        .upload-zone.drag-over .upload-icon {
            color: #2196f3;
            transform: scale(1.1);
        }
        
        .upload-text h6 {
            color: #495057;
            margin-bottom: 8px;
        }
        
        /* ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡ */
        .file-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 8px;
            background-color: #fff;
            transition: all 0.2s ease;
        }
        
        .file-item:hover {
            background-color: #f8f9fa;
            transform: translateX(2px);
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            margin-right: 12px;
            font-size: 18px;
            color: white;
        }
        
        .file-icon.image { background-color: #28a745; }
        .file-icon.document { background-color: #17a2b8; }
        .file-icon.archive { background-color: #ffc107; color: #212529; }
        .file-icon.other { background-color: #6c757d; }
        
        .file-info {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-weight: 500;
            color: #495057;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-size {
            font-size: 12px;
            color: #6c757d;
        }
        
        .file-actions {
            display: flex;
            gap: 8px;
        }
        
        .file-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        
        .file-action-btn.preview {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .file-action-btn.preview:hover {
            background-color: #bbdefb;
        }
        
        .file-action-btn.delete {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .file-action-btn.delete:hover {
            background-color: #ffcdd2;
        }
        
        /* ì—…ë¡œë“œ ì§„í–‰ë¥  */
        .upload-progress {
            margin-top: 16px;
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .progress {
            height: 8px;
            border-radius: 4px;
            background-color: #e9ecef;
        }
        
        .progress-bar {
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        /* ğŸ”¥ í•˜ë‹¨ ì•¡ì…˜ ì˜ì—­ ì œê±°ë¨ - í—¤ë”ë¡œ ì´ë™ */
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .write-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
                padding: 15px 20px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .write-form-container {
                padding-left: 20px;
                padding-right: 20px;
            }
            
            .header-btn {
                font-size: 13px;
                padding: 6px 12px;
            }
        }
        
        @media (max-width: 576px) {
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .header-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <%- include('../partials/header') %>
    
    <!-- ğŸ”¥ í†µí•© ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ -->
    <div class="board-layout-container">
        <!-- ğŸ”¥ ì™¼ìª½ ë„¤ë¹„ê²Œì´ì…˜ (í•­ìƒ ê³ ì •) -->
        <div class="board-sidebar">
            <div class="board-sidebar-header">
                <i class="bi bi-grid-3x3-gap"></i> ê²Œì‹œíŒ
            </div>
            
            <a href="/board" class="board-category-item">
                <i class="bi bi-house"></i> ì „ì²´ ê²Œì‹œíŒ
            </a>
            
            <a href="/board/notice" class="board-category-item <%= (category && category.slug === 'notice') ? 'active' : '' %>">
                <i class="bi bi-megaphone"></i> ì—…ë°ì´íŠ¸ ë…¸íŠ¸
            </a>
            
            <a href="/board/education" class="board-category-item <%= (category && category.slug === 'education') ? 'active' : '' %>">
                <i class="bi bi-book"></i> êµìœ¡ì •ë³´
            </a>
            
            <a href="/board/free" class="board-category-item <%= (category && category.slug === 'free') ? 'active' : '' %>">
                <i class="bi bi-chat-dots"></i> ììœ ê²Œì‹œíŒ
            </a>
        </div>
        
        <!-- ğŸ”¥ ë©”ì¸ ì½˜í…ì¸  (ê³ ì • ë„ˆë¹„) -->
        <div class="board-main-content">
            <!-- ê¸€ì“°ê¸° í—¤ë” -->
            <div class="write-header">
                <h1 class="write-title">
                    <%= mode === 'edit' ? 'ê²Œì‹œê¸€ ìˆ˜ì •' : 'ê¸€ì“°ê¸°' %>
                    <% if (category) { %>
                        - <%= category.name %>
                    <% } %>
                </h1>
                
                <!-- ğŸ”¥ í—¤ë” ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
                <div class="header-actions">
                    <a href="/board" class="header-btn header-btn-cancel">
                        <i class="bi bi-arrow-left"></i> ì·¨ì†Œ
                    </a>
                    <button type="submit" class="header-btn header-btn-submit" id="submitBtn" form="writeForm">
                        <i class="bi bi-check-lg"></i> <%= mode === 'edit' ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°' %>
                    </button>
                </div>
            </div>
            
            <!-- ê¸€ì“°ê¸° í¼ -->
            <div class="write-form-container">
                <form id="writeForm">
                    <!-- ğŸ”¥ ì¹´í…Œê³ ë¦¬ ì„ íƒ (ì œëª© ìœ„ë¡œ ì´ë™) -->
                    <div class="mb-3">
                        <label for="categorySelect" class="form-label">ì¹´í…Œê³ ë¦¬ <span class="required">*</span></label>
                        <select class="form-select" id="categorySelect" name="category_id" required>
                            <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="1" <%= (category && category.id == 1) ? 'selected' : '' %>>ì—…ë°ì´íŠ¸ ë…¸íŠ¸</option>
                            <option value="2" <%= (category && category.id == 2) ? 'selected' : '' %>>êµìœ¡ì •ë³´</option>
                            <option value="3" <%= (category && category.id == 3) ? 'selected' : '' %>>ììœ ê²Œì‹œíŒ</option>
                        </select>
                    </div>
                    
                    <!-- ì œëª© -->
                    <div class="mb-3">
                        <label for="title" class="form-label">ì œëª© <span class="required">*</span></label>
                        <input type="text" class="form-control" id="title" name="title" 
                               value="<%= (mode === 'edit' && post) ? post.title : '' %>" 
                               placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>
                    
                    <!-- ë‚´ìš© -->
                    <div class="mb-3">
                        <label for="content" class="form-label">ë‚´ìš© <span class="required">*</span></label>
                        <textarea id="content" name="content" class="form-control" rows="15" 
                                  placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"><%= (mode === 'edit' && post) ? post.content : '' %></textarea>
                    </div>
                    
                    <!-- ğŸ”¥ ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
                    <div class="mb-4">
                        <label class="form-label">ì²¨ë¶€íŒŒì¼</label>
                        
                        <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="upload-zone" id="uploadZone">
                                <div class="upload-icon">
                                    <i class="bi bi-cloud-upload"></i>
                                </div>
                                <div class="upload-text">
                                    <h6>íŒŒì¼ì„ ë“œë˜ê·¸í•´ì„œ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</h6>
                                    <p class="text-muted">ìµœëŒ€ 10ê°œ íŒŒì¼, ê° íŒŒì¼ë‹¹ 50MB ì´í•˜</p>
                                </div>
                                <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png,.gif,.webp,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip,.rar,.7z,.txt,.hwp" style="display: none;">
                            </div>
                        </div>
                        
                        <!-- ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡ -->
                        <div class="uploaded-files" id="uploadedFiles" style="display: none;">
                            <h6 class="mt-3 mb-2">ì²¨ë¶€ëœ íŒŒì¼ (<span id="fileCount">0</span>ê°œ)</h6>
                            <div class="file-list" id="fileList"></div>
                        </div>
                        
                        <!-- íŒŒì¼ ì—…ë¡œë“œ ì§„í–‰ë¥  -->
                        <div class="upload-progress" id="uploadProgress" style="display: none;">
                            <div class="progress-info">
                                <span id="uploadStatus">íŒŒì¼ ì—…ë¡œë“œ ì¤‘...</span>
                                <span id="uploadPercent">0%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-primary" id="fileProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì¶œì²˜ ë° ì €ì‘ê¶Œ -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="source" class="form-label">ì¶œì²˜</label>
                            <input type="text" class="form-control" id="source" name="source" 
                                   value="<%= (mode === 'edit' && post) ? (post.source || '') : '' %>" 
                                   placeholder="ì¶œì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ)">
                        </div>
                        <div class="col-md-6">
                            <label for="ccl" class="form-label">ì €ì‘ê¶Œ</label>
                            <select class="form-select" id="ccl" name="ccl">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="CC0" <%= (mode === 'edit' && post && post.ccl === 'CC0') ? 'selected' : '' %>>CC0 (í¼ë¸”ë¦­ ë„ë©”ì¸)</option>
                                <option value="CC BY" <%= (mode === 'edit' && post && post.ccl === 'CC BY') ? 'selected' : '' %>>CC BY (ì €ì‘ì í‘œì‹œ)</option>
                                <option value="CC BY-SA" <%= (mode === 'edit' && post && post.ccl === 'CC BY-SA') ? 'selected' : '' %>>CC BY-SA (ì €ì‘ì í‘œì‹œ-ë™ì¼ì¡°ê±´ë³€ê²½í—ˆë½)</option>
                                <option value="CC BY-NC" <%= (mode === 'edit' && post && post.ccl === 'CC BY-NC') ? 'selected' : '' %>>CC BY-NC (ì €ì‘ì í‘œì‹œ-ë¹„ì˜ë¦¬)</option>
                                <option value="ì €ì‘ê¶Œì ë™ì˜" <%= (mode === 'edit' && post && post.ccl === 'ì €ì‘ê¶Œì ë™ì˜') ? 'selected' : '' %>>ì €ì‘ê¶Œì ë™ì˜</option>
                                <option value="ì§ì ‘ ì œì‘" <%= (mode === 'edit' && post && post.ccl === 'ì§ì ‘ ì œì‘') ? 'selected' : '' %>>ì§ì ‘ ì œì‘</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ê´€ë¦¬ì ì˜µì…˜ -->
                    <% if (locals.canSetNotice) { %>
                        <div class="mb-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="isNotice" name="is_notice" 
                                       <%= (mode === 'edit' && post && post.is_notice) ? 'checked' : '' %>>
                                <label class="form-check-label" for="isNotice">ê³µì§€ì‚¬í•­</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="isPinned" name="is_pinned"
                                       <%= (mode === 'edit' && post && post.is_pinned) ? 'checked' : '' %>>
                                <label class="form-check-label" for="isPinned">ìƒë‹¨ ê³ ì •</label>
                            </div>
                        </div>
                    <% } %>
                </form>
            </div>
            
            <!-- ğŸ”¥ í•˜ë‹¨ ì•¡ì…˜ ë²„íŠ¼ ì˜ì—­ ì œê±° (í—¤ë”ë¡œ ì´ë™ë¨) -->
        </div>
        
        <!-- ğŸ”¥ ì˜¤ë¥¸ìª½ ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ (ê¸€ì“°ê¸°ë§Œ) -->
        <div class="board-action-buttons">
            <a href="/board/write" class="board-floating-btn" title="ê¸€ì“°ê¸°">
                <i class="bi bi-pencil-square"></i>
                <span class="btn-text">ê¸€ì“°ê¸°</span>
            </a>
        </div>
    </div>

    <!-- ğŸ”¥ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì§„í–‰ë¥  í‘œì‹œ -->
    <div class="image-upload-progress" id="imageUploadProgress">
        <div class="upload-text">ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...</div>
        <div class="progress">
            <div class="progress-bar" id="imageProgressBar"></div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let editor;
        
        // ğŸ”¥ ì¹´í…Œê³ ë¦¬ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
        document.getElementById('categorySelect').addEventListener('change', function() {
            const selectedValue = this.value;
            const categoryNames = {
                '1': 'ì—…ë°ì´íŠ¸ ë…¸íŠ¸',
                '2': 'êµìœ¡ì •ë³´', 
                '3': 'ììœ ê²Œì‹œíŒ'
            };
            
            console.log('ì„ íƒëœ ì¹´í…Œê³ ë¦¬:', selectedValue, categoryNames[selectedValue]);
        });
        
        // ğŸ”¥ =========== ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ ===========
        
        let uploadedAttachments = []; // ì—…ë¡œë“œëœ ì²¨ë¶€íŒŒì¼ ëª©ë¡
        
        // ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ì´ˆê¸°í™”
        function initializeFileUpload() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            
            // í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ
            uploadZone.addEventListener('click', () => {
                fileInput.click();
            });
            
            // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    handleFileUpload(files);
                }
                // input ì´ˆê¸°í™”
                fileInput.value = '';
            });
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            });
            
            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    handleFileUpload(files);
                }
            });
        }
        
        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        async function handleFileUpload(files) {
            // íŒŒì¼ ê°œìˆ˜ ì œí•œ (ê¸°ì¡´ + ìƒˆë¡œìš´ íŒŒì¼)
            if (uploadedAttachments.length + files.length > 10) {
                showErrorAlert('ì „ì²´ íŒŒì¼', 'ìµœëŒ€ 10ê°œì˜ íŒŒì¼ë§Œ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            showUploadProgress('íŒŒì¼ ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...');
            
            const uploadResults = {
                success: [],
                failed: []
            };
            
            let totalFiles = files.length;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                try {
                    // ê°œë³„ íŒŒì¼ ê²€ì¦
                    const validationResult = validateFileBeforeUpload(file);
                    if (!validationResult.isValid) {
                        uploadResults.failed.push({
                            filename: file.name,
                            error: validationResult.error
                        });
                        continue;
                    }
                    
                    updateUploadProgress(`${file.name} ì—…ë¡œë“œ ì¤‘...`, Math.round(((i + 0.5) / totalFiles) * 100));
                    
                    // ì„œë²„ì— ì—…ë¡œë“œ
                    const uploadedFile = await uploadFileToServer(file);
                    
                    // ì„±ê³µí•œ íŒŒì¼ì„ ëª©ë¡ì— ì¶”ê°€
                    uploadedAttachments.push(uploadedFile);
                    uploadResults.success.push({
                        filename: file.name,
                        size: file.size
                    });
                    
                    updateUploadProgress(`${file.name} ì—…ë¡œë“œ ì™„ë£Œ`, Math.round(((i + 1) / totalFiles) * 100));
                    
                } catch (error) {
                    console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                    uploadResults.failed.push({
                        filename: file.name,
                        error: error.message || 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
                    });
                }
            }
            
            hideUploadProgress();
            updateFileList();
            
            // ê²°ê³¼ ë¦¬í¬íŠ¸
            showUploadResults(uploadResults);
        }
        
        // ì„œë²„ì— íŒŒì¼ ì—…ë¡œë“œ
        async function uploadFileToServer(file) {
            const formData = new FormData();
            formData.append('files', file);
            
            const response = await fetch('/api/board/attachments/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                return result.files[0]; // ì²« ë²ˆì§¸ íŒŒì¼ ì •ë³´ ë°˜í™˜
            } else {
                throw new Error(result.error || 'íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨');
            }
        }
        
        // íŒŒì¼ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateFileList() {
            const fileListContainer = document.getElementById('uploadedFiles');
            const fileList = document.getElementById('fileList');
            const fileCount = document.getElementById('fileCount');
            
            if (uploadedAttachments.length === 0) {
                fileListContainer.style.display = 'none';
                return;
            }
            
            fileListContainer.style.display = 'block';
            fileCount.textContent = uploadedAttachments.length;
            
            fileList.innerHTML = uploadedAttachments.map((file, index) => {
                const fileType = getFileType(file.type);
                const fileSize = formatFileSize(file.size);
                
                return `
                    <div class="file-item" data-index="${index}">
                        <div class="file-icon ${fileType}">
                            <i class="bi ${getFileIcon(fileType)}"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name" title="${file.originalName}">${file.originalName}</div>
                            <div class="file-size">${fileSize}</div>
                        </div>
                        <div class="file-actions">
                            ${file.isImage ? `<button class="file-action-btn preview" onclick="previewFile(${index})" title="ë¯¸ë¦¬ë³´ê¸°"><i class="bi bi-eye"></i></button>` : ''}
                            <button class="file-action-btn delete" onclick="removeFile(${index})" title="ì‚­ì œ"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // íŒŒì¼ ì œê±°
        function removeFile(index) {
            const file = uploadedAttachments[index];
            
            if (confirm(`"${file.originalName}" íŒŒì¼ì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                uploadedAttachments.splice(index, 1);
                updateFileList();
            }
        }
        
        // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
        function previewFile(index) {
            const file = uploadedAttachments[index];
            if (file.isImage) {
                // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ (ì¶”í›„ êµ¬í˜„)
                window.open(file.url, '_blank');
            }
        }
        
        // íŒŒì¼ íƒ€ì… ê²°ì •
        function getFileType(mimeType) {
            if (mimeType.startsWith('image/')) return 'image';
            if (mimeType.includes('pdf') || mimeType.includes('document') || mimeType.includes('word') || mimeType.includes('excel') || mimeType.includes('powerpoint')) return 'document';
            if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('7z')) return 'archive';
            return 'other';
        }
        
        // íŒŒì¼ ì•„ì´ì½˜ ê²°ì •
        function getFileIcon(fileType) {
            switch (fileType) {
                case 'image': return 'bi-image';
                case 'document': return 'bi-file-earmark-text';
                case 'archive': return 'bi-file-earmark-zip';
                default: return 'bi-file-earmark';
            }
        }
        
        // íŒŒì¼ í¬ê¸° í¬ë§·
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ì—…ë¡œë“œ ì§„í–‰ë¥  í‘œì‹œ
        function showUploadProgress(message) {
            const progressContainer = document.getElementById('uploadProgress');
            const statusEl = document.getElementById('uploadStatus');
            const percentEl = document.getElementById('uploadPercent');
            const progressBar = document.getElementById('fileProgressBar');
            
            statusEl.textContent = message;
            percentEl.textContent = '0%';
            progressBar.style.width = '0%';
            progressContainer.style.display = 'block';
        }
        
        function updateUploadProgress(message, percent) {
            const statusEl = document.getElementById('uploadStatus');
            const percentEl = document.getElementById('uploadPercent');
            const progressBar = document.getElementById('fileProgressBar');
            
            statusEl.textContent = message;
            percentEl.textContent = percent + '%';
            progressBar.style.width = percent + '%';
        }
        
        function hideUploadProgress() {
            const progressContainer = document.getElementById('uploadProgress');
            progressContainer.style.display = 'none';
        }
        
        // ğŸ”¥ ìƒˆë¡œìš´ ì—ëŸ¬ ì²˜ë¦¬ ë° ì‚¬ìš©ì í”¼ë“œë°± í•¨ìˆ˜ë“¤
        
        // íŒŒì¼ ì—…ë¡œë“œ ì „ ê²€ì¦ (ì™„í™”ëœ ë²„ì „)
        function validateFileBeforeUpload(file) {
            const errors = [];
            
            // íŒŒì¼ í¬ê¸° ê²€ì¦
            if (file.size > 50 * 1024 * 1024) { // 50MB
                errors.push('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤ (50MB ì´í•˜)');
            }
            
            if (file.size === 0) {
                errors.push('ë¹ˆ íŒŒì¼ì…ë‹ˆë‹¤');
            }
            
            // ğŸ”¥ íŒŒì¼ëª… ê¸¸ì´ë§Œ ê²€ì¦ (íŠ¹ìˆ˜ë¬¸ì ëª¨ë‘ í—ˆìš©)
            if (file.name.length > 255) {
                errors.push('íŒŒì¼ëª…ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤ (ìµœëŒ€ 255ì)');
            }
            
            // ğŸ”¥ íŒŒì¼ëª…ì´ ë¹„ì–´ìˆëŠ”ì§€ë§Œ í™•ì¸
            if (!file.name || file.name.trim() === '') {
                errors.push('íŒŒì¼ëª…ì´ ì—†ìŠµë‹ˆë‹¤');
            }
            
            // íŒŒì¼ í™•ì¥ì ê²€ì¦ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
            const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx', '.txt', '.zip', '.rar', '.7z', '.hwp']; // ğŸ”¥ .hwp, .7z ì¶”ê°€
            const lastDotIndex = file.name.lastIndexOf('.');
            
            if (lastDotIndex === -1) {
                errors.push('íŒŒì¼ í™•ì¥ìê°€ ì—†ìŠµë‹ˆë‹¤');
            } else {
                const extension = file.name.toLowerCase().substring(lastDotIndex);
                
                if (!allowedExtensions.includes(extension)) {
                    errors.push(`ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤ (${extension})`);
                }
                
                // ğŸ”¥ ì‹¤í–‰ íŒŒì¼ í™•ì¥ìë§Œ ê¸ˆì§€ (ë³´ì•ˆ)
                const forbiddenExtensions = ['.exe', '.bat', '.cmd', '.scr', '.vbs', '.com', '.pif', '.application', '.gadget', '.msi', '.msp', '.hta'];
                if (forbiddenExtensions.includes(extension)) {
                    errors.push('ë³´ì•ˆìƒ ì—…ë¡œë“œí•  ìˆ˜ ì—†ëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤');
                }
            }
            
            return {
                isValid: errors.length === 0,
                error: errors.join(', ')
            };
        }
        
        // ì—ëŸ¬ ì•Œë¦¼ í‘œì‹œ (ì‚¬ìš©ì ì¹œí™”ì )
        function showErrorAlert(filename, message) {
            // ê¸°ì¡´ alert ëŒ€ì‹  ì˜ˆìœ ì•Œë¦¼ ì‚¬ìš©
            const alertHTML = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <strong>${filename}</strong><br>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', alertHTML);
            
            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                const alerts = document.querySelectorAll('.alert-danger');
                alerts.forEach(alert => {
                    if (alert.querySelector('.btn-close')) {
                        alert.remove();
                    }
                });
            }, 5000);
        }
        
        // ì—…ë¡œë“œ ê²°ê³¼ í‘œì‹œ
        function showUploadResults(results) {
            const { success, failed } = results;
            const totalFiles = success.length + failed.length;
            
            if (success.length > 0 && failed.length === 0) {
                // ëª¨ë‘ ì„±ê³µ
                showSuccessMessage(`${success.length}ê°œ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else if (success.length > 0 && failed.length > 0) {
                // ì¼ë¶€ ì„±ê³µ
                showWarningMessage(`${success.length}ê°œ íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ, ${failed.length}ê°œ íŒŒì¼ ì‹¤íŒ¨`);
                
                // ì‹¤íŒ¨ íŒŒì¼ ìƒì„¸ ì •ë³´ í‘œì‹œ
                failed.forEach(failedFile => {
                    showErrorAlert(failedFile.filename, failedFile.error);
                });
            } else if (failed.length > 0) {
                // ëª¨ë‘ ì‹¤íŒ¨
                showErrorMessage('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                
                // ì‹¤íŒ¨ íŒŒì¼ ìƒì„¸ ì •ë³´ í‘œì‹œ
                failed.forEach(failedFile => {
                    showErrorAlert(failedFile.filename, failedFile.error);
                });
            }
        }
        
        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ë“¤
        function showSuccessMessage(message) {
            showNotification(message, 'success');
        }
        
        function showWarningMessage(message) {
            showNotification(message, 'warning');
        }
        
        function showErrorMessage(message) {
            showNotification(message, 'danger');
        }
        
        function showNotification(message, type = 'info') {
            const alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <i class="bi bi-${getAlertIcon(type)} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', alertHTML);
            
            // ìë™ ì œê±° (ì„±ê³µ: 3ì´ˆ, ê²½ê³ /ì—ëŸ¬: 7ì´ˆ)
            const autoRemoveTime = type === 'success' ? 3000 : 7000;
            setTimeout(() => {
                const alerts = document.querySelectorAll(`.alert-${type}`);
                alerts.forEach(alert => {
                    if (alert.querySelector('.btn-close')) {
                        alert.remove();
                    }
                });
            }, autoRemoveTime);
        }
        
        function getAlertIcon(type) {
            switch (type) {
                case 'success': return 'check-circle';
                case 'warning': return 'exclamation-triangle';
                case 'danger': return 'x-circle';
                default: return 'info-circle';
            }
        }
        
        // ğŸ”¥ =========== ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ===========
        
        /**
         * ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„¤ì •
         */
        function setupImageDragAndDrop(editor) {
            const editable = editor.editing.view.document.getRoot();
            const domEditable = editor.editing.view.domConverter.viewToDom(editable);
            
            // ë“œë˜ê·¸ ì˜¤ë²„ ì´ë²¤íŠ¸
            domEditable.addEventListener('dragover', (e) => {
                e.preventDefault();
                domEditable.classList.add('drag-over');
            });
            
            domEditable.addEventListener('dragleave', (e) => {
                e.preventDefault();
                domEditable.classList.remove('drag-over');
            });
            
            // ë“œë¡­ ì´ë²¤íŠ¸
            domEditable.addEventListener('drop', async (e) => {
                e.preventDefault();
                domEditable.classList.remove('drag-over');
                
                const files = Array.from(e.dataTransfer.files).filter(file => 
                    file.type.startsWith('image/')
                );
                
                if (files.length > 0) {
                    console.log('ë“œë¡­ëœ ì´ë¯¸ì§€ íŒŒì¼:', files.length + 'ê°œ');
                    
                    for (const file of files) {
                        await uploadImageFile(file, editor);
                    }
                }
            });
        }
        
        /**
         * í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì„¤ì •
         */
        function setupClipboardImagePaste(editor) {
            const domEditable = editor.editing.view.domConverter.viewToDom(
                editor.editing.view.document.getRoot()
            );
            
            // í´ë¦½ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            domEditable.addEventListener('paste', async (e) => {
                const items = e.clipboardData.items;
                
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        e.preventDefault();
                        
                        console.log('í´ë¦½ë³´ë“œì—ì„œ ì´ë¯¸ì§€ ê°ì§€:', item.type);
                        
                        const file = item.getAsFile();
                        if (file) {
                            await uploadImageFile(file, editor);
                        }
                        break;
                    }
                }
                
                // Base64 ì´ë¯¸ì§€ ì²˜ë¦¬ (ëŒ€ì²´ ë°©ë²•)
                const htmlData = e.clipboardData.getData('text/html');
                if (htmlData && htmlData.includes('data:image/')) {
                    e.preventDefault();
                    
                    console.log('í´ë¦½ë³´ë“œì—ì„œ Base64 ì´ë¯¸ì§€ ê°ì§€');
                    
                    const matches = htmlData.match(/data:image\/[^;]+;base64,[^"]+/g);
                    if (matches) {
                        for (const base64Data of matches) {
                            await uploadBase64Image(base64Data, editor);
                        }
                    }
                }
            });
        }
        
        /**
         * ì—…ë¡œë“œ ì§„í–‰ë¥  ëª¨ë‹ˆí„°ë§ ì„¤ì •
         */
        function setupUploadProgressMonitoring(editor) {
            // CKEditor ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            editor.plugins.get('FileRepository').on('change:uploaded', (evt, name, value, oldValue) => {
                if (value > oldValue) {
                    console.log('ì—…ë¡œë“œ ì§„í–‰ë¥ :', Math.round(value * 100) + '%');
                    updateProgressBar(Math.round(value * 100));
                }
            });
        }
        
        /**
         * ì´ë¯¸ì§€ íŒŒì¼ ì—…ë¡œë“œ
         */
        async function uploadImageFile(file, editor) {
            try {
                showProgressBar('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...');
                
                // íŒŒì¼ í¬ê¸° ë° íƒ€ì… ê²€ì¦
                if (file.size > 10 * 1024 * 1024) { // 10MB ì œí•œ
                    throw new Error('ì´ë¯¸ì§€ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. (10MB ì´í•˜)');
                }
                
                if (!file.type.startsWith('image/')) {
                    throw new Error('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                }
                
                // FormData ìƒì„±
                const formData = new FormData();
                formData.append('upload', file);
                
                // ì„œë²„ì— ì—…ë¡œë“œ
                const response = await fetch('/api/board/images/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.uploaded) {
                    // ì—ë””í„°ì— ì´ë¯¸ì§€ ì‚½ì…
                    editor.model.change(writer => {
                        const imageElement = writer.createElement('imageBlock', {
                            src: result.url,
                            alt: result.fileName || 'ì—…ë¡œë“œëœ ì´ë¯¸ì§€'
                        });
                        
                        editor.model.insertContent(imageElement, editor.model.document.selection);
                    });
                    
                    console.log('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:', result.url);
                    hideProgressBar();
                } else {
                    throw new Error(result.error?.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');
                }
                
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                hideProgressBar();
                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        /**
         * Base64 ì´ë¯¸ì§€ ì—…ë¡œë“œ
         */
        async function uploadBase64Image(base64Data, editor) {
            try {
                showProgressBar('í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...');
                
                // ì„œë²„ì— Base64 ë°ì´í„° ì „ì†¡
                const response = await fetch('/api/board/images/paste', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageData: base64Data,
                        fileName: 'pasted-image-' + Date.now() + '.png'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.uploaded) {
                    // ì—ë””í„°ì— ì´ë¯¸ì§€ ì‚½ì…
                    editor.model.change(writer => {
                        const imageElement = writer.createElement('imageBlock', {
                            src: result.url,
                            alt: result.fileName || 'ë¶™ì—¬ë„£ì€ ì´ë¯¸ì§€'
                        });
                        
                        editor.model.insertContent(imageElement, editor.model.document.selection);
                    });
                    
                    console.log('Base64 ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:', result.url);
                    hideProgressBar();
                } else {
                    throw new Error(result.error?.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');
                }
                
            } catch (error) {
                console.error('Base64 ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                hideProgressBar();
                alert('í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        /**
         * ì§„í–‰ë¥  í‘œì‹œ
         */
        function showProgressBar(message) {
            const progressEl = document.getElementById('imageUploadProgress');
            const textEl = progressEl.querySelector('.upload-text');
            const barEl = document.getElementById('imageProgressBar');
            
            textEl.textContent = message;
            barEl.style.width = '0%';
            progressEl.style.display = 'block';
        }
        
        function updateProgressBar(percent) {
            const barEl = document.getElementById('imageProgressBar');
            barEl.style.width = percent + '%';
        }
        
        function hideProgressBar() {
            const progressEl = document.getElementById('imageUploadProgress');
            progressEl.style.display = 'none';
        }
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            const categorySelect = document.getElementById('categorySelect');
            if (categorySelect.value) {
                categorySelect.dispatchEvent(new Event('change'));
            }
            
            // ğŸ”¥ ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ì´ˆê¸°í™”
            initializeFileUpload();
        });
        
        // ğŸ”¥ CKEditor ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¸°ëŠ¥ ì´ˆê¸°í™”
        ClassicEditor
            .create(document.querySelector('#content'), {
                toolbar: [
                    'heading', '|',
                    'bold', 'italic', 'underline', '|',
                    'link', 'imageUpload', '|', // ğŸ”¥ ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ ì¶”ê°€
                    'bulletedList', 'numberedList', '|',
                    'blockQuote', 'insertTable', '|',
                    'undo', 'redo'
                ],
                language: 'ko',
                // ğŸ”¥ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„¤ì •
                simpleUpload: {
                    uploadUrl: '/api/board/images/upload',
                    withCredentials: true,
                    headers: {
                        'X-CSRF-TOKEN': 'CSRF-Token'
                    }
                },
                // ğŸ”¥ ì´ë¯¸ì§€ ì‚½ì… ì„¤ì •
                image: {
                    toolbar: [
                        'imageTextAlternative', 'toggleImageCaption', '|',
                        'imageStyle:inline', 'imageStyle:wrapText', 'imageStyle:breakText', '|',
                        'resizeImage'
                    ],
                    resizeOptions: [
                        {
                            name: 'resizeImage:original',
                            label: 'ì›ë³¸ í¬ê¸°',
                            value: null
                        },
                        {
                            name: 'resizeImage:50',
                            label: '50%',
                            value: '50'
                        },
                        {
                            name: 'resizeImage:75',
                            label: '75%',
                            value: '75'
                        }
                    ]
                },
                // ğŸ”¥ í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ í™œì„±í™”
                clipboard: {
                    allowedContent: 'img[src,alt,width,height,style]; *'
                }
            })
            .then(newEditor => {
                editor = newEditor;
                console.log('CKEditor ì´ë¯¸ì§€ ê¸°ëŠ¥ ì´ˆê¸°í™” ì™„ë£Œ');
                
                // ğŸ”¥ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ì¶”ê°€
                setupImageDragAndDrop(editor);
                
                // ğŸ”¥ í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ ì¶”ê°€
                setupClipboardImagePaste(editor);
                
                // ğŸ”¥ ì—…ë¡œë“œ ì§„í–‰ë¥  ëª¨ë‹ˆí„°ë§
                setupUploadProgressMonitoring(editor);
                
            })
            .catch(error => {
                console.error('CKEditor ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            });
        
        // í¼ ì œì¶œ
        document.getElementById('writeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // ğŸ”¥ ê°„ì†Œí™”ëœ í¼ ìœ íš¨ì„± ê²€ì‚¬
            const titleEl = document.getElementById('title');
            const categoryEl = document.getElementById('categorySelect');
            
            const title = titleEl.value.trim();
            const categoryId = categoryEl.value;
            
            // CKEditor ë˜ëŠ” textareaì—ì„œ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
            let content = '';
            if (editor) {
                content = editor.getData().trim();
            } else {
                content = document.getElementById('content').value.trim();
            }
            
            console.log('=== í¼ ê²€ì¦ ì‹œì‘ ===');
            console.log('ì œëª©:', title);
            console.log('ì¹´í…Œê³ ë¦¬ ID:', categoryId);
            console.log('ë‚´ìš© ê¸¸ì´:', content.length);
            console.log('ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:', content.substring(0, 100));
            
            if (!categoryId) {
                alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                categoryEl.focus();
                return;
            }
            
            if (!title) {
                alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                titleEl.focus();
                return;
            }
            
            if (!content || content === '<p>&nbsp;</p>' || content === '<p></p>') {
                alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                if (editor) {
                    editor.editing.view.focus();
                } else {
                    document.getElementById('content').focus();
                }
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            try {
                // ë²„íŠ¼ ë¹„í™œì„±í™”
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ì²˜ë¦¬ ì¤‘...';
                
                // ğŸ”¥ JSONìœ¼ë¡œ ë°ì´í„° ì „ì†¡ (FormData ëŒ€ì‹ )
                const postData = {
                    title: title,
                    content: content,
                    category_id: categoryId,
                    source: document.getElementById('source').value.trim(),
                    ccl: document.getElementById('ccl').value
                };
                
                // ê´€ë¦¬ì ì˜µì…˜ ì¶”ê°€
                const isNoticeCheckbox = document.getElementById('isNotice');
                const isPinnedCheckbox = document.getElementById('isPinned');
                
                if (isNoticeCheckbox && isNoticeCheckbox.checked) {
                    postData.is_notice = '1';
                }
                if (isPinnedCheckbox && isPinnedCheckbox.checked) {
                    postData.is_pinned = '1';
                }
                
                // ğŸ”¥ ì²¨ë¶€íŒŒì¼ ì •ë³´ ì¶”ê°€
                if (uploadedAttachments.length > 0) {
                    postData.attachments = uploadedAttachments;
                }
                
                console.log('=== ì „ì†¡í•  ë°ì´í„° ===');
                console.log(JSON.stringify(postData, null, 2));
                
                // ì„œë²„ì— ì „ì†¡ (JSON)
                const postId = '<%= mode === "edit" && post && post.id ? post.id : "" %>';
                
                let url, method;
                if ('<%= mode %>' === 'edit' && postId) {
                    url = `/api/board/posts/${postId}`;
                    method = 'PUT';
                } else {
                    url = '/api/board/posts';
                    method = 'POST';
                }
                
                console.log('ìš”ì²­ URL:', url);
                console.log('ìš”ì²­ ë°©ë²•:', method);
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });

                console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
                        
                if (response.ok) {
                    const result = await response.json();
                    console.log('ì„œë²„ ì‘ë‹µ:', result);
                    
                    if (result.success) {
                        alert('<%= mode === "edit" ? "ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤." : "ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤." %>');
                        
                        // ğŸ”¥ ìˆ˜ì •: ê²Œì‹œíŒ ë©”ì¸ìœ¼ë¡œ ì´ë™ (ì¹´í…Œê³ ë¦¬ë³„ ëª©ë¡ì€ ì‚¬ìš©ìê°€ ì„ íƒ)
                        window.location.href = '/board';
                    } else {
                        throw new Error(result.error || 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                } else {
                    const errorResult = await response.json();
                    console.error('ì„œë²„ ì˜¤ë¥˜ ì‘ë‹µ:', errorResult);
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status}): ${errorResult.error || errorResult.details || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error('í¼ ì œì¶œ ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                // ë²„íŠ¼ ë³µì›
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    </script>

    <%- include('../partials/footer') %>
</body>
</html>