<!DOCTYPE html>
<html lang="ko">
<%- include('partials/header') %>

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì½”ë”©ì•¤í”Œë ˆì´ - ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œ</title>

        <!-- ê¸°ë³¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
        <script src="https://apis.google.com/js/api.js"></script>

        <!-- Bootstrap ë° ì•„ì´ì½˜ -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
        <!-- Font Awesome ì¶”ê°€ (íŒŒì´ì¬ ë¸Œëœë“œ ì•„ì´ì½˜ì„ ìœ„í•´) -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

        <!-- CSS ë¡œë“œ ìˆœì„œ - ê¸°ë³¸ â†’ ì»´í¬ë„ŒíŠ¸ë³„ â†’ ì „ì—­ ìŠ¤íƒ€ì¼ -->
        <link rel="stylesheet" href="/css/common-layout.css?v=1.1">
        <link rel="stylesheet" href="/css/components/navigation.css">
        <link rel="stylesheet" href="/css/common-content.css">
        <link rel="stylesheet" href="/css/common-ide.css">
        <link rel="stylesheet" href="/css/common-quiz.css">
        <link rel="stylesheet" href="/css/ppt-viewer.css">
        <link rel="stylesheet" href="/css/styles.css">
        <link rel="stylesheet" href="/css/components/explanation.css">
        <link rel="stylesheet" href="/css/components/layout-toggle.css">
        <link rel="stylesheet" href="/css/components/jupyter.css">
        <!-- Ace Editor -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.8/ace.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.8/ext-language_tools.js"></script>

        <!-- ğŸ”¥ Pyodide (pythontest í˜ì´ì§€ ì „ìš©) -->
        <% if (typeof pageType !=='undefined' && pageType==='pythontest' ) { %>
            <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
            <script src="/js/components/ide/PyodideTerminal.js"></script>
            <% } %>

                <!-- ğŸ”¥ IDE ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ - ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œë³´ë‹¤ ë¨¼ì € ë¡œë“œ -->
                <script src="/js/components/ide/CodeEditor.js"></script>
                <script src="/js/components/ide/Terminal.js"></script>
                <script src="/js/components/ide/TerminalInput.js"></script>
                <script src="/js/components/ide/TerminalResize.js"></script>

                <!-- Python ìë™ì™„ì„± (ì„ íƒì ) -->
                <script src="/js/components/ide/PythonAutoCompleter.js"></script>

                <script>
                    // ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
                    console.log('ì„œë²„ì—ì„œ ì „ë‹¬ëœ í˜ì´ì§€ íƒ€ì…:', '<%= typeof pageType !== "undefined" ? pageType : "undefined" %>');

                    // í˜ì´ì§€ íƒ€ì… ì„¤ì • (ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ê°’ì„ ìš°ì„  ì‚¬ìš©)
                    window.PAGE_TYPE = '<%= typeof pageType !== "undefined" ? pageType : "template" %>';
                    window.USE_COMPONENT_SYSTEM = true;

                    // HTML ìš”ì†Œì—ë„ ë°ì´í„° ì†ì„±ìœ¼ë¡œ ì„¤ì •
                    document.documentElement.dataset.pageType = window.PAGE_TYPE;

                    console.log('Template í˜ì´ì§€ ì„¤ì •:', {
                        pageType: window.PAGE_TYPE,
                        useComponentSystem: window.USE_COMPONENT_SYSTEM,
                        htmlDataset: document.documentElement.dataset.pageType
                    });
                </script>
    </head>

    <body class="layout-html" data-page-type="template">
        <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
        <div class="main-container">
            <!-- ì™¼ìª½ ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ -->
            <div id="navigation-component" class="nav-container component">
                <ul id="navList" class="list-unstyled">
                </ul>
            </div>

            <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
            <div id="mainArea" class="mainArea">
                <!-- ì½˜í…ì¸  ì»´í¬ë„ŒíŠ¸ -->
                <div id="content-component" class="content-container component component-visible">
                    <!-- ë„ˆë¹„ ì¡°ì ˆ í•¸ë“¤ -->
                    <div id="content-width-resize-handle" class="content-width-resize-handle" style="display: none;">
                        <div class="resize-handle-grip"></div>
                    </div>

                    <div class="problem-top-nav">
                        <div id="problem-title" class="problem-title"></div>
                        <div id="problem-navigation-container" class="problem-navigation-container">
                            <i class="bi bi-chevron-left" id="prev-problem"></i>
                            <div id="problem-navigation" class="problem-navigation"></div>
                            <i class="bi bi-chevron-right" id="next-problem"></i>
                        </div>
                        <!-- ğŸ”¥ ìˆ˜ì •: ë ˆì´ì•„ì›ƒ í† ê·¸ ë²„íŠ¼ ë…ë¦½ ë°°ì¹˜ (10% ì˜ì—­) -->
                        <button id="layout-toggle-btn" title="IDE í¼ì¹˜ê¸°/ì ‘ê¸°" aria-label="IDE ë ˆì´ì•„ì›ƒ í† ê¸€">
                            <i class="bi bi-layout-sidebar-reverse" id="layout-toggle-icon"></i>
                            <i class="bi bi-layout-sidebar" id="layout-toggle-icon-alt" style="display: none;"></i>
                        </button>
                    </div>

                    <div id="problem-container" class="problem-container">
                        <iframe id="iframeContent" src="about:blank" class="content-iframe"></iframe>
                    </div>

                    <!-- ğŸ”¥ ì¶”ê°€: ìš°ì¸¡ í•˜ë‹¨ í”Œë¡œíŒ… í°íŠ¸ ì»¨íŠ¸ë¡¤ -->
                    <div class="content-floating-controls">
                        <button id="content-font-increase" class="floating-btn" title="í°íŠ¸ í™•ëŒ€">
                            <i class="bi bi-plus"></i>
                        </button>
                        <button id="content-font-decrease" class="floating-btn" title="í°íŠ¸ ì¶•ì†Œ">
                            <i class="bi bi-dash"></i>
                        </button>
                    </div>
                </div>

                <!-- IDE ì»´í¬ë„ŒíŠ¸ -->
                <div id="ide-component" class="ide-container component component-hidden">
                    <!-- ğŸ”¥ ì¶”ê°€: ë„ˆë¹„ ì¡°ì ˆìš© ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ -->
                    <div id="ide-width-resize-handle" class="width-resize-handle" title="ë“œë˜ê·¸í•˜ì—¬ IDE ë„ˆë¹„ ì¡°ì •">
                        <div class="width-resize-handle-line"></div>
                    </div>

                    <div class="code-editor-container">
                        <div class="code-editor-top-bar">
                            <div class="code-editor-title">
                                <!-- Font Awesome Python ë¸Œëœë“œ ì•„ì´ì½˜ -->
                                <i class="fab fa-python"
                                    style="color: #3776ab; font-size: 24px; margin-right: 8px; vertical-align: middle;"></i>
                                <span style="font-weight: 600;">Python</span>
                            </div>
                            <div class="code-editor-controls" style="display: flex; align-items: center; gap: 8px;">
                                <!-- ğŸ”¥ IDE í°íŠ¸ í¬ê¸° ì¡°ì ˆ ë²„íŠ¼ ê·¸ë£¹ ìˆ˜ì • -->
                                <div class="ide-font-controls d-flex align-items-center me-3">
                                    <div class="btn-group" role="group" aria-label="IDE ì»¨íŠ¸ë¡¤">
                                        <button id="font-decrease"
                                            class="btn btn-sm btn-outline-secondary ide-control-btn" title="í°íŠ¸ í¬ê¸° ì¤„ì´ê¸°">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <button id="font-increase"
                                            class="btn btn-sm btn-outline-secondary ide-control-btn" title="í°íŠ¸ í¬ê¸° ëŠ˜ë¦¬ê¸°">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                        <!-- ì›ë³¸ ë³µì› ë²„íŠ¼ ìœ„ì¹˜ (CodeEditor.jsì—ì„œ ë™ì  ìƒì„±) -->
                                        <div id="restore-button-slot" class="restore-button-slot"></div>
                                        <button id="download-code-btn"
                                            class="btn btn-sm btn-outline-secondary ide-control-btn" title="ì½”ë“œ ë‹¤ìš´ë¡œë“œ">
                                            <i class="bi bi-download"></i>
                                        </button>
                                    </div>
                                </div>


                                <!-- ğŸ”¥ ë³µì› ë²„íŠ¼ ê·¸ë£¹ (ì •ë‹µë³´ê¸° ë²„íŠ¼ ì™¼ìª½ì— ë°°ì¹˜) -->
                                <div class="editor-button-group" style="display: flex; align-items: center; gap: 8px;">
                                    <!-- ë³µì› ë²„íŠ¼ì€ CodeEditor.jsì˜ createRestoreButton()ì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                                </div>

                                <!-- ğŸ”¥ ì¶”ê°€: í•´ì„¤ ë²„íŠ¼ -->
                                <button id="ide-explanation-btn">
                                    íŒíŠ¸
                                </button>

                                <!-- êµì‚¬/ê´€ë¦¬ììš© ì •ë‹µë³´ê¸° ë²„íŠ¼ -->
                                <% if (role==='teacher' || role==='admin' || role==='manager' ) { %>
                                    <button id="showAnswerBtn">
                                        ì •ë‹µ
                                    </button>
                                    <% } %>

                                        <button id="runCodeBtn" class="btn btn-success btn-sm">
                                            <i class="bi bi-play-fill"></i> ì½”ë“œ ì‹¤í–‰
                                        </button>

                                        <div class="ide-selector ms-2">
                                            <div class="btn-group btn-group-sm" role="group" aria-label="IDE ì„ íƒ">
                                                <button type="button" class="btn btn-outline-primary active"
                                                    id="ace-btn">ACE Editor</button>
                                                <button type="button" class="btn btn-outline-primary"
                                                    id="jupyter-btn">Jupyter</button>
                                            </div>
                                        </div>
                            </div>
                        </div>

                        <!-- ACE ì—ë””í„° ì»¨í…Œì´ë„ˆ -->
                        <div id="ace-editor-inner" class="ide-container-inner active">
                            <!-- ì—ë””í„° ì˜ì—­ -->
                            <div class="editor-area">
                                <div id="editor" class="code-editor"></div>
                            </div>

                            <!-- ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ -->
                            <div id="ide-resize-handle" class="resize-handle" title="ë“œë˜ê·¸í•˜ì—¬ í„°ë¯¸ë„ í¬ê¸° ì¡°ì •">
                                <div class="resize-handle-line"></div>
                            </div>

                            <!-- í„°ë¯¸ë„ ì˜ì—­ -->
                            <div class="output-container" style="flex: 0 0 200px; min-height: 200px;">
                                <div class="output-title">
                                    <div>ì‹¤í–‰ ê²°ê³¼</div>
                                    <div class="terminal-controls">
                                        <button id="terminal-maximize-btn" class="btn btn-outline-secondary btn-sm me-2"
                                            title="ìµœëŒ€í™”">
                                            <i class="bi bi-arrows-expand"></i>
                                        </button>
                                        <button id="clearOutputBtn" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-trash"></i> ê²°ê³¼ ì§€ìš°ê¸°
                                        </button>
                                    </div>
                                </div>
                                <div id="output-content" class="output-content">
                                    <!-- ì‹¤í–‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                </div>
                            </div>
                        </div>

                        <!-- Jupyter ì»¨í…Œì´ë„ˆ (í•„ìš”ì‹œ) -->
                        <div id="jupyter-ide-container">
                            <div id="jupyter-auth-message" style="display: none;"></div>
                            <iframe id="jupyter-frame" style="display: none;"></iframe>
                        </div>
                    </div>
                </div>

                <!-- í€´ì¦ˆ ì»´í¬ë„ŒíŠ¸ -->
                <div id="quiz-component" class="quiz-container component component-hidden">
                    <div class="quiz-wrapper">
                        <div class="quiz-loading" id="quiz-loading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>

                        <div class="quiz-main" id="quiz-main" style="display: none;">
                            <div class="quiz-header">
                                <h4 class="quiz-title" id="quiz-title">ë¬¸ì œ</h4>
                                <div class="quiz-meta" id="quiz-meta">
                                    <span class="badge bg-info" id="quiz-type">ê°ê´€ì‹</span>
                                    <span class="badge bg-secondary" id="quiz-points">1ì </span>
                                </div>
                            </div>

                            <div class="quiz-problem" id="quiz-problem">
                                <!-- ë¬¸ì œ ë‚´ìš©ì€ ContentComponentì˜ iframeê³¼ ì—°ë™ -->
                                <p class="text-muted">ë¬¸ì œë¥¼ ì„ íƒí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>

                            <div class="quiz-answer-section" id="quiz-answer-section">
                                <!-- ë‹µì•ˆ ì…ë ¥ UIê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                            </div>

                            <div class="quiz-actions" id="quiz-actions">
                                <button class="btn btn-primary" id="submit-answer-btn" disabled>ë‹µì•ˆ ì œì¶œ</button>
                                <button class="btn btn-secondary" id="reset-answer-btn" style="display: none;">ë‹¤ì‹œ
                                    í’€ê¸°</button>
                            </div>

                            <div class="quiz-result" id="quiz-result" style="display: none;">
                                <!-- ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë¨ -->
                            </div>
                        </div>

                        <div class="quiz-no-data" id="quiz-no-data" style="display: block;">
                            <div class="text-center text-muted">
                                <i class="bi bi-question-circle" style="font-size: 3rem;"></i>
                                <p class="mt-3">í€´ì¦ˆ ë¬¸ì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PPT ë·°ì–´ ì»´í¬ë„ŒíŠ¸ -->
                <div id="ppt-viewer-component" class="ppt-viewer component component-hidden">
                    <!-- PPT ë·°ì–´ëŠ” ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>

                <!-- Jupyter ì»´í¬ë„ŒíŠ¸ -->
                <div id="jupyter-component" class="jupyter-container component component-hidden">
                    <!-- JupyterComponent.jsì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥˜ ë° ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
        <div id="system-messages" class="system-messages"
            style="display: none; position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
        </div>

        <!-- ğŸ”¥ ì¶”ê°€: í•´ì„¤ íŒì—… HTML êµ¬ì¡° -->
        <div id="explanation-popup" class="explanation-popup" style="display: none;">
            <div class="popup-header">
                <div class="popup-title">
                    <i class="bi bi-lightbulb"></i>
                    <span id="explanation-title">ë¬¸ì œ í•´ì„¤</span>
                </div>
                <button class="popup-close-btn" id="explanation-close-btn" type="button">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="popup-content">
                <div class="explanation-loading" id="explanation-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>í•´ì„¤ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>

                <div class="explanation-body" id="explanation-body">
                    <!-- ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ëœ í•´ì„¤ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>

                <div class="explanation-error" id="explanation-error" style="display: none;">
                    <p class="text-danger">í•´ì„¤ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>

        <!-- ìŠ¤í¬ë¦½íŠ¸ -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        <!-- marked.js - ë§ˆí¬ë‹¤ìš´ íŒŒì„œ -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>

        <!-- highlight.js - ì½”ë“œ í•˜ì´ë¼ì´íŒ… (ì„ íƒì‚¬í•­) -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

        <!-- ì¶”ê°€ ì–¸ì–´ ì§€ì› (í•„ìš”í•œ ê²½ìš°) -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>

        <!-- í´ë°± ë° ì˜¤ë¥˜ ì²˜ë¦¬ -->
        <script>
            // ê¸°ë³¸ ì»´í¬ë„ŒíŠ¸ í´ë˜ìŠ¤ ì •ì˜
            if (!window.Component) {
                window.Component = class Component {
                    constructor(options = {}) {
                        this.options = options;
                        this.elementId = options.elementId;
                        this.element = null;
                        this.initialized = false;
                        this.visible = options.visible !== undefined ? options.visible : false;
                    }

                    async init() {
                        this.element = document.getElementById(this.elementId);
                        this.initialized = true;
                        return true;
                    }

                    activate() {
                        console.log(`${this.elementId} ì»´í¬ë„ŒíŠ¸ í™œì„±í™”`);
                    }

                    deactivate() {
                        console.log(`${this.elementId} ì»´í¬ë„ŒíŠ¸ ë¹„í™œì„±í™”`);
                    }
                };
            }

            // ì´ë²¤íŠ¸ ë²„ìŠ¤ í´ë°±
            if (!window.EventBus) {
                window.EventBus = {
                    events: {},
                    subscribe(event, callback) {
                        if (!this.events[event]) this.events[event] = [];
                        this.events[event].push(callback);
                        return () => {
                            this.events[event] = this.events[event].filter(cb => cb !== callback);
                        };
                    },
                    publish(event, data) {
                        if (!this.events[event]) return;
                        this.events[event].forEach(callback => {
                            try {
                                callback(data);
                            } catch (error) {
                                console.error(`'${event}' ì´ë²¤íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, error);
                            }
                        });
                    }
                };
            }

            // ğŸ”¥ ìƒˆë¡œ ì¶”ê°€: í°íŠ¸ í¬ê¸° ì¡°ì ˆ ê¸°ëŠ¥
            let currentFontSize = 16; // ê¸°ë³¸ í°íŠ¸ í¬ê¸°

            function adjustContentFontSize(delta) {
                const iframe = document.getElementById('iframeContent');
                if (!iframe) return;

                currentFontSize = Math.max(12, Math.min(24, currentFontSize + delta));

                // iframe ë‚´ë¶€ ìŠ¤íƒ€ì¼ ì¡°ì •
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc && iframeDoc.body) {
                        iframeDoc.body.style.fontSize = currentFontSize + 'px';
                        console.log('ì½˜í…ì¸  í°íŠ¸ í¬ê¸° ë³€ê²½:', currentFontSize + 'px');
                    }
                } catch (error) {
                    console.warn('iframe í°íŠ¸ í¬ê¸° ì¡°ì • ì‹¤íŒ¨:', error);
                }
            }

            // ğŸ”¥ í°íŠ¸ í¬ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.addEventListener('DOMContentLoaded', function () {
                const fontDecreaseBtn = document.getElementById('content-font-decrease');
                const fontIncreaseBtn = document.getElementById('content-font-increase');

                if (fontDecreaseBtn) {
                    fontDecreaseBtn.addEventListener('click', function () {
                        adjustContentFontSize(-1);
                    });
                    console.log('í°íŠ¸ ì¶•ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°ë¨');
                }

                if (fontIncreaseBtn) {
                    fontIncreaseBtn.addEventListener('click', function () {
                        adjustContentFontSize(1);
                    });
                    console.log('í°íŠ¸ í™•ëŒ€ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°ë¨');
                }

                // ì›ë³¸ ë³µì› ë²„íŠ¼ì€ CodeEditor.jsì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„± ë° ì²˜ë¦¬ë¨
            });

            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
            function showSystemMessage(message, type = 'info') {
                const messagesContainer = document.getElementById('system-messages');
                if (!messagesContainer) return;

                messagesContainer.style.display = 'block';

                const messageElement = document.createElement('div');
                messageElement.className = `alert alert-${type} alert-dismissible fade show`;
                messageElement.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

                messagesContainer.appendChild(messageElement);

                setTimeout(() => {
                    messageElement.classList.remove('show');
                    setTimeout(() => {
                        if (messagesContainer.contains(messageElement)) {
                            messagesContainer.removeChild(messageElement);
                            if (messagesContainer.children.length === 0) {
                                messagesContainer.style.display = 'none';
                            }
                        }
                    }, 300);
                }, 5000);
            }

            // ğŸ”¥ ì¶”ê°€: Jupyter ê´€ë¦¬ í•¨ìˆ˜ë“¤
            function retryJupyter() {
                console.log('Jupyter ë‹¤ì‹œ ì‹œë„');
                const jupyterError = document.getElementById('jupyter-error');
                const jupyterLoading = document.getElementById('jupyter-loading');

                if (jupyterError) jupyterError.style.display = 'none';
                if (jupyterLoading) jupyterLoading.style.display = 'block';

                // ContentComponentì—ì„œ Jupyter ë¡œë“œ ë‹¤ì‹œ ì‹œë„
                if (window.ComponentSystem && window.ComponentSystem.components.content) {
                    const content = window.ComponentSystem.components.content;
                    if (content.retryJupyterLoad) {
                        content.retryJupyterLoad();
                    }
                }
            }

            function refreshJupyter() {
                console.log('Jupyter ìƒˆë¡œê³ ì¹¨');
                const jupyterIframe = document.getElementById('jupyter-iframe');
                if (jupyterIframe && jupyterIframe.src !== 'about:blank') {
                    jupyterIframe.src = jupyterIframe.src; // ë¦¬ë¡œë“œ
                }
            }

            function fullscreenJupyter() {
                console.log('Jupyter ì „ì²´í™”ë©´');
                const jupyterIframe = document.getElementById('jupyter-iframe');
                if (jupyterIframe) {
                    if (jupyterIframe.requestFullscreen) {
                        jupyterIframe.requestFullscreen();
                    } else if (jupyterIframe.webkitRequestFullscreen) {
                        jupyterIframe.webkitRequestFullscreen();
                    } else if (jupyterIframe.msRequestFullscreen) {
                        jupyterIframe.msRequestFullscreen();
                    }
                }
            }

            function downloadNotebook() {
                console.log('Jupyter ë…¸íŠ¸ë¶ ë‹¤ìš´ë¡œë“œ');
                // í˜„ì¬ ë¡œë“œëœ ë…¸íŠ¸ë¶ ë‹¤ìš´ë¡œë“œ ë¡œì§
                if (window.ComponentSystem && window.ComponentSystem.components.content) {
                    const content = window.ComponentSystem.components.content;
                    if (content.downloadCurrentNotebook) {
                        content.downloadCurrentNotebook();
                    } else {
                        showSystemMessage('ë‹¤ìš´ë¡œë“œí•  ë…¸íŠ¸ë¶ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    }
                }
            }

            // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì˜¤ë¥˜ ì²˜ë¦¬
            window.addEventListener('error', function (event) {
                if (event.target.tagName === 'SCRIPT') {
                    showSystemMessage(`ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì˜¤ë¥˜: ${event.target.src}`, 'danger');
                }
            }, true);
        </script>

        <!-- ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œ ê¸°ë³¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìˆœì„œëŒ€ë¡œ ë¡œë“œ -->
        <script>
            // ìŠ¤í¬ë¦½íŠ¸ ìˆœì°¨ ë¡œë“œ í•¨ìˆ˜
            function loadScriptsSequentially(scripts) {
                return scripts.reduce((promise, script) => {
                    return promise.then(() => {
                        return new Promise((resolve, reject) => {
                            const scriptElement = document.createElement('script');
                            scriptElement.src = script;
                            scriptElement.onload = resolve;
                            scriptElement.onerror = () => {
                                console.error(`ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${script}`);
                                reject(new Error(`Failed to load ${script}`));
                            };
                            document.head.appendChild(scriptElement);
                        });
                    });
                }, Promise.resolve());
            }

            // ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            function initializeComponentSystem() {
                // ê¸°ë³¸ ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸ë“¤
                const systemScripts = [
                    '/js/components/base/EventBus.js',
                    '/js/components/base/Component.js',
                    '/js/components/base/ComponentRegistry.js',
                    '/js/components/base/ComponentFactory.js'
                ];

                // ê°œë³„ ì»´í¬ë„ŒíŠ¸ ìŠ¤í¬ë¦½íŠ¸ë“¤
                const componentScripts = [
                    '/js/components/nav/NavigationComponent.js',
                    '/js/components/content/ContentComponent.js',
                    '/js/components/ide/IDEComponent.js',
                    '/js/components/jupyter/JupyterComponent.js',
                    '/js/components/quiz/QuizComponent.js',
                    '/js/components/ppt/PPTViewerComponent.js',
                    '/js/components/popup/ExplanationPopup.js'
                ];

                // í†µí•© ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸
                const integrationScripts = [
                    '/js/component-system.js'
                ];

                console.log('ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹œì‘...');

                // ìˆœì°¨ì ìœ¼ë¡œ ë¡œë“œ
                loadScriptsSequentially(systemScripts)
                    .then(() => {
                        console.log('ê¸°ë³¸ ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
                        return loadScriptsSequentially(componentScripts);
                    })
                    .then(() => {
                        console.log('ê°œë³„ ì»´í¬ë„ŒíŠ¸ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');

                        // ì»´í¬ë„ŒíŠ¸ ìë™ ë“±ë¡
                        setTimeout(() => {
                            console.log('ì»´í¬ë„ŒíŠ¸ ìë™ ë“±ë¡ ì‹œì‘...');

                            // ë“±ë¡í•  ì»´í¬ë„ŒíŠ¸ ëª©ë¡
                            const componentsToRegister = [
                                { name: 'navigation', className: 'NavigationComponent', elementId: 'navigation-component' },
                                { name: 'content', className: 'ContentComponent', elementId: 'content-component' },
                                { name: 'ide', className: 'IDEComponent', elementId: 'ide-component' },
                                { name: 'jupyter', className: 'JupyterComponent', elementId: 'jupyter-component' },
                                { name: 'quiz', className: 'QuizComponent', elementId: 'quiz-component' },
                                { name: 'pptViewer', className: 'PPTViewerComponent', elementId: 'ppt-viewer-component' },
                                { name: 'pythonAutoCompleter', className: 'PythonAutoCompleter' },
                                { name: 'explanationPopup', className: 'ExplanationPopup' } // ğŸ”¥ ì¶”ê°€: í•´ì„¤ íŒì—…
                            ];

                            componentsToRegister.forEach(comp => {
                                if (window[comp.className]) {
                                    if (window.ComponentFactory && window.ComponentFactory.register) {
                                        // ğŸ”¥ elementId ì „ë‹¬
                                        const options = comp.elementId ? { elementId: comp.elementId } : {};
                                        window.ComponentFactory.register(comp.name, window[comp.className], options);
                                        console.log(`ìë™ ë“±ë¡ ì™„ë£Œ: ${comp.name} -> ${comp.className} (elementId: ${comp.elementId || 'default'})`);
                                    } else {
                                        console.warn('ComponentFactory.registerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                    }
                                } else {
                                    console.warn(`${comp.className} í´ë˜ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                                }
                            });

                            console.log('ì»´í¬ë„ŒíŠ¸ ìë™ ë“±ë¡ ì™„ë£Œ');
                        }, 50);

                        return loadScriptsSequentially(integrationScripts);
                    })
                    .then(() => {
                        console.log('í†µí•© ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');

                        // ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” (í•œ ë²ˆë§Œ)
                        if (window.ComponentSystem && !window.ComponentSystem.state.initialized) {
                            setTimeout(() => {
                                console.log('ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘...');
                                window.ComponentSystem.init().catch(e => {
                                    console.error('ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
                                    showSystemMessage('ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                                });
                            }, 150);
                        }
                    })
                    .catch(error => {
                        console.error('ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                        showSystemMessage('í•„ìš”í•œ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.', 'danger');
                    });
            }

            // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™” (ì¤‘ë³µ ë°©ì§€)
            document.addEventListener('DOMContentLoaded', function () {
                if (!window.componentSystemInitialized) {
                    window.componentSystemInitialized = true;
                    initializeComponentSystem();
                }
            });
        </script>

        <!-- ğŸ”¥ ìƒˆë¡œ ì¶”ê°€: Jupyter ì»´í¬ë„ŒíŠ¸ ìë™ ë³µêµ¬ ì‹œìŠ¤í…œ -->
        <script>
            // Jupyter ì»´í¬ë„ŒíŠ¸ ìë™ ë³µêµ¬ ì‹œìŠ¤í…œ
            (function () {
                let jupyterCheckInterval;
                let checkCount = 0;
                const maxChecks = 10;

                function checkJupyterComponent() {
                    checkCount++;

                    const jupyter = window.ComponentSystem?.components?.jupyter;
                    const container = document.getElementById('jupyter-component');
                    const iframe = document.getElementById('jupyter-iframe');

                    console.log(`ğŸ” Jupyter ìƒíƒœ ì²´í¬ ${checkCount}/${maxChecks}:`, {
                        jupyter: !!jupyter,
                        container: !!container,
                        iframe: !!iframe,
                        initialized: jupyter?.state?.initialized,
                        connected: jupyter?.state?.connected
                    });

                    // Jupyter ì»´í¬ë„ŒíŠ¸ê°€ ìˆì§€ë§Œ ì œëŒ€ë¡œ ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ê²½ìš°
                    if (jupyter && (!jupyter.state?.initialized || !iframe)) {
                        console.log('ğŸ”§ Jupyter ì»´í¬ë„ŒíŠ¸ ìë™ ë³µêµ¬ ì‹¤í–‰...');

                        // ìˆ˜ë™ ì‹¤í–‰í–ˆë˜ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
                        try {
                            // 1. ê°•ì œ ì»¨í…Œì´ë„ˆ ì°¸ì¡° ì„¤ì •
                            if (!jupyter.elements.container) {
                                jupyter.elements.container = container || document.getElementById('jupyter-component');
                            }

                            // 2. ì»¨í…Œì´ë„ˆê°€ ìˆìœ¼ë©´ ì •ë¦¬ í›„ ì¬ìƒì„±
                            if (jupyter.elements.container) {
                                jupyter.elements.container.innerHTML = '';

                                // 3. ì»¨í…Œì´ë„ˆ ë° iframe ìƒì„±
                                jupyter.createJupyterContainer().then(() => {
                                    // 4. iframe ì°¸ì¡° ì—…ë°ì´íŠ¸
                                    jupyter.elements.iframe = document.getElementById('jupyter-iframe');

                                    // 5. ì—°ê²° ì‹œë„
                                    if (jupyter.elements.iframe) {
                                        jupyter.connectToJupyter();
                                        console.log('âœ… Jupyter ìë™ ë³µêµ¬ ì™„ë£Œ');
                                    }
                                }).catch(error => {
                                    console.error('âŒ Jupyter ìë™ ë³µêµ¬ ì‹¤íŒ¨:', error);
                                });
                            }

                        } catch (error) {
                            console.error('âŒ Jupyter ìë™ ë³µêµ¬ ì¤‘ ì˜¤ë¥˜:', error);
                        }
                    }

                    // ì²´í¬ ì™„ë£Œ ì¡°ê±´: ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ê±°ë‚˜ ìµœëŒ€ ì²´í¬ íšŸìˆ˜ ì´ˆê³¼
                    if ((jupyter?.state?.initialized && iframe) || checkCount >= maxChecks) {
                        clearInterval(jupyterCheckInterval);
                        console.log('ğŸ Jupyter ìƒíƒœ ì²´í¬ ì™„ë£Œ');
                    }
                }

                // í˜ì´ì§€ ë¡œë“œ í›„ ìë™ ì²´í¬ ì‹œì‘
                document.addEventListener('DOMContentLoaded', function () {
                    // 5ì´ˆ í›„ë¶€í„° 3ì´ˆ ê°„ê²©ìœ¼ë¡œ ì²´í¬
                    setTimeout(() => {
                        jupyterCheckInterval = setInterval(checkJupyterComponent, 3000);
                        checkJupyterComponent(); // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
                    }, 5000);
                });

                // ì „ì—­ í•¨ìˆ˜ë¡œ ìˆ˜ë™ ë³µêµ¬ ê¸°ëŠ¥ ì œê³µ
                window.fixJupyterComponent = function () {
                    const jupyter = window.ComponentSystem?.components?.jupyter;
                    if (jupyter) {
                        if (jupyter.reconnect) {
                            jupyter.reconnect();
                        } else {
                            // ìˆ˜ë™ ë³µêµ¬ ì‹¤í–‰
                            checkJupyterComponent();
                        }
                    } else {
                        console.error('Jupyter ì»´í¬ë„ŒíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                };

                // ì „ì—­ í•¨ìˆ˜ë¡œ ìƒíƒœ í™•ì¸ ê¸°ëŠ¥ ì œê³µ
                window.checkJupyter = function () {
                    const jupyter = window.ComponentSystem?.components?.jupyter;
                    if (jupyter) {
                        if (jupyter.getStatus) {
                            console.log('Jupyter ìƒíƒœ:', jupyter.getStatus());
                        } else {
                            console.log('Jupyter ê¸°ë³¸ ìƒíƒœ:', {
                                initialized: jupyter.state?.initialized,
                                connected: jupyter.state?.connected,
                                container: !!jupyter.elements?.container,
                                iframe: !!jupyter.elements?.iframe
                            });
                        }
                    } else {
                        console.log('Jupyter ì»´í¬ë„ŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }
                };

                // ê°•ì œ ì¬ìƒì„± í•¨ìˆ˜
                window.recreateJupyter = function () {
                    const componentSystem = window.ComponentSystem;
                    if (componentSystem && componentSystem.components.jupyter) {
                        // ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸ ì œê±°
                        delete componentSystem.components.jupyter;

                        // ìƒˆ ì»´í¬ë„ŒíŠ¸ ìƒì„±
                        if (window.JupyterComponent) {
                            componentSystem.components.jupyter = new window.JupyterComponent({
                                elementId: 'jupyter-component',
                                autoInit: true
                            });

                            // ì´ˆê¸°í™”
                            componentSystem.components.jupyter.init();
                            console.log('Jupyter ì»´í¬ë„ŒíŠ¸ê°€ ì¬ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        } else {
                            console.error('JupyterComponent í´ë˜ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        console.error('ComponentSystemì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                };

            })();
        </script>

        <!-- ğŸ”¥ ìƒˆë¡œ ì¶”ê°€: ë””ë²„ê¹…ìš© ì½˜ì†” ëª…ë ¹ì–´ë“¤ -->
        <script>
            // ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë””ë²„ê¹… ëª…ë ¹ì–´ë“¤

            // 1. ì „ì²´ ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
            window.debugComponentSystem = function () {
                const cs = window.ComponentSystem;
                if (cs) {
                    console.log('ğŸ” ComponentSystem ì „ì²´ ìƒíƒœ:', {
                        initialized: cs.state.initialized,
                        pageType: cs.state.pageType,
                        currentLayoutType: cs.state.currentLayoutType,
                        activeComponents: cs.state.activeComponents,
                        dataLoaded: cs.state.dataLoaded,
                        components: Object.keys(cs.components).map(key => ({
                            name: key,
                            exists: !!cs.components[key],
                            initialized: cs.components[key]?.initialized || cs.components[key]?.state?.initialized,
                            active: cs.components[key]?.active || cs.components[key]?.state?.active
                        }))
                    });
                } else {
                    console.error('ComponentSystemì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            };

            // 2. íŠ¹ì • ì»´í¬ë„ŒíŠ¸ ìƒíƒœ í™•ì¸
            window.debugComponent = function (componentName) {
                const component = window.ComponentSystem?.components?.[componentName];
                if (component) {
                    console.log(`ğŸ” ${componentName} ì»´í¬ë„ŒíŠ¸ ìƒíƒœ:`, {
                        exists: true,
                        initialized: component.initialized || component.state?.initialized,
                        active: component.active || component.state?.active,
                        visible: component.visible || component.state?.visible,
                        element: !!component.element || !!component.elements?.container,
                        state: component.state,
                        elements: component.elements ? Object.keys(component.elements) : 'N/A'
                    });
                } else {
                    console.error(`${componentName} ì»´í¬ë„ŒíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                }
            };

            // 3. ë ˆì´ì•„ì›ƒ ê°•ì œ ë³€ê²½
            window.forceLayout = function (layoutType) {
                if (window.ComponentSystem && window.ComponentSystem.applyLayout) {
                    window.ComponentSystem.applyLayout(layoutType);
                    console.log(`ë ˆì´ì•„ì›ƒ ê°•ì œ ë³€ê²½: ${layoutType}`);
                } else {
                    console.error('ComponentSystem.applyLayoutì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            };

            // 4. ì´ë²¤íŠ¸ ë²„ìŠ¤ ìƒíƒœ í™•ì¸
            window.debugEventBus = function () {
                if (window.EventBus) {
                    console.log('ğŸ” EventBus ìƒíƒœ:', {
                        events: Object.keys(window.EventBus.events || {}),
                        eventDetails: Object.entries(window.EventBus.events || {}).map(([event, listeners]) => ({
                            event: event,
                            listenerCount: listeners.length
                        }))
                    });
                } else {
                    console.error('EventBusë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            };

            // 5. ë„ì›€ë§ í‘œì‹œ
            window.debugHelp = function () {
                console.log(`
ğŸ”§ ë””ë²„ê¹… ëª…ë ¹ì–´ ëª©ë¡:

1. debugComponentSystem() - ì „ì²´ ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
2. debugComponent('componentName') - íŠ¹ì • ì»´í¬ë„ŒíŠ¸ ìƒíƒœ í™•ì¸
   ì˜ˆ: debugComponent('jupyter'), debugComponent('ide')
3. forceLayout('layoutType') - ë ˆì´ì•„ì›ƒ ê°•ì œ ë³€ê²½
   ì˜ˆ: forceLayout('jupyter'), forceLayout('ide')
4. debugEventBus() - ì´ë²¤íŠ¸ ë²„ìŠ¤ ìƒíƒœ í™•ì¸
5. checkJupyter() - Jupyter ì»´í¬ë„ŒíŠ¸ ìƒíƒœ í™•ì¸
6. fixJupyterComponent() - Jupyter ì»´í¬ë„ŒíŠ¸ ìˆ˜ë™ ë³µêµ¬
7. recreateJupyter() - Jupyter ì»´í¬ë„ŒíŠ¸ ì™„ì „ ì¬ìƒì„±
8. debugHelp() - ì´ ë„ì›€ë§ í‘œì‹œ

ğŸ’¡ ì‚¬ìš© ì˜ˆì‹œ:
- debugComponent('jupyter')  // Jupyter ì»´í¬ë„ŒíŠ¸ ìƒíƒœ í™•ì¸
- fixJupyterComponent()      // Jupyter ë¬¸ì œ í•´ê²°
- forceLayout('jupyter')     // Jupyter ë ˆì´ì•„ì›ƒìœ¼ë¡œ ê°•ì œ ì „í™˜
`);
            };

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ë””ë²„ê¹… ë„êµ¬ ì‚¬ìš© ê°€ëŠ¥ ì•Œë¦¼
            window.addEventListener('load', function () {
                setTimeout(() => {
                    console.log('%cğŸ”§ ë””ë²„ê¹… ë„êµ¬ ì‚¬ìš© ê°€ëŠ¥!', 'color: #4CAF50; font-weight: bold; font-size: 14px;');
                    console.log('%cì½˜ì†”ì—ì„œ debugHelp() ë¥¼ ì…ë ¥í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'color: #2196F3;');
                }, 2000);
            });
        </script>
        </script>
    </body>

</html>