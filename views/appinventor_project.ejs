<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•±ì¸ë²¤í„° í”„ë¡œì íŠ¸ ì„ íƒ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.5.0/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/card_project.css">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="/learning-tracker.js"></script>

    <!-- í”„ë¡œì íŠ¸ íƒ€ì… ì§€ì • -->
    <script>
        const projectType = 'appinventor';
    </script>

</head>

<body>
    <%- include('partials/header') %>
        <input type="hidden" id="user-role" value="<%= role %>">
        <input type="hidden" id="user-id" value="<%= userID %>">
        <input type="hidden" id="center-id" value="<%= centerID %>">

        <div class="container-fluid mt-5" style="max-width: 1700px;">
            <!-- ì¹´í…Œê³ ë¦¬ íƒ­ + ìƒˆë¡œ ì‹œì‘í•˜ê¸° ë²„íŠ¼ toolbar -->
            <div class="text-center mb-4">
                <h1 class="fw-bold">ì•±ì¸ë²¤í„° í”„ë¡œì íŠ¸</h1>
                <p class="text-muted">ë¸”ë¡ ì½”ë”©ì„ í†µí•´ ë‚˜ë§Œì˜ ëª¨ë°”ì¼ ì•±ì„ ë§Œë“¤ê³  ê³µìœ í•´ë³´ì„¸ìš”!</p>

                <!-- ğŸ”¥ ë²„íŠ¼ ë° íƒ­ í†µí•© ê·¸ë£¹ -->
                <div
                    class="d-inline-flex justify-content-center align-items-center gap-2 mt-3 p-2 bg-light rounded-pill border shadow-sm">
                    <!-- ê³ ì • ë²„íŠ¼ (ì™¼ìª½) -->
                    <div class="d-flex align-items-center">
                        <a href="https://appinventor.mit.edu/" target="_blank"
                            class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm">
                            <i class="bi bi-plus-lg"></i> ìƒˆë¡œ ì‹œì‘í•˜ê¸°
                        </a>
                        <div class="vr mx-3 text-secondary" style="height: 1.5rem; opacity: 0.2;"></div>
                    </div>

                    <!-- ë™ì  íƒ­ (ì˜¤ë¥¸ìª½) -->
                    <ul class="nav nav-pills" id="categoryTabs" role="tablist" style="border: none;"></ul>
                </div>
            </div>

            <!-- ì½˜í…ì¸  ì»¨í…Œì´ë„ˆ -->
            <div id="content-container" class="tab-content mt-3"></div>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/header.js"></script>

        <!-- card_project.js ë¡œë“œ -->
        <script src="/js/card_project.js"></script>

        <!-- ì•±ì¸ë²¤í„° ì „ìš© í™•ì¥ ìŠ¤í¬ë¦½íŠ¸ -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // ProjectCardManager í´ë˜ìŠ¤ê°€ ë¡œë“œëœ í›„ì— ì‹¤í–‰
                if (typeof ProjectCardManager === 'function') {
                    // ì•±ì¸ë²¤í„°ìš© ì¹´ë“œ ë§¤ë‹ˆì € í™•ì¥ í´ë˜ìŠ¤
                    class AppInventorCardManager extends ProjectCardManager {
                        constructor(config) {
                            // ê¸°ë³¸ ì„¤ì •ì— ì•±ì¸ë²¤í„° API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
                            const updatedConfig = {
                                ...config,
                                apiEndpoints: {
                                    ...config.apiEndpoints,
                                    appinventor: '/api/sheets/aia'
                                }
                            };
                            super(updatedConfig);
                        }

                        // API ì—”ë“œí¬ì¸íŠ¸ ì˜¤ë²„ë¼ì´ë“œ
                        async loadProjectData() {
                            try {
                                // ì§ì ‘ ì•±ì¸ë²¤í„° ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
                                const endpoint = this.config.apiEndpoints.appinventor;

                                console.log(`ë¡œë”© ì•±ì¸ë²¤í„° í”„ë¡œì íŠ¸: ${endpoint}`);
                                const response = await fetch(endpoint);

                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }

                                const data = await response.json();
                                console.log(`ì•±ì¸ë²¤í„° ë°ì´í„° ë¡œë“œ ì„±ê³µ:`, data.length, 'í•­ëª©');
                                return data;
                            } catch (error) {
                                console.error('ì•±ì¸ë²¤í„° ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                                throw error;
                            }
                        }

                        // ì•±ì¸ë²¤í„°ìš© í”„ë¡œì íŠ¸ ê·¸ë£¹í™” ë©”ì„œë“œ
                        groupByProject(data) {
                            const projects = {};

                            data.forEach(row => {
                                if (!Array.isArray(row) || row.length < 4) return;

                                // ì•±ì¸ë²¤í„° ë°ì´í„° êµ¬ì¡°: [ì¹´í…Œê³ ë¦¬, ì½˜í…ì¸ ëª…, ê¸°ëŠ¥, aiaURL, C.Tìš”ì†Œ, IMG]
                                const [category, name, type, url, ctElement = '', imgUrl = ''] = row;

                                if (!projects[category]) {
                                    projects[category] = {};
                                }

                                const projectKey = name.trim();

                                if (!projects[category][projectKey]) {
                                    projects[category][projectKey] = {
                                        name: projectKey,
                                        ctElement: ctElement,
                                        basic: '',  // ë³¸ë¬¸
                                        practice: '', // ì—°ìŠµ
                                        ppt: ''     // PPT ì¶”ê°€
                                    };
                                }

                                // íƒ€ì…ì— ë”°ë¼ URL í• ë‹¹ (ë³¸ë¬¸/ì—°ìŠµ/PPT)
                                if (type.toLowerCase().includes('ë³¸ë¬¸')) {
                                    projects[category][projectKey].basic = url;
                                } else if (type.toLowerCase().includes('ì—°ìŠµ')) {
                                    projects[category][projectKey].practice = url;
                                } else if (type.toLowerCase().includes('ppt')) {
                                    projects[category][projectKey].ppt = url;
                                }
                            });

                            return projects;
                        }

                        // í”„ë¡œì íŠ¸ ì¹´ë“œ ìƒì„± ì˜¤ë²„ë¼ì´ë“œ
                        createProjectCard(projectName, project) {
                            const card = document.createElement('div');
                            card.className = 'project-card';

                            card.innerHTML = `
                            <div class="project-card-header">
                                <h3 class="project-card-title">${projectName}</h3>
                            </div>
                            
                            ${this.viewConfig.showPPTButton && project.ppt ? `
                                <button class="project-ppt-btn" 
                                    onclick="window.open('${project.ppt}', '_blank'); event.stopPropagation();">
                                    PPT
                                </button>
                            ` : ''}
                            
                            <div class="project-card-tags">
                                <span class="project-card-tag">
                                    <i class="bi bi-cpu"></i> ${project.ctElement || 'ì •ë³´ ì—†ìŒ'}
                                </span>
                            </div>
                            
                            <div class="project-card-actions">
                                <div class="project-card-btn-group">
                                    ${project.basic ? this.createProjectButton('ë³¸ë¬¸', project.basic, 'btn-secondary') : ''}
                                    ${project.practice ? this.createProjectButton('ì—°ìŠµ', project.practice, 'btn-secondary') : ''}
                                </div>
                            </div>
                        `;

                            return card;
                        }

                        // ì•±ì¸ë²¤í„° ë¡œë“œ ë©”ì„œë“œ
                        loadProjectInAppInventor(projectUrl) {
                            if (!projectUrl) {
                                console.error('í”„ë¡œì íŠ¸ URLì´ ì—†ìŠµë‹ˆë‹¤');
                                return;
                            }

                            // í”„ë¡œì íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                            const fileName = projectUrl.split('/').pop();
                            const downloadLink = document.createElement('a');
                            downloadLink.href = projectUrl;
                            downloadLink.download = fileName;
                            downloadLink.style.display = 'none';
                            document.body.appendChild(downloadLink);

                            // ìƒˆ ì°½ì—ì„œ ì•±ì¸ë²¤í„° ì—´ê¸°
                            window.open('https://appinventor.mit.edu/', '_blank');

                            // ì•½ê°„ì˜ ì§€ì—° í›„ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
                            setTimeout(() => {
                                downloadLink.click();
                                document.body.removeChild(downloadLink);

                                // ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                                alert(`ì•±ì¸ë²¤í„° í”„ë¡œì íŠ¸ íŒŒì¼(${fileName})ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\nì•±ì¸ë²¤í„°ì—ì„œ 'í”„ë¡œì íŠ¸ ê°€ì ¸ì˜¤ê¸°' ë©”ë‰´ë¥¼ ì„ íƒí•˜ê³  ì´ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.`);
                            }, 500);
                        }

                        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ì„¤ì •
                        setupEventListeners() {
                            document.addEventListener('click', (e) => {
                                if (e.target.classList.contains('load-project')) {
                                    e.preventDefault();
                                    e.stopPropagation();

                                    const projectUrl = e.target.getAttribute('data-url');
                                    if (!projectUrl) return;

                                    this.loadProjectInAppInventor(projectUrl);
                                }
                            });
                        }
                    }

                    // ê¸°ì¡´ ì¹´ë“œ ë§¤ë‹ˆì €ë¥¼ ì œê±°í•˜ê³  ìƒˆ ì•±ì¸ë²¤í„° ë§¤ë‹ˆì € ìƒì„±
                    if (window.projectCardManager) {
                        delete window.projectCardManager;
                    }

                    // ì•±ì¸ë²¤í„° ë§¤ë‹ˆì € ìƒì„± ë° ì´ˆê¸°í™”
                    window.projectCardManager = new AppInventorCardManager({
                        projectType: 'appinventor',
                        contentContainerId: 'content-container',
                        categoryTabsId: 'categoryTabs'
                    });

                    // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                    window.projectCardManager.initialize();
                    window.projectCardManager.setupEventListeners();
                } else {
                    console.error('ProjectCardManager í´ë˜ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. card_project.jsê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
                }
            });


        </script>
</body>

</html>