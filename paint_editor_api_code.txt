// ğŸ¨ Paint Editor API - Entry ìº”ë²„ìŠ¤ ì´ë¯¸ì§€ ì €ì¥
// ì´ ì½”ë“œë¥¼ apiRouter.jsì˜ module.exports = router; ë°”ë¡œ ìœ„ì— ì¶”ê°€í•˜ì„¸ìš”

const { S3Client, PutObjectCommand } = require('@aws-sdk/client-s3');

// Paint ì „ìš© Multer ì„¤ì •
const paintUpload = multer({ 
  storage: multer.memoryStorage(),
  limits: { fileSize: 10 * 1024 * 1024 }, // 10MB
  fileFilter: (req, file, cb) => {
    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'];
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'), false);
    }
  }
});

router.post('/picture/paint', authenticateUser, paintUpload.single('image'), async (req, res) => {
  console.log('ğŸ¨ Paint Editor ì €ì¥ ìš”ì²­ ë°›ìŒ');
  
  try {
    if (!req.file) {
      return res.status(400).json({ 
        success: false, 
        error: 'ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.' 
      });
    }

    console.log('ğŸ“· ì—…ë¡œë“œëœ ì´ë¯¸ì§€:', {
      originalname: req.file.originalname,
      mimetype: req.file.mimetype,
      size: req.file.size
    });

    // S3 í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    const s3Client = new S3Client({
      region: process.env.AWS_REGION || 'ap-northeast-2',
      credentials: {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID,
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY
      }
    });

    // íŒŒì¼ëª… ìƒì„±
    const timestamp = Date.now();
    const userId = req.session?.userID || 'anonymous';
    const ext = req.file.mimetype.split('/')[1]; // png, jpeg ë“±
    const filename = `paint_${userId}_${timestamp}.${ext}`;
    const s3Key = `ent/uploads/images/${filename}`;

    // S3 ì—…ë¡œë“œ
    const uploadParams = {
      Bucket: process.env.S3_BUCKET_NAME || 'educodingnplaycontents',
      Key: s3Key,
      Body: req.file.buffer,
      ContentType: req.file.mimetype,
      CacheControl: 'public, max-age=31536000'
    };

    await s3Client.send(new PutObjectCommand(uploadParams));
    console.log('âœ… S3 ì—…ë¡œë“œ ì„±ê³µ:', s3Key);

    // Entry.jsê°€ ê¸°ëŒ€í•˜ëŠ” ì‘ë‹µ í˜•ì‹
    const fileUrl = `https://educodingnplaycontents.s3.ap-northeast-2.amazonaws.com/${s3Key}`;
    
    res.json({
      success: true,
      data: {
        _id: `paint_${timestamp}`,
        filename: filename,
        imageType: ext,
        dimension: { 
          width: 100,  // ì‹¤ì œ í¬ê¸°ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê³„ì‚°
          height: 100 
        },
        fileurl: fileUrl,
        label: { 
          ko: 'ìƒˆ ê·¸ë¦¼', 
          en: 'New Picture' 
        },
        name: 'ìƒˆ ê·¸ë¦¼'
      }
    });

  } catch (error) {
    console.error('âŒ Paint Editor ì €ì¥ ì‹¤íŒ¨:', error);
    res.status(500).json({ 
      success: false, 
      error: error.message 
    });
  }
});
