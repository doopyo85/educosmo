# 갤러리 수정 완료 - 확인 방법

## ✅ 수정 완료 사항

### 핵심 수정
1. **is_active 컬럼 명시적 설정** - 갤러리 등록 시 `is_active = 1` 자동 설정
2. **SQL Parameter 에러 수정** - userDbId undefined 체크 추가
3. **필드명 호환성 개선** - camelCase/snake_case 모두 지원
4. **안전한 EJS 변수 접근** - undefined 체크 추가
5. **상세 디버깅 로그** - 자동 등록 과정 전체 로깅

---

## 🚀 즉시 실행할 것

### 1단계: 서버 재시작 (필수!)
```bash
pm2 restart server
```

수정된 코드를 반영하려면 **반드시 재시작 필요**

---

### 2단계: 데이터베이스 확인

#### MySQL 접속 후 실행:
```sql
-- 사용자 ID를 test85에서 실제 사용자 ID로 변경
SET @target_userID = 'test85';

-- 1. 사용자 존재 확인
SELECT id, userID, name FROM Users WHERE userID = @target_userID;

-- 2. 제출 기록 확인
SELECT id, project_name, save_type, platform, created_at
FROM ProjectSubmissions
WHERE user_id = (SELECT id FROM Users WHERE userID = @target_userID)
ORDER BY created_at DESC LIMIT 5;

-- 3. 갤러리 등록 확인
SELECT id, title, platform, is_active, visibility, project_submission_id, created_at
FROM gallery_projects
WHERE user_id = (SELECT id FROM Users WHERE userID = @target_userID)
ORDER BY created_at DESC LIMIT 5;

-- 4. 연결 상태 확인 (가장 중요!)
SELECT
    ps.id as submission_id,
    ps.project_name,
    ps.save_type,
    gp.id as gallery_id,
    gp.is_active,
    CASE
        WHEN gp.id IS NULL THEN '❌ 갤러리 미등록'
        WHEN gp.is_active = 0 THEN '⚠️ 비활성화됨'
        ELSE '✅ 정상'
    END as status
FROM ProjectSubmissions ps
LEFT JOIN gallery_projects gp ON ps.id = gp.project_submission_id
WHERE ps.user_id = (SELECT id FROM Users WHERE userID = @target_userID)
  AND ps.save_type = 'submitted'
ORDER BY ps.created_at DESC LIMIT 5;
```

---

### 3단계: 결과 분석

#### 시나리오 A: 갤러리에 데이터 있음 (정상)
```
gallery_id | is_active | status
789        | 1         | ✅ 정상
```
→ **조치**: 브라우저에서 `/my-universe/gallery` 접속해서 확인
→ 만약 여전히 안 보이면 브라우저 캐시 삭제 (Ctrl+Shift+R)

---

#### 시나리오 B: 갤러리에 데이터 없음
```
gallery_id | is_active | status
NULL       | NULL      | ❌ 갤러리 미등록
```

**원인**: 자동 등록 실패

**해결 1 - 수동 등록 (즉시 해결)**:
```sql
-- submitted인데 갤러리에 없는 항목 자동 등록
INSERT INTO gallery_projects (
    user_id, title, description, platform, s3_url, thumbnail_url, embed_url,
    visibility, is_active, tags, metadata, project_submission_id, created_at, updated_at
)
SELECT
    ps.user_id,
    ps.project_name as title,
    CONCAT(
        CASE ps.platform
            WHEN 'entry' THEN '엔트리'
            WHEN 'scratch' THEN '스크래치'
            WHEN 'python' THEN '파이썬'
        END,
        '로 만든 작품입니다.'
    ) as description,
    ps.platform,
    ps.s3_url,
    ps.thumbnail_url,
    CONCAT(
        CASE ps.platform
            WHEN 'entry' THEN '/entry_editor/?s3Url='
            WHEN 'scratch' THEN '/scratch/?project_file='
            WHEN 'python' THEN '/python-viewer/?file='
        END,
        REPLACE(ps.s3_url, '&', '%26'),
        CASE ps.platform
            WHEN 'entry' THEN '&mode=play&embed=1'
            WHEN 'scratch' THEN '&mode=player&embed=1'
            WHEN 'python' THEN '&embed=1'
        END
    ) as embed_url,
    'private' as visibility,
    1 as is_active,
    '[]' as tags,
    '{}' as metadata,
    ps.id as project_submission_id,
    NOW() as created_at,
    NOW() as updated_at
FROM ProjectSubmissions ps
WHERE ps.save_type = 'submitted'
  AND NOT EXISTS (
      SELECT 1 FROM gallery_projects gp WHERE gp.project_submission_id = ps.id
  );
```

**해결 2 - 서버 로그 확인 (근본 원인 파악)**:
```bash
pm2 logs server | grep "갤러리 자동 등록"
```

예상 로그:
- ✅ `✨ [Entry] 갤러리 자동 등록 완료` → 정상
- ⏭️ `⏭️ [Entry] 갤러리 자동 등록 조건 미충족` → saveType 또는 projectSubmissionId 문제
- ❌ `❌ [Gallery Auto-Register] 실패` → DB 에러

---

#### 시나리오 C: is_active = 0
```
gallery_id | is_active | status
789        | 0         | ⚠️ 비활성화됨
```

**원인**: 이전 코드로 INSERT되어 is_active가 0으로 설정됨

**해결**:
```sql
UPDATE gallery_projects
SET is_active = 1
WHERE is_active = 0 OR is_active IS NULL;
```

---

### 4단계: 테스트

#### 4-1. 새로운 Entry 프로젝트 제출
1. Entry 에디터 접속
2. 간단한 프로젝트 작성
3. **"제출하기" 버튼 클릭** (저장 아님!)
4. 서버 콘솔에서 로그 확인:
```bash
pm2 logs server --lines 20 | grep "갤러리"
```

예상 로그:
```
🔍 [Entry] 갤러리 자동 등록 체크: { actualSaveType: 'submitted', hasProjectSubmissionId: true, ... }
📤 [Entry] 갤러리 자동 등록 시작: { userId: 123, userID: 'test85', ... }
✅ [Gallery Auto-Register] 완료: Gallery# 101
✨ [Entry] 갤러리 자동 등록 완료: Gallery# 101
```

#### 4-2. 갤러리 페이지 확인
1. `/my-universe/gallery` 접속
2. 제출한 프로젝트가 카드 형태로 표시되는지 확인
3. 통계 숫자가 0이 아닌지 확인
4. 카드 클릭 시 모달에서 프로젝트 재생 확인

---

## 🔧 문제 해결

### 문제 1: "사용자를 찾을 수 없습니다" (404 에러)
**원인**: `getUserDbId()` undefined 반환

**해결**:
1. 로그아웃 후 다시 로그인
2. 세션 확인:
```sql
SELECT id, userID FROM Users WHERE userID = 'test85';
```
결과 없으면 → userID가 잘못됨

---

### 문제 2: 여전히 갤러리가 비어있음
**원인**: 브라우저 캐시

**해결**:
1. 브라우저 강력 새로고침: `Ctrl + Shift + R`
2. 개발자 도구 > Network 탭에서 `/api/gallery/my` 응답 확인
3. `data` 배열이 비어있으면 → DB 확인 (2단계로 돌아가기)

---

### 문제 3: Scratch 프로젝트가 갤러리에 안 보임
**원인**: Scratch는 "제출" 버튼이 없어서 `saveType = 'projects'`

**임시 해결**:
```sql
-- Scratch 프로젝트 수동 등록
INSERT INTO gallery_projects (
    user_id, title, description, platform, s3_url, thumbnail_url, embed_url,
    visibility, is_active, tags, metadata, project_submission_id, created_at, updated_at
)
SELECT
    ps.user_id,
    ps.project_name as title,
    '스크래치로 만든 작품입니다.' as description,
    'scratch' as platform,
    ps.s3_url,
    ps.thumbnail_url,
    CONCAT('/scratch/?project_file=', REPLACE(ps.s3_url, '&', '%26'), '&mode=player&embed=1') as embed_url,
    'private' as visibility,
    1 as is_active,
    '[]' as tags,
    '{}' as metadata,
    ps.id as project_submission_id,
    NOW() as created_at,
    NOW() as updated_at
FROM ProjectSubmissions ps
WHERE ps.platform = 'scratch'
  AND ps.save_type = 'projects'  -- submitted가 아니어도 등록
  AND NOT EXISTS (
      SELECT 1 FROM gallery_projects gp WHERE gp.project_submission_id = ps.id
  );
```

**장기 해결**: Scratch에도 "제출" 버튼 추가 또는 "저장"도 자동 등록하도록 수정 필요

---

## 📊 상태 확인 한눈에 보기

```sql
-- 통합 진단 쿼리 (복사해서 실행)
SET @target_userID = 'test85';

SELECT
    (SELECT COUNT(*) FROM ProjectSubmissions WHERE user_id = (SELECT id FROM Users WHERE userID = @target_userID)) as '총_제출수',
    (SELECT COUNT(*) FROM ProjectSubmissions WHERE user_id = (SELECT id FROM Users WHERE userID = @target_userID) AND save_type = 'submitted') as 'submitted_수',
    (SELECT COUNT(*) FROM gallery_projects WHERE user_id = (SELECT id FROM Users WHERE userID = @target_userID)) as '갤러리_등록수',
    (SELECT COUNT(*) FROM gallery_projects WHERE user_id = (SELECT id FROM Users WHERE userID = @target_userID) AND is_active = 1) as '활성_갤러리',
    CASE
        WHEN (SELECT COUNT(*) FROM gallery_projects WHERE user_id = (SELECT id FROM Users WHERE userID = @target_userID) AND is_active = 1) > 0
        THEN '✅ 정상'
        WHEN (SELECT COUNT(*) FROM ProjectSubmissions WHERE user_id = (SELECT id FROM Users WHERE userID = @target_userID) AND save_type = 'submitted') = 0
        THEN '⚠️ 제출 기록 없음'
        ELSE '❌ 자동 등록 실패'
    END as '상태';
```

---

## 📁 추가 자료

상세한 문제 해결이 필요하면 다음 파일 참고:

1. **GALLERY_FINAL_STATUS.md** - 전체 수정 내역 및 상태
2. **GALLERY_TROUBLESHOOTING.md** - 상세 문제 해결 가이드
3. **GALLERY_DIAGNOSTIC.sql** - 전체 진단 SQL 스크립트

---

## 📞 도움 요청 시 제공할 정보

문제가 해결 안 되면 다음 정보 수집:

1. **서버 로그**:
```bash
pm2 logs server --lines 50 > server_logs.txt
```

2. **DB 진단 결과**:
```sql
-- 위의 "연결 상태 확인" 쿼리 실행 결과
```

3. **브라우저 콘솔**:
- 개발자 도구 > Console 탭의 에러 메시지
- Network 탭의 `/api/gallery/my` 응답 내용

---

**작성일**: 2026-01-09
**긴급도**: ⚠️ 높음
**예상 해결 시간**: 5-10분
